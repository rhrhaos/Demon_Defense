<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë§ˆì™• ë””íœìŠ¤ v8.3 â€” ì˜¤í† ì²´ìŠ¤ + ì—ë””í„°</title>
<style>
  :root{--bg:#0f1420;--panel:#0b1220;--ink:#e8eefc;--muted:#a7b0c0;--line:#334155;--blue:#2563eb;--green:#22c55e;--red:#ef4444;--amber:#f59e0b;--purple:#a855f7;--gold:#fbbf24}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  #app{max-width:1700px;margin:0 auto;padding:12px}
  .top{display:flex;gap:10px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
  .title{font-weight:900;font-size:18px}.sub{color:var(--muted);font-size:13px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab{cursor:pointer;border:1px solid var(--line);background:var(--panel);color:var(--ink);border-radius:999px;padding:8px 12px;font-size:13px;transition:.15s}
  .tab.active{border-color:var(--blue);box-shadow:0 0 0 2px rgba(37,99,235,.35) inset}
  .tab:hover{filter:brightness(1.12)}
  .panel{background:rgba(0,0,0,.24);border:1px solid var(--line);border-radius:14px;padding:12px}
  .h{font-weight:900;font-size:14px;margin:0 0 8px 0}.muted{color:var(--muted);font-size:12px}
  .btn{cursor:pointer;border:1px solid var(--line);background:var(--panel);color:var(--ink);border-radius:10px;padding:8px 10px;font-size:13px;transition:.15s}
  .btn:hover{filter:brightness(1.08)}.btn.primary{border-color:var(--blue)}.btn.good{border-color:var(--green)}.btn.danger{border-color:#b91c1c}.btn.small{padding:6px 8px;font-size:12px;border-radius:9px}
  .btn.gold{border-color:var(--gold);color:var(--gold)}.btn:disabled{opacity:.4;cursor:default}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.col{display:flex;flex-direction:column;gap:8px}
  .hr{height:1px;background:var(--line);opacity:.6;margin:10px 0}
  .pill{background:rgba(0,0,0,.35);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;white-space:nowrap}
  .kpi{display:flex;gap:8px;flex-wrap:wrap}
  canvas{width:100%;max-width:1150px;height:auto;aspect-ratio:4/3;background:#111827;border:1px solid var(--line);border-radius:12px;image-rendering:pixelated;display:block}
  .grid2{display:grid;grid-template-columns:380px 1fr;gap:10px;align-items:start}
  .grid3{display:grid;grid-template-columns:380px 1fr 320px;gap:10px;align-items:start}
  @media(max-width:1100px){.grid2,.grid3{grid-template-columns:1fr}}

  /* EDITOR TOOLS */
  .toolGrid{display:flex;gap:4px;flex-wrap:wrap;margin-top:8px}
  .toolBtn{cursor:pointer;border:2px solid var(--line);background:rgba(0,0,0,.3);border-radius:10px;padding:6px 10px;font-size:12px;user-select:none;transition:.15s;min-width:42px;text-align:center}
  .toolBtn:hover{filter:brightness(1.15)}
  .toolBtn.active{border-color:var(--gold);box-shadow:0 0 8px rgba(251,191,36,.25)}

  /* SHOP */
  .shopGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
  .shopCard{cursor:pointer;border:2px solid var(--line);background:rgba(0,0,0,.3);border-radius:12px;padding:10px;text-align:center;user-select:none;transition:.15s;position:relative}
  .shopCard:hover{filter:brightness(1.12);transform:translateY(-2px)}
  .shopCard.selected{border-color:var(--gold);box-shadow:0 0 12px rgba(251,191,36,.3)}
  .shopCard.sold{opacity:.3;pointer-events:none}
  .shopCard .scIcon{font-size:24px;margin-bottom:4px}
  .shopCard .scName{font-weight:800;font-size:12px}
  .shopCard .scDesc{color:var(--muted);font-size:11px;margin-top:2px}
  .shopCard .scCost{color:var(--gold);font-weight:900;font-size:13px;margin-top:4px}
  .shopCard .scTier{position:absolute;top:4px;right:6px;font-size:10px;color:var(--muted)}

  /* BENCH / INVENTORY */
  .bench{display:flex;gap:6px;flex-wrap:wrap;min-height:48px;padding:8px;background:rgba(0,0,0,.2);border:1px dashed var(--line);border-radius:12px;margin-top:8px}
  .benchItem{cursor:grab;border:2px solid var(--line);background:rgba(0,0,0,.35);border-radius:10px;padding:6px 10px;text-align:center;user-select:none;min-width:56px;transition:.15s}
  .benchItem:hover{border-color:var(--blue)}
  .benchItem.selected{border-color:var(--gold);box-shadow:0 0 8px rgba(251,191,36,.25)}
  .benchItem .biIcon{font-size:18px}
  .benchItem .biName{font-size:10px;font-weight:700}
  .benchItem .biCount{font-size:10px;color:var(--amber)}

  /* MERGE POPUP */
  .mergePopup{display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,.7);align-items:center;justify-content:center;padding:14px}
  .mergeModal{max-width:600px;width:100%;background:rgba(17,24,39,.98);border:1px solid var(--line);border-radius:18px;padding:20px}
  .mergeChoices{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .mergeChoice{cursor:pointer;border:2px solid var(--line);background:rgba(0,0,0,.25);border-radius:14px;padding:14px;text-align:center;transition:.15s}
  .mergeChoice:hover{border-color:var(--blue)}
  .mergeChoice.active{border-color:var(--gold);box-shadow:0 0 12px rgba(251,191,36,.3)}
  .mergeChoice .mcIcon{font-size:28px}
  .mergeChoice .mcName{font-weight:900;font-size:14px;margin-top:4px}
  .mergeChoice .mcDesc{color:var(--muted);font-size:12px;margin-top:4px}

  /* SYNERGY */
  .synergyBar{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .synBadge{border:1px solid var(--line);background:rgba(0,0,0,.3);border-radius:10px;padding:5px 9px;font-size:11px;display:flex;align-items:center;gap:4px}
  .synBadge.active{border-color:var(--green);background:rgba(34,197,94,.12);color:var(--green)}
  .synBadge .synIcon{font-size:14px}
  .synBadge .synCount{font-weight:900}

  /* RESULT OVERLAY */
  .resultOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72);z-index:9999;padding:14px}
  .resultModal{max-width:860px;width:100%;background:rgba(17,24,39,.98);border:1px solid var(--line);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.55);padding:20px}
  .resultHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
  .resultHeader h3{margin:0;font-size:20px;font-weight:900}
  .resultChoices{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
  @media(max-width:900px){.resultChoices{grid-template-columns:1fr}}
  .resultChoice{cursor:pointer;border:1px solid var(--line);background:rgba(0,0,0,.25);border-radius:14px;padding:12px;user-select:none;transition:.15s}
  .resultChoice:hover{filter:brightness(1.08)}
  .resultChoice.active{border-color:var(--blue);box-shadow:0 0 0 2px rgba(37,99,235,.35) inset}
  .resultChoice .t{font-weight:900}.resultChoice .d{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35}
  .resultChoice .badge{font-size:10px;padding:1px 6px;border-radius:8px;border:1px solid currentColor}
  .resultFooter{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}
  .resultKpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

  /* BATTLE HUD */
  .bar{height:8px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;border:1px solid rgba(255,255,255,.12)}
  .bar>div{height:100%;width:0%;background:rgba(37,99,235,.95)}
  .barEnergy>div{background:rgba(34,197,94,.95)}
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:12px;padding:10px;cursor:pointer;user-select:none}
  .card.active{border-color:var(--blue);box-shadow:0 0 0 2px rgba(37,99,235,.35) inset}
  .cardTop{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .badge{font-size:11px;opacity:.85;border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:rgba(0,0,0,.25)}
  .log{background:rgba(0,0,0,.35);border:1px solid var(--line);border-radius:12px;padding:10px;font-size:12px;max-height:150px;overflow-y:auto}
  .logLine{color:var(--muted);line-height:1.45}.logLine b{color:var(--ink)}
  .hint{font-size:12px;color:rgba(255,255,255,.85);background:rgba(37,99,235,.2);border:1px solid rgba(37,99,235,.45);padding:8px 10px;border-radius:12px}

  .field{display:flex;flex-direction:column;gap:4px}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{background:var(--panel);border:1px solid var(--line);border-radius:10px;color:var(--ink);padding:8px 10px;font-size:13px}
  pre{white-space:pre;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:12px;max-height:180px}

  .heroSelect{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .heroChip{cursor:pointer;border:2px solid var(--line);background:var(--panel);border-radius:12px;padding:8px 14px;font-size:13px;user-select:none;opacity:.5;transition:.15s}
  .heroChip.on{opacity:1;border-color:var(--blue);box-shadow:0 0 0 2px rgba(37,99,235,.35) inset}

  .phaseLabel{font-size:16px;font-weight:900;color:var(--gold);text-align:center;padding:8px;animation:glow 2s ease-in-out infinite}
  @keyframes glow{0%,100%{text-shadow:0 0 8px rgba(251,191,36,.3)}50%{text-shadow:0 0 20px rgba(251,191,36,.6)}}

  .fusionGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-top:8px}
  .fusionCard{cursor:pointer;border:2px solid var(--line);background:rgba(0,0,0,.3);border-radius:12px;padding:10px;text-align:center;transition:.15s}
  .fusionCard:hover{filter:brightness(1.12)}.fusionCard.available{border-color:var(--purple)}
  .fusionCard .fcIcon{font-size:22px}.fusionCard .fcName{font-weight:800;font-size:11px;margin-top:2px}
  .fusionCard .fcRecipe{color:var(--muted);font-size:10px;margin-top:2px}.fusionCard .fcCost{color:var(--gold);font-weight:900;font-size:12px;margin-top:2px}
  .adaptBar{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .adaptBadge{border:1px solid var(--line);background:rgba(0,0,0,.3);border-radius:10px;padding:5px 9px;font-size:11px;display:flex;align-items:center;gap:4px}
  .adaptBadge.top{border-color:var(--amber);background:rgba(245,158,11,.12);color:var(--amber)}
  .helpSection{margin-bottom:16px;padding:12px;background:rgba(0,0,0,.2);border:1px solid var(--line);border-radius:12px}
  .helpSection .hs{font-weight:900;font-size:13px;margin-bottom:6px;color:var(--gold)}
  .helpSection .hd{color:var(--muted);font-size:12px;line-height:1.6}
  .treeRow{display:flex;gap:4px;align-items:center;margin:3px 0;font-size:12px}
  .treeRow .trIcon{font-size:16px;min-width:22px;text-align:center}
  .treeRow .trName{font-weight:700;min-width:80px}.treeRow .trDesc{color:var(--muted)}
</style>
</head>
<body>
<div id="app">
  <div class="top">
    <div>
      <div class="title">ğŸ‘‘ ë§ˆì™• ë””íœìŠ¤ v8.3 â€” ì˜¤í† ì²´ìŠ¤ + ì—ë””í„°</div>
      <div class="sub">ì—ë””í„° Â· ìƒì  Â· ììœ ë°°ì¹˜ Â· 3í•© ì§„í™” Â· ì‹œë„ˆì§€ Â· ìë™ì „íˆ¬</div>
    </div>
    <div class="kpi" id="topKpi"></div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="editor">ğŸ—ºï¸ ì—ë””í„°</button>
    <button class="tab" data-tab="prep">ğŸ›’ ì¤€ë¹„</button>
    <button class="tab" data-tab="battle">âš”ï¸ ì „íˆ¬</button>
    <button class="tab" data-tab="settings">âš™ï¸ ì„¤ì •</button>
    <button class="tab" data-tab="help">â“ ì„¤ëª…</button>
  </div>

  <!-- ==================== EDITOR TAB ==================== -->
  <div id="tab-editor" class="grid2">
    <div class="panel" style="max-height:92vh;overflow-y:auto">
      <div class="h">ğŸ—ºï¸ ë§µ ì—ë””í„°</div>
      <div class="muted">ë§µì„ ë””ìì¸í•œ í›„ 'ê²Œì„ ì‹œì‘'ìœ¼ë¡œ ëŸ°ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
      <div class="hr"></div>

      <!-- Map Size -->
      <div class="row">
        <div class="field" style="flex:1"><label>ê°€ë¡œ</label><input id="edW" type="number" min="8" max="40" value="20"></div>
        <div class="field" style="flex:1"><label>ì„¸ë¡œ</label><input id="edH" type="number" min="8" max="30" value="15"></div>
        <button class="btn small" id="btnEdResize">ë§µ ë¦¬ì‚¬ì´ì¦ˆ</button>
      </div>
      <div class="hr"></div>

      <!-- Tools -->
      <div class="h">ğŸ”§ ë„êµ¬</div>
      <div class="toolGrid" id="edTools"></div>
      <div class="hr"></div>

      <!-- Presets -->
      <div class="h">ğŸ“‹ í”„ë¦¬ì…‹ ë§µ</div>
      <div class="row" id="presetRow"></div>
      <div class="hr"></div>

      <!-- Actions -->
      <div class="row">
        <button class="btn small" onclick="doUndo()">â†© ì–¸ë‘</button>
        <button class="btn small" onclick="doRedo()">â†ª ë¦¬ë‘</button>
        <button class="btn primary" id="btnEdFill">ì „ì²´ ì±„ìš°ê¸°</button>
        <button class="btn danger" id="btnEdClear">ì´ˆê¸°í™”</button>
      </div>
      <div class="hr"></div>

      <button class="btn good" id="btnStartRun" style="width:100%;padding:12px;font-size:16px;font-weight:900">â–¶ï¸ ê²Œì„ ì‹œì‘</button>
      <div class="muted" style="margin-top:4px">ì…êµ¬(E)ì™€ ë§ˆì™•ì„±(C)ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="h">ë§µ ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="muted" id="edInfo"></div>
      </div>
      <canvas id="edCanvas" width="960" height="720"></canvas>
    </div>
  </div>

  <!-- ==================== PREP TAB ==================== -->
  <div id="tab-prep" class="grid2" style="display:none">
    <div class="panel" style="max-height:92vh;overflow-y:auto">
      <div class="phaseLabel" id="phaseLabel">ğŸ›’ ìƒì </div>
      <div class="hr"></div>

      <!-- TOP KPI -->
      <div class="kpi" id="prepKpi"></div>
      <div class="hr"></div>

      <!-- SHOP -->
      <div id="shopSection">
        <div class="row" style="justify-content:space-between">
          <div class="h">ğŸ›’ ìƒì </div>
          <div class="row">
            <button class="btn small gold" id="btnReroll">ğŸ”„ ë¦¬ë¡¤ (<span id="rerollCost">2</span>G)</button>
          </div>
        </div>
        <div class="shopGrid" id="shopGrid"></div>
      </div>
      <div class="hr"></div>

      <!-- SYNERGY -->
      <div>
        <div class="h">ğŸ”— ì‹œë„ˆì§€</div>
        <div class="synergyBar" id="synergyBar"></div>
      </div>
      <div class="hr"></div>

      <!-- BENCH -->
      <div>
        <div class="row" style="justify-content:space-between">
          <div class="h">ğŸ“¦ ë²¤ì¹˜ (ë³´ìœ  ìŠ¤í¬ë„ˆ)</div>
          <button class="btn small danger" id="btnSell">íŒë§¤ (ì„ íƒ ì¹´ë“œ)</button>
        </div>
        <div class="bench" id="bench"></div>
        <div class="muted" style="margin-top:4px">ë²¤ì¹˜ ì¹´ë“œ í´ë¦­ â†’ ë§µì˜ ë¹ˆ ë°”ë‹¥ í´ë¦­ìœ¼ë¡œ ë°°ì¹˜. ë°°ì¹˜+ë²¤ì¹˜ í•©ì‚° 3ê°œ â†’ ì§„í™”!</div>
      </div>
      <div class="hr"></div>

      <!-- FUSION (v8.2) -->
      <div id="fusionSection">
        <div class="h">ğŸ”€ í•©ì„± (v8.2)</div>
        <div class="muted">ì„œë¡œ ë‹¤ë¥¸ ê¸°ë³¸ ìŠ¤í¬ë„ˆ 2ì¢…ì„ í•©ì„±í•˜ì—¬ í•˜ì´ë¸Œë¦¬ë“œë¥¼ ë§Œë“œì„¸ìš”.</div>
        <div class="fusionGrid" id="fusionGrid"></div>
      </div>
      <div class="hr"></div>

      <!-- ADAPT (v8.2) -->
      <div id="adaptSection">
        <div class="h">ğŸ›¡ ì ì‘ ê°•í™” (v8.2)</div>
        <div class="muted">ìš©ì‚¬ ì‚¬ë§ ì›ì¸ì— ë”°ë¼ ìë™ ì €í•­ ë¶€ì—¬</div>
        <div class="adaptBar" id="adaptBar"></div>
      </div>
      <div class="hr"></div>

      <!-- ACTIONS -->
      <div class="row">
        <button class="btn primary" id="btnStartBattle">âš”ï¸ ì „íˆ¬ ì‹œì‘</button>
        <button class="btn danger" id="btnEndRun">ëŸ° ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="h">ğŸ—ºï¸ ë°°ì¹˜ ë§µ (ìŠ¤í…Œì´ì§€ <span id="stageNum">1</span>)</div>
        <div class="muted" id="placeInfo">ë°°ì¹˜: 0</div>
      </div>
      <canvas id="prepCanvas" width="960" height="720"></canvas>
    </div>
  </div>

  <!-- ==================== BATTLE TAB ==================== -->
  <div id="tab-battle" class="grid3" style="display:none">
    <div class="panel" style="max-height:92vh;overflow-y:auto">
      <div class="h">ğŸ® ì „íˆ¬ HUD</div>
      <div class="kpi" id="hud"></div>
      <div class="hr"></div>
      <div class="h">ğŸ§ ìš©ì‚¬ ì¶œê²©</div>
      <div class="heroSelect" id="heroSelect"></div>
      <div class="hr"></div>
      <div class="h">ğŸ§™â€â™‚ï¸ ë§ˆì™• ìŠ¤í‚¬</div>
      <div class="hint">ì¹´ë“œ í´ë¦­ â†’ ìº”ë²„ìŠ¤ í´ë¦­ / ESC ì·¨ì†Œ</div>
      <div class="field"><label>ì—ë„ˆì§€</label><div class="bar barEnergy"><div id="energyBar"></div></div></div>
      <div class="cards" id="villainCards"></div>
      <div class="hr"></div>
      <div class="h">ğŸ¯ ì „ì¥ ì§€íœ˜</div>
      <div class="row" id="directiveRow" style="flex-wrap:wrap;gap:8px">
        <button class="btn small" data-dir="auto">ìë™</button>
        <button class="btn small" data-dir="healer">íëŸ¬ ìš°ì„ </button>
        <button class="btn small" data-dir="ranged">ì›ë”œ ìš°ì„ </button>
        <button class="btn small" data-dir="tank">ì „ì‚¬ ìš°ì„ </button>
        <button class="btn small" data-dir="weak">ë¹ˆì‚¬ ìš°ì„ </button>
      </div>
      <div class="hr"></div>
      <div class="h">ğŸ“Œ ë¡œê·¸</div><div class="log" id="skillLog"></div>
    </div>
    <div class="panel">
      <div class="h">ğŸ—ºï¸ ì „íˆ¬</div>
      <canvas id="playCanvas" width="960" height="720"></canvas>
    </div>
    <div class="panel">
      <div class="h">ğŸ§ª ë””ë²„ê·¸</div>
      <button class="btn small" id="btnDbg">ë””ë²„ê·¸: OFF</button>
      <div class="hr"></div><pre id="debugOut"></pre>
    </div>
  </div>

  <!-- ==================== SETTINGS TAB ==================== -->
  <div id="tab-settings" class="grid2" style="display:none">
    <div class="panel" style="max-height:92vh;overflow-y:auto">
      <div class="h">â±ï¸ ê¸°ë³¸ ì„¤ì •</div>
      <div class="field"><label>ì œí•œì‹œê°„(ì´ˆ)</label><input id="sessionLimit" type="number" min="10" max="9999" value="90"></div>
      <div class="hr"></div>
      <div class="h">ğŸ‘¾ ìŠ¤í¬ë„ˆ/ëª¬ìŠ¤í„°</div>
      <div class="row">
        <div class="field" style="flex:1"><label>ìŠ¤í° ê°„ê²©(ì´ˆ)</label><input id="spawnBase" type="number" min="0.2" max="10" step="0.1" value="1.4"></div>
        <div class="field" style="flex:1"><label>ì—˜ë¦¬íŠ¸ ê°ì§€ë²”ìœ„</label><input id="eliteRange" type="number" min="30" max="600" value="200"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>ëª¬ìŠ¤í„° ì´ì†</label><input id="mobSpeed" type="number" min="10" max="600" value="85"></div>
        <div class="field" style="flex:1"><label>íƒ„ì†</label><input id="bulletSpeed" type="number" min="50" max="1200" value="380"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>ìŠ¤í¬ë„ˆ HP</label><input id="spawnerHP" type="number" min="10" max="9999" value="140"></div>
        <div class="field" style="flex:1"><label>ì—˜ë¦¬íŠ¸ HPë°°ìˆ˜</label><input id="eliteHpMul" type="number" min="1" max="20" step="0.5" value="4"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>ê²¹ì¹¨ë°©ì§€(0~1)</label><input id="separateStrength" type="number" min="0" max="1" step="0.05" value="0.65"></div>
        <div class="field" style="flex:1"><label>ëª¬ìŠ¤í„° ì–´ê·¸ë¡œë²”ìœ„(px)</label><input id="aggroRange" type="number" min="30" max="800" value="220"></div>
      </div>
      <div class="hr"></div>
      <div class="h">ğŸ§™â€â™‚ï¸ ë§ˆì™• ìŠ¤í‚¬</div>
      <div class="row">
        <div class="field" style="flex:1"><label>Meteor DMG</label><input id="vMeteorDmg" type="number" value="52"></div>
        <div class="field" style="flex:1"><label>Meteor CD</label><input id="vMeteorCd" type="number" step="0.5" value="8"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>Meteor ì½”ìŠ¤íŠ¸</label><input id="vMeteorCost" type="number" value="35"></div>
        <div class="field" style="flex:1"><label>Meteor ë²”ìœ„</label><input id="vMeteorR" type="number" value="90"></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="field" style="flex:1"><label>Frost ìŠ¬ë¡œìš°(ì´ˆ)</label><input id="vFrostDur" type="number" step="0.1" value="2.6"></div>
        <div class="field" style="flex:1"><label>Frost CD</label><input id="vFrostCd" type="number" step="0.5" value="6"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>Frost ì½”ìŠ¤íŠ¸</label><input id="vFrostCost" type="number" value="28"></div>
        <div class="field" style="flex:1"><label>Frost ë²”ìœ„</label><input id="vFrostR" type="number" value="110"></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="field" style="flex:1"><label>Curse í‹±DMG</label><input id="vCurseDmg" type="number" value="8"></div>
        <div class="field" style="flex:1"><label>Curse ì§€ì†(ì´ˆ)</label><input id="vCurseDur" type="number" step="0.5" value="5"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>Curse ì½”ìŠ¤íŠ¸</label><input id="vCurseCost" type="number" value="22"></div>
        <div class="field" style="flex:1"><label>Curse ë²”ìœ„</label><input id="vCurseR" type="number" value="120"></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="field" style="flex:1"><label>Wall ì½”ìŠ¤íŠ¸</label><input id="vWallCost" type="number" value="25"></div>
        <div class="field" style="flex:1"><label>Wall CD</label><input id="vWallCd" type="number" step="0.5" value="12"></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="field" style="flex:1"><label>Buff ì§€ì†(ì´ˆ)</label><input id="vBuffDur" type="number" step="0.5" value="6"></div>
        <div class="field" style="flex:1"><label>Buff ì½”ìŠ¤íŠ¸</label><input id="vBuffCost" type="number" value="20"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>Buff ë²”ìœ„</label><input id="vBuffR" type="number" value="140"></div>
        <div class="field" style="flex:1"><label>Buff CD</label><input id="vBuffCd" type="number" step="0.5" value="12"></div>
      </div>
    </div>
    <div class="panel" style="max-height:92vh;overflow-y:auto">
      <div class="h">ğŸ§ ìš©ì‚¬ ì„¤ì •</div>
      <div class="hr"></div>
      <div class="h">âš”ï¸ ì „ì‚¬</div>
      <div class="row">
        <div class="field" style="flex:1"><label>HP</label><input id="wHP" type="number" value="220"></div>
        <div class="field" style="flex:1"><label>ì´ì†</label><input id="wSpeed" type="number" value="130"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>ATK</label><input id="wAtk" type="number" value="12"></div>
        <div class="field" style="flex:1"><label>CD</label><input id="wAtkCd" type="number" step="0.05" value="0.55"></div>
      </div>
      <div class="hr"></div>
      <div class="h">ğŸ’š íëŸ¬</div>
      <div class="row">
        <div class="field" style="flex:1"><label>HP</label><input id="hHP" type="number" value="130"></div>
        <div class="field" style="flex:1"><label>ì´ì†</label><input id="hSpeed" type="number" value="140"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>ATK</label><input id="hAtk" type="number" value="8"></div>
        <div class="field" style="flex:1"><label>íCD</label><input id="hHealCd" type="number" step="0.1" value="6.0"></div>
      </div>
      <div class="hr"></div>
      <div class="h">ğŸ¹ ì›ë”œ</div>
      <div class="row">
        <div class="field" style="flex:1"><label>HP</label><input id="rHP" type="number" value="100"></div>
        <div class="field" style="flex:1"><label>ì´ì†</label><input id="rSpeed" type="number" value="155"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>ATK</label><input id="rAtk" type="number" value="22"></div>
        <div class="field" style="flex:1"><label>CD</label><input id="rAtkCd" type="number" step="0.05" value="0.7"></div>
      </div>
      <div class="hr"></div>
      <div class="h">ğŸ”® ë§ˆë²•ì‚¬</div>
      <div class="row">
        <div class="field" style="flex:1"><label>HP</label><input id="mgHP" type="number" value="95"></div>
        <div class="field" style="flex:1"><label>ì´ì†</label><input id="mgSpeed" type="number" value="135"></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1"><label>ATK</label><input id="mgAtk" type="number" value="14"></div>
        <div class="field" style="flex:1"><label>CD</label><input id="mgAtkCd" type="number" step="0.05" value="0.85"></div>
      </div>
    </div>
  </div>

  <!-- ==================== HELP TAB ==================== -->
  <div id="tab-help" class="panel" style="display:none">
    <div class="h">ğŸ“– ì„¤ëª… v8.3 â€” ì˜¤í† ì²´ìŠ¤ + ì—ë””í„°</div>
    <div id="helpContent"></div>
  </div>

  <!-- MERGE POPUP -->
  <div class="mergePopup" id="mergePopup">
    <div class="mergeModal">
      <div class="h">â­ 3í•© ì§„í™”!</div>
      <div class="muted" id="mergeSub"></div>
      <div class="mergeChoices" id="mergeChoices"></div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn primary" id="mergeConfirm" disabled>ì§„í™” í™•ì •</button>
        <button class="btn small" id="mergeCancel" style="margin-left:8px">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- RESULT OVERLAY -->
  <div class="resultOverlay" id="resultOverlay">
    <div class="resultModal">
      <div class="resultHeader"><h3 id="resultTitle"></h3></div>
      <div class="muted" id="resultSub"></div>
      <div class="resultKpi" id="resultKpi"></div>
      <div class="resultChoices" id="resultChoices"></div>
      <div class="resultFooter">
        <button class="btn primary" id="resultConfirm" disabled>ì„ íƒ í™•ì • â†’ ë‹¤ìŒ ìƒì </button>
      </div>
    </div>
  </div>
</div>

<script>
/* === IMAGE RESOURCE SYSTEM v2.0 (External) === */
const IMG_CACHE={};
const IMG_PATHS={};
function _regImg(key,path){IMG_PATHS[key]=path;}
function getImg(key){
  if(IMG_CACHE[key])return IMG_CACHE[key].complete?IMG_CACHE[key]:null;
  if(!IMG_PATHS[key])return null;
  const i=new Image();i.src=IMG_PATHS[key];
  IMG_CACHE[key]=i;
  return i.complete?i:null;
}
/* Preload all images */
function preloadImages(){for(const k in IMG_PATHS){if(!IMG_CACHE[k]){const i=new Image();i.src=IMG_PATHS[k];IMG_CACHE[k]=i;}}}

/* Register all mob images */
const _mobList=['mob_melee','mob_melee_skill','mob_melee_dash','mob_ranged','mob_ranged_skill','mob_ranged_snipe','mob_healer','mob_healer_skill','mob_healer_cleanse','mob_bomber','mob_splitter','mob_frostbomber','mob_chrono','mob_chrono_boost','mob_chrono_stop','mob_elite_a','mob_elite_b','mob_elite_c','mob_slime','mob_slime_split','mob_slime_king','mob_hybrid_sword','mob_hybrid_poison','mob_hybrid_timeslime'];
_mobList.forEach(k=>_regImg(k,'assets/mobs/'+k+'.png'));

/* Register hero images */
['hero_warrior','hero_healer','hero_ranger','hero_mage'].forEach(k=>_regImg(k,'assets/heroes/'+k+'.png'));

/* Register spawner images */
const _spList=['spawner_melee','spawner_melee_skill','spawner_melee_dash','spawner_ranged','spawner_ranged_skill','spawner_ranged_snipe','spawner_healer','spawner_healer_skill','spawner_healer_cleanse','spawner_bomber','spawner_splitter','spawner_frostbomber','spawner_chrono','spawner_chrono_boost','spawner_chrono_stop','spawner_elite_a','spawner_elite_b','spawner_elite_c','spawner_slime','spawner_slime_split','spawner_slime_king'];
_spList.forEach(k=>_regImg(k,'assets/spawners/'+k+'.png'));

/* Register bullet images */
['bullet_hero','bullet_mob','bullet_poison'].forEach(k=>_regImg(k,'assets/bullets/'+k+'.png'));

const MOB_IMG={melee:'mob_melee',melee_skill:'mob_melee_skill',melee_dash:'mob_melee_dash',ranged:'mob_ranged',ranged_skill:'mob_ranged_skill',ranged_snipe:'mob_ranged_snipe',healer:'mob_healer',healer_skill:'mob_healer_skill',healer_cleanse:'mob_healer_cleanse',bomber:'mob_bomber',splitter:'mob_splitter',frostbomber:'mob_frostbomber',chrono:'mob_chrono',chronoBoost:'mob_chrono_boost',chronoStop:'mob_chrono_stop',eliteA:'mob_elite_a',eliteB:'mob_elite_b',eliteC:'mob_elite_c',slime:'mob_slime',slime_split:'mob_slime_split',slime_king:'mob_slime_king',hybrid_sword:'mob_hybrid_sword',hybrid_poison:'mob_hybrid_poison',hybrid_timeslime:'mob_hybrid_timeslime'};
const HERO_IMG={warrior:'hero_warrior',healer:'hero_healer',ranger:'hero_ranger',mage:'hero_mage'};
const TILE_IMG={'s1':'spawner_melee','s1-1':'spawner_melee_skill','s1-2':'spawner_melee_dash','s2':'spawner_ranged','s2-1':'spawner_ranged_skill','s2-2':'spawner_ranged_snipe','s3':'spawner_healer','s3-1':'spawner_healer_skill','s3-2':'spawner_healer_cleanse','s4':'spawner_bomber','s4-1':'spawner_splitter','s4-2':'spawner_frostbomber','s5':'spawner_chrono','s5-1':'spawner_chrono_boost','s5-2':'spawner_chrono_stop','es1':'spawner_elite_a','es2':'spawner_elite_b','es3':'spawner_elite_c','s6':'spawner_slime','s6-1':'spawner_slime_split','s6-2':'spawner_slime_king'};
const BULLET_IMG={hero:'bullet_hero',mob:'bullet_mob',poison:'bullet_poison'};

preloadImages();

/* ========== UTILS ========== */
const now=()=>performance.now();
const clamp=(v,mn,mx)=>Math.max(mn,Math.min(mx,v));
const rand=(a,b)=>a+Math.random()*(b-a);
function dist2(ax,ay,bx,by){const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy;}
function norm(ax,ay){const l=Math.hypot(ax,ay)||1;return[ax/l,ay/l];}
function uid(){return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);}
function deepCopy(o){return JSON.parse(JSON.stringify(o));}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)];}
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
const blocksBullet=new Set();

/* ========== TABS ========== */
function activateTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
  ['editor','prep','battle','settings','help'].forEach(n=>{
    const el=document.getElementById('tab-'+n);
    if(el) el.style.display=(n===name)?'':'none';
  });
}
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>activateTab(t.dataset.tab));

/* ========== TILE DEFS ========== */
const TILE={
  wall:'wall',floor:'floor',
  entrance:'entrance',castle:'castle',chest:'chest',
  trap:'trap',poison:'poison',frosttrap:'frost',stuntrap:'stun',
  s1:'s1',s2:'s2',s3:'s3',s4:'s4',s5:'s5',
  s11:'s1-1',s12:'s1-2',s21:'s2-1',s22:'s2-2',s31:'s3-1',s32:'s3-2',
  s41:'s4-1',s42:'s4-2',s51:'s5-1',s52:'s5-2',
  es1:'es1',es2:'es2',es3:'es3',
  s6:'s6',s61:'s6-1',s62:'s6-2',
  fs1:'fs1',fs2:'fs2',fs3:'fs3',
};

const tileTypes=[
  {id:TILE.wall,name:'ë²½',icon:'',color:'#1e293b',text:'',symbol:'#'},
  {id:TILE.floor,name:'ë°”ë‹¥',icon:'',color:'#374151',text:'',symbol:'.'},
  {id:TILE.entrance,name:'ì…êµ¬',icon:'ğŸšª',color:'#065f46',text:'#6ee7b7',symbol:'E'},
  {id:TILE.castle,name:'ë§ˆì™•ì„±',icon:'ğŸ°',color:'#7f1d1d',text:'#fca5a5',symbol:'C'},
  {id:TILE.chest,name:'ë³´ë¬¼',icon:'ğŸ“¦',color:'#78350f',text:'#fcd34d',symbol:'$'},
  {id:TILE.trap,name:'í”¼í•´í•¨ì •',icon:'âš¡',color:'#92400e',text:'#fbbf24',symbol:'T'},
  {id:TILE.poison,name:'ë…í•¨ì •',icon:'â˜ ',color:'#365314',text:'#a3e635',symbol:'P'},
  {id:TILE.frosttrap,name:'ë¹™ê²°í•¨ì •',icon:'â„',color:'#1e3a5f',text:'#60a5fa',symbol:'F'},
  {id:TILE.stuntrap,name:'ìŠ¤í„´í•¨ì •',icon:'ğŸ’¥',color:'#4a1d96',text:'#c084fc',symbol:'Z'},
  // Spawners (shown on map)
  {id:TILE.s1,name:'ê·¼ì ‘',icon:'âš”',color:'#991b1b',text:'#fca5a5',symbol:'1'},
  {id:TILE.s2,name:'ì›ê±°ë¦¬',icon:'ğŸ¹',color:'#92400e',text:'#fde68a',symbol:'2'},
  {id:TILE.s3,name:'íëŸ¬',icon:'ğŸ’š',color:'#065f46',text:'#86efac',symbol:'3'},
  {id:TILE.s4,name:'í­ê²©',icon:'ğŸ’£',color:'#581c87',text:'#d8b4fe',symbol:'4'},
  {id:TILE.s5,name:'ì‹œê°„',icon:'â³',color:'#312e81',text:'#a5b4fc',symbol:'5'},
  {id:TILE.s11,name:'ê·¼ì ‘ìŠ¤í‚¬',icon:'ğŸ—¡',color:'#b91c1c',text:'#fecaca',symbol:'+'},
  {id:TILE.s12,name:'ëŒì§„',icon:'ğŸ”¥',color:'#dc2626',text:'#fca5a5',symbol:'+'},
  {id:TILE.s21,name:'ê´€í†µ',icon:'ğŸ¯',color:'#b45309',text:'#fde68a',symbol:'+'},
  {id:TILE.s22,name:'ì €ê²©',icon:'ğŸ”­',color:'#d97706',text:'#fef3c7',symbol:'+'},
  {id:TILE.s31,name:'ê°•í™”í',icon:'ğŸ’–',color:'#047857',text:'#6ee7b7',symbol:'+'},
  {id:TILE.s32,name:'ì •í™”',icon:'âœ¨',color:'#059669',text:'#a7f3d0',symbol:'+'},
  {id:TILE.s41,name:'ë¶„ì—´',icon:'ğŸ§¬',color:'#7e22ce',text:'#e9d5ff',symbol:'+'},
  {id:TILE.s42,name:'ë¹™ê²°í­ë°œ',icon:'ğŸ§Š',color:'#6d28d9',text:'#c4b5fd',symbol:'+'},
  {id:TILE.s51,name:'ê°€ì†',icon:'âš¡',color:'#4338ca',text:'#c7d2fe',symbol:'+'},
  {id:TILE.s52,name:'ì‹œê°„ì •ì§€',icon:'ğŸ”®',color:'#3730a3',text:'#a5b4fc',symbol:'+'},
  {id:TILE.es1,name:'ì—˜ë¦¬íŠ¸A',icon:'ğŸ‘¹',color:'#1e293b',text:'#fca5a5',symbol:'A'},
  {id:TILE.es2,name:'ì—˜ë¦¬íŠ¸B',icon:'ğŸ‘º',color:'#1e293b',text:'#93c5fd',symbol:'B'},
  {id:TILE.es3,name:'ì—˜ë¦¬íŠ¸C',icon:'ğŸ‰',color:'#1e293b',text:'#f9a8d4',symbol:'D'},
  {id:TILE.s6,name:'ìŠ¬ë¼ì„',icon:'ğŸŸ¢',color:'#166534',text:'#86efac',symbol:'6'},
  {id:TILE.s61,name:'ë¶„ì—´ìŠ¬ë¼ì„',icon:'ğŸŸ©',color:'#15803d',text:'#4ade80',symbol:'+'},
  {id:TILE.s62,name:'í‚¹ìŠ¬ë¼ì„',icon:'ğŸ‘‘',color:'#14532d',text:'#22c55e',symbol:'+'},
  {id:TILE.fs1,name:'ê²€ê¶ì‚¬',icon:'âš”ğŸ¹',color:'#7f1d1d',text:'#fde68a',symbol:'F'},
  {id:TILE.fs2,name:'ë…í­íƒ„',icon:'â˜ ğŸ’£',color:'#365314',text:'#d8b4fe',symbol:'F'},
  {id:TILE.fs3,name:'ì‹œê°„ìŠ¬ë¼ì„',icon:'â³ğŸŸ¢',color:'#312e81',text:'#86efac',symbol:'F'},
];
blocksBullet.add(TILE.wall);
function tileInfo(id){return tileTypes.find(t=>t.id===id)||tileTypes[0];}

/* Spawner groups */
const BASE_SPAWNER_IDS=[TILE.s1,TILE.s2,TILE.s3,TILE.s4,TILE.s5,TILE.s6];
const ALL_SPAWNER_IDS=[TILE.s1,TILE.s2,TILE.s3,TILE.s4,TILE.s5,TILE.s6,TILE.s11,TILE.s12,TILE.s21,TILE.s22,TILE.s31,TILE.s32,TILE.s41,TILE.s42,TILE.s51,TILE.s52,TILE.s61,TILE.s62,TILE.es1,TILE.es2,TILE.es3,TILE.fs1,TILE.fs2,TILE.fs3];
const SPAWNER_IDS=ALL_SPAWNER_IDS;
const TRAP_IDS=[TILE.trap,TILE.poison,TILE.frosttrap,TILE.stuntrap];
const PLACEABLE_IDS=[...ALL_SPAWNER_IDS,...TRAP_IDS]; // what can be placed from bench

// Tiles you CANNOT place on
const UNPLACEABLE_TILES=new Set([TILE.wall,TILE.entrance,TILE.castle,TILE.chest,TILE.trap,TILE.poison,TILE.frosttrap,TILE.stuntrap]);

/* ========== SPAWNER DEFINITIONS ========== */
const SPAWNER_DEFS={
  [TILE.s1]:{name:'ê·¼ì ‘ ìŠ¤í¬ë„ˆ',icon:'âš”',tier:1,cost:3,family:'melee',desc:'ê·¼ì ‘ ì „íˆ¬ ëª¹ ì†Œí™˜',color:'#fca5a5',evolutions:[TILE.s11,TILE.s12]},
  [TILE.s2]:{name:'ì›ê±°ë¦¬ ìŠ¤í¬ë„ˆ',icon:'ğŸ¹',tier:1,cost:3,family:'ranged',desc:'ì›ê±°ë¦¬ íƒ„í™˜ ëª¹ ì†Œí™˜',color:'#fde68a',evolutions:[TILE.s21,TILE.s22]},
  [TILE.s3]:{name:'íëŸ¬ ìŠ¤í¬ë„ˆ',icon:'ğŸ’š',tier:2,cost:4,family:'support',desc:'ì•„êµ° ì¹˜ìœ  ëª¹ ì†Œí™˜',color:'#86efac',evolutions:[TILE.s31,TILE.s32]},
  [TILE.s4]:{name:'í­ê²© ìŠ¤í¬ë„ˆ',icon:'ğŸ’£',tier:2,cost:4,family:'bomber',desc:'í­ë°œí˜• ëª¹ ì†Œí™˜',color:'#d8b4fe',evolutions:[TILE.s41,TILE.s42]},
  [TILE.s5]:{name:'ì‹œê°„ ìŠ¤í¬ë„ˆ',icon:'â³',tier:3,cost:5,family:'chrono',desc:'ì‹œê°„ ì¡°ì‘ ëª¹ ì†Œí™˜',color:'#a5b4fc',evolutions:[TILE.s51,TILE.s52]},
  [TILE.s11]:{name:'ê·¼ì ‘ ìŠ¤í‚¬',icon:'ğŸ—¡',tier:3,cost:0,family:'melee',desc:'ë²”ìœ„ ìŠ¤í‚¬ ì‚¬ìš©',color:'#fecaca',evolutions:[]},
  [TILE.s12]:{name:'ëŒì§„ ìŠ¤í¬ë„ˆ',icon:'ğŸ”¥',tier:3,cost:0,family:'melee',desc:'ëŒ€ì‹œ ê³µê²© ëª¹',color:'#fca5a5',evolutions:[]},
  [TILE.s21]:{name:'ê´€í†µ ìŠ¤í¬ë„ˆ',icon:'ğŸ¯',tier:3,cost:0,family:'ranged',desc:'ê´€í†µ íƒ„í™˜',color:'#fde68a',evolutions:[]},
  [TILE.s22]:{name:'ì €ê²© ìŠ¤í¬ë„ˆ',icon:'ğŸ”­',tier:3,cost:0,family:'ranged',desc:'ì¥ê±°ë¦¬ ê³ ëŒ€ë¯¸ì§€',color:'#fef3c7',evolutions:[]},
  [TILE.s31]:{name:'ê°•í™”í ìŠ¤í¬ë„ˆ',icon:'ğŸ’–',tier:3,cost:0,family:'support',desc:'ê°•í™”ëœ ì¹˜ìœ ',color:'#6ee7b7',evolutions:[]},
  [TILE.s32]:{name:'ì •í™” ìŠ¤í¬ë„ˆ',icon:'âœ¨',tier:3,cost:0,family:'support',desc:'ë””ë²„í”„ í•´ì œ',color:'#a7f3d0',evolutions:[]},
  [TILE.s41]:{name:'ë¶„ì—´ ìŠ¤í¬ë„ˆ',icon:'ğŸ§¬',tier:3,cost:0,family:'bomber',desc:'ë¶„ì—´ í­ë°œ',color:'#e9d5ff',evolutions:[]},
  [TILE.s42]:{name:'ë¹™ê²°í­ë°œ ìŠ¤í¬ë„ˆ',icon:'ğŸ§Š',tier:3,cost:0,family:'bomber',desc:'ë¹™ê²° í­ë°œ',color:'#c4b5fd',evolutions:[]},
  [TILE.s51]:{name:'ê°€ì† ìŠ¤í¬ë„ˆ',icon:'âš¡',tier:3,cost:0,family:'chrono',desc:'ì•„êµ° ê°€ì†',color:'#c7d2fe',evolutions:[]},
  [TILE.s52]:{name:'ì‹œê°„ì •ì§€ ìŠ¤í¬ë„ˆ',icon:'ğŸ”®',tier:3,cost:0,family:'chrono',desc:'ì  ì‹œê°„ì •ì§€',color:'#a5b4fc',evolutions:[]},
  [TILE.es1]:{name:'ì—˜ë¦¬íŠ¸A',icon:'ğŸ‘¹',tier:4,cost:7,family:'melee',desc:'ê°•ë ¥í•œ ë³´ìŠ¤ ëª¹',color:'#fca5a5',evolutions:[]},
  [TILE.es2]:{name:'ì—˜ë¦¬íŠ¸B',icon:'ğŸ‘º',tier:4,cost:7,family:'ranged',desc:'ì›ê±°ë¦¬ ë³´ìŠ¤ ëª¹',color:'#93c5fd',evolutions:[]},
  [TILE.es3]:{name:'ì—˜ë¦¬íŠ¸C',icon:'ğŸ‰',tier:4,cost:8,family:'bomber',desc:'ì†Œí™˜ì‚¬ ë³´ìŠ¤ ëª¹',color:'#f9a8d4',evolutions:[]},
  [TILE.s6]:{name:'ìŠ¬ë¼ì„ ìŠ¤í¬ë„ˆ',icon:'ğŸŸ¢',tier:1,cost:3,family:'slime',desc:'ì£½ìœ¼ë©´ ë¶„ì—´í•˜ëŠ” ìŠ¬ë¼ì„',color:'#86efac',evolutions:[TILE.s61,TILE.s62]},
  [TILE.s61]:{name:'ë¶„ì—´ìŠ¬ë¼ì„',icon:'ğŸŸ©',tier:3,cost:0,family:'slime',desc:'3ë§ˆë¦¬ë¡œ ë¶„ì—´',color:'#4ade80',evolutions:[]},
  [TILE.s62]:{name:'í‚¹ìŠ¬ë¼ì„',icon:'ğŸ‘‘',tier:3,cost:0,family:'slime',desc:'ê°ì†ì˜¤ë¼+ì£½ìœ¼ë©´ ë²”ìœ„í”¼í•´',color:'#22c55e',evolutions:[]},
  [TILE.fs1]:{name:'ê²€ê¶ì‚¬',icon:'âš”ğŸ¹',tier:3,cost:5,family:'hybrid',desc:'ê·¼ì ‘+ì›ê±°ë¦¬ í•˜ì´ë¸Œë¦¬ë“œ',color:'#fde68a',evolutions:[]},
  [TILE.fs2]:{name:'ë…í­íƒ„',icon:'â˜ ğŸ’£',tier:3,cost:5,family:'hybrid',desc:'ë…ì¥íŒ+í­ë°œ í•˜ì´ë¸Œë¦¬ë“œ',color:'#d8b4fe',evolutions:[]},
  [TILE.fs3]:{name:'ì‹œê°„ìŠ¬ë¼ì„',icon:'â³ğŸŸ¢',tier:3,cost:5,family:'hybrid',desc:'ê°ì†+ë¶„ì—´ í•˜ì´ë¸Œë¦¬ë“œ',color:'#86efac',evolutions:[]},
};

/* ========== SYNERGY DEFINITIONS ========== */
const SYNERGY_DEFS=[
  {id:'melee',name:'ê·¼ì ‘',icon:'âš”',family:'melee',thresholds:[{n:2,label:'+10% HP',desc:'ëª¹ HP +10%'},{n:4,label:'+25% HP',desc:'ëª¹ HP +25%'}]},
  {id:'ranged',name:'ì›ê±°ë¦¬',icon:'ğŸ¹',family:'ranged',thresholds:[{n:2,label:'+15% ì‚¬ê±°ë¦¬',desc:'íƒ„í™˜ ì‚¬ê±°ë¦¬ +15%'},{n:4,label:'+30% ì‚¬ê±°ë¦¬',desc:'íƒ„í™˜ ì‚¬ê±°ë¦¬ +30%'}]},
  {id:'support',name:'ì§€ì›',icon:'ğŸ’š',family:'support',thresholds:[{n:2,label:'+30% íëŸ‰',desc:'ì¹˜ìœ ëŸ‰ +30%'}]},
  {id:'bomber',name:'í­ê²©',icon:'ğŸ’£',family:'bomber',thresholds:[{n:2,label:'+20% í­ë°œë²”ìœ„',desc:'í­ë°œ ë²”ìœ„ +20%'}]},
  {id:'chrono',name:'ì‹œê°„',icon:'â³',family:'chrono',thresholds:[{n:2,label:'+25% ì§€ì†ì‹œê°„',desc:'íš¨ê³¼ ì§€ì† +25%'}]},
  {id:'slime',name:'ìŠ¬ë¼ì„',icon:'ğŸŸ¢',family:'slime',thresholds:[{n:2,label:'+1 ë¶„ì—´',desc:'ë¶„ì—´ ì‹œ +1ë§ˆë¦¬'},{n:4,label:'+2 ë¶„ì—´',desc:'ë¶„ì—´ ì‹œ +2ë§ˆë¦¬'}]},
  {id:'hybrid',name:'í•˜ì´ë¸Œë¦¬ë“œ',icon:'ğŸ”€',family:'hybrid',thresholds:[{n:2,label:'+15% ì „ì²´',desc:'í•˜ì´ë¸Œë¦¬ë“œ ì „ì²´ ìŠ¤íƒ¯ +15%'}]},
];

/* ========== PRESET MAPS ========== */
const STAGE_MAPS=[
  {name:'ì§ì„  íšŒë‘',w:20,h:15,data:[
    '####################','#..................#','#.####.####.####.#.#','#.#..#.#..#.#..#.#.#',
    '#.#..#.#..#.#..#.#.#','#.####.####.####.#.#','#..................#','E..................C',
    '#..................#','#.####.####.####.#.#','#.#..#.#..#.#..#.#.#','#.#..#.#..#.#..#.#.#',
    '#.####.####.####.#.#','#..................#','####################']},
  {name:'ê°ˆë¦¼ê¸¸',w:20,h:18,data:[
    '####################','#........##........#','#.######.##.######.#','#.#....#....#....#.#',
    '#.#.##.######.##.#.#','#...##........##...#','##.####.####.####.##','E.................C#',
    '##.####.####.####.##','#...##........##...#','#.#.##.######.##.#.#','#.#....#....#....#.#',
    '#.######.##.######.#','#........##........#','#.####.####.####.#.#','#..................#',
    '#........##........#','####################']},
  {name:'ë‚˜ì„  ë˜ì „',w:22,h:18,data:[
    '######################','#....................#','#.##################.#','#.#................#.#',
    '#.#.##############.#.#','#.#.#..........#.#.#.#','#.#.#.########.#.#.#.#','#.#.#.#......#.#.#.#.#',
    '#.#.#.#.####.#.#.#.#.#','E.#.#.#.#C.#.#.#.#.#.#','#.#.#.#.####.#.#.#.#.#','#.#.#.#......#.#.#.#.#',
    '#.#.#.########.#.#.#.#','#.#.#..........#.#.#.#','#.#.##############.#.#','#.#................#.#',
    '#.##################.#','######################']},
  {name:'ìš”ìƒˆ',w:24,h:18,data:[
    '########################','#......................#','#.####.########.####.#.#','#.#..#.#......#.#..#.#.#',
    '#.#..#.#.####.#.#..#.#.#','#.####.#.#..#.#.####.#.#','#......#.#..#.#......#.#','E......#.####.#......C.#',
    '#......#......#......#.#','#.####.########.####.#.#','#.#..#..........#..#.#.#','#.#..#.########.#..#.#.#',
    '#.####.#......#.####.#.#','#......#.####.#......#.#','#......#.#$$#.#......#.#','#......#.####.#......#.#',
    '#......................#','########################']},
  {name:'ë§ˆì™•ì˜ ì‹¬ì¥',w:26,h:20,data:[
    '##########################','#........................#','#.####.####.####.####.##.#','#.#..#.#..#.#..#.#..#.##.#',
    '#.#..#.#..#.#..#.#..#....#','#.####.####.####.####.##.#','#........................#','#.######.########.######.#',
    '#.#....#.#......#.#....#.#','E.#.##.#.#.####.#.#.##.#C#','#.#.##.#.#.#TT#.#.#.##.#.#','#.#....#.#.####.#.#....#.#',
    '#.######.########.######.#','#........................#','#.####.####.####.####.##.#','#.#..#.#..#.#..#.#..#.##.#',
    '#.#..#.#..#.#..#.#..#....#','#.####.####.####.####.##.#','#........................#','##########################']},
];

function parseStageMap(stageIdx){
  const def=STAGE_MAPS[stageIdx % STAGE_MAPS.length];
  const h=def.data.length;
  const w=def.data[0].length;
  const tiles=[];
  for(let y=0;y<h;y++){
    const row=[];
    for(let x=0;x<w;x++){
      const ch=(def.data[y]||'')[x]||'#';
      switch(ch){
        case'#':row.push(TILE.wall);break;
        case'.':row.push(TILE.floor);break;
        case'E':row.push(TILE.entrance);break;
        case'C':row.push(TILE.castle);break;
        case'$':row.push(TILE.chest);break;
        case'T':row.push(TILE.trap);break;
        case'P':row.push(TILE.poison);break;
        case'F':row.push(TILE.frosttrap);break;
        case'Z':row.push(TILE.stuntrap);break;
        default:row.push(TILE.floor);
      }
    }
    tiles.push(row);
  }
  return{name:def.name,w,h,tiles};
}

/* ========== GLOBAL MAP STATE ========== */
let mapW=20,mapH=15,mapData=[];
let run=null; // current run state
let runActive=false; // is a run in progress?

// Init editor map
function initEditorMap(w,h){
  mapW=w;mapH=h;
  mapData=[];
  for(let y=0;y<h;y++){
    const row=[];
    for(let x=0;x<w;x++){
      if(x===0||y===0||x===w-1||y===h-1) row.push(TILE.wall);
      else row.push(TILE.floor);
    }
    row[0]=TILE.wall;
    mapData.push(row);
  }
  // Place entrance and castle
  mapData[Math.floor(h/2)][0]=TILE.entrance;
  mapData[Math.floor(h/2)][w-1]=TILE.castle;
}
initEditorMap(20,15);

/* ========== EDITOR ========== */
const editorTools=[
  {id:TILE.wall,icon:'#',label:'ë²½'},
  {id:TILE.floor,icon:'.',label:'ë°”ë‹¥'},
  {id:TILE.entrance,icon:'ğŸšª',label:'ì…êµ¬'},
  {id:TILE.castle,icon:'ğŸ°',label:'ë§ˆì™•ì„±'},
  {id:TILE.chest,icon:'ğŸ“¦',label:'ë³´ë¬¼'},
  {id:TILE.trap,icon:'âš¡',label:'í”¼í•´í•¨ì •'},
  {id:TILE.poison,icon:'â˜ ',label:'ë…í•¨ì •'},
  {id:TILE.frosttrap,icon:'â„',label:'ë¹™ê²°'},
  {id:TILE.stuntrap,icon:'ğŸ’¥',label:'ìŠ¤í„´'},
];
let edTool=TILE.wall;
let edPainting=false;
/* v8.2 Undo/Redo */
let undoStack=[],redoStack=[],maxUndo=50;
function pushUndo(){
  undoStack.push(JSON.stringify(mapData));
  if(undoStack.length>maxUndo)undoStack.shift();
  redoStack=[];
}
function doUndo(){
  if(!undoStack.length||runActive)return;
  redoStack.push(JSON.stringify(mapData));
  mapData=JSON.parse(undoStack.pop());mapH=mapData.length;mapW=mapData[0].length;
  drawEditorCanvas();
}
function doRedo(){
  if(!redoStack.length||runActive)return;
  undoStack.push(JSON.stringify(mapData));
  mapData=JSON.parse(redoStack.pop());mapH=mapData.length;mapW=mapData[0].length;
  drawEditorCanvas();
}
document.addEventListener('keydown',e=>{
  if(e.ctrlKey&&e.key==='z'){e.preventDefault();doUndo();}
  if(e.ctrlKey&&e.key==='x'){e.preventDefault();doRedo();}
});

function buildEditorTools(){
  const grid=document.getElementById('edTools');grid.innerHTML='';
  editorTools.forEach(t=>{
    const d=document.createElement('div');
    d.className='toolBtn'+(edTool===t.id?' active':'');
    d.innerHTML=`${t.icon} ${t.label}`;
    d.onclick=()=>{edTool=t.id;buildEditorTools();};
    grid.appendChild(d);
  });
}
buildEditorTools();

function buildPresetRow(){
  const row=document.getElementById('presetRow');row.innerHTML='';
  STAGE_MAPS.forEach((m,i)=>{
    const b=document.createElement('button');
    b.className='btn small';b.textContent=m.name;
    b.onclick=()=>{
      if(runActive){alert('ëŸ° ì§„í–‰ ì¤‘ì—ëŠ” í”„ë¦¬ì…‹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
      const parsed=parseStageMap(i);
      mapW=parsed.w;mapH=parsed.h;mapData=parsed.tiles;
      document.getElementById('edW').value=mapW;
      document.getElementById('edH').value=mapH;
      drawEditorCanvas();
    };
    row.appendChild(b);
  });
}
buildPresetRow();

const edCanvas=document.getElementById('edCanvas'),edctx=edCanvas.getContext('2d');

function edGetCell(e){
  const r=edCanvas.getBoundingClientRect();
  const mx=(e.clientX-r.left)*(edCanvas.width/r.width);
  const my=(e.clientY-r.top)*(edCanvas.height/r.height);
  const pad=12,cW=Math.floor((edCanvas.width-pad*2)/mapW),cH=Math.floor((edCanvas.height-pad*2)/mapH),cs=Math.min(cW,cH);
  const gx=Math.floor((mx-pad)/cs),gy=Math.floor((my-pad)/cs);
  if(!inBounds(gx,gy)) return null;
  return{gx,gy};
}

function edPaint(gx,gy){
  if(runActive) return;
  // For entrance/castle, ensure only one
  if(edTool===TILE.entrance){
    for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++)if(mapData[y][x]===TILE.entrance)mapData[y][x]=TILE.floor;
  }
  if(edTool===TILE.castle){
    for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++)if(mapData[y][x]===TILE.castle)mapData[y][x]=TILE.floor;
  }
  mapData[gy][gx]=edTool;
  drawEditorCanvas();
}

edCanvas.onmousedown=e=>{if(runActive)return;pushUndo();edPainting=true;const c=edGetCell(e);if(c)edPaint(c.gx,c.gy);};
edCanvas.onmousemove=e=>{if(!edPainting||runActive)return;const c=edGetCell(e);if(c)edPaint(c.gx,c.gy);};
document.addEventListener('mouseup',()=>{edPainting=false;});
edCanvas.addEventListener('touchstart',e=>{if(runActive)return;e.preventDefault();const t=e.touches[0];const c=edGetCell(t);if(c)edPaint(c.gx,c.gy);},{passive:false});
edCanvas.addEventListener('touchmove',e=>{if(runActive)return;e.preventDefault();const t=e.touches[0];const c=edGetCell(t);if(c)edPaint(c.gx,c.gy);},{passive:false});

document.getElementById('btnEdResize').onclick=()=>{
  if(runActive){alert('ëŸ° ì§„í–‰ ì¤‘ì—ëŠ” ë¦¬ì‚¬ì´ì¦ˆ ë¶ˆê°€');return;}
  const w=clamp(+document.getElementById('edW').value,8,40);
  const h=clamp(+document.getElementById('edH').value,8,30);
  initEditorMap(w,h);drawEditorCanvas();
};
document.getElementById('btnEdFill').onclick=()=>{
  if(runActive)return;
  for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){
    if(mapData[y][x]!==TILE.entrance&&mapData[y][x]!==TILE.castle) mapData[y][x]=edTool;
  }
  drawEditorCanvas();
};
document.getElementById('btnEdClear').onclick=()=>{
  if(runActive)return;
  initEditorMap(mapW,mapH);drawEditorCanvas();
};

function drawEditorCanvas(){
  drawMap(edctx,edCanvas.width,edCanvas.height,false);
  // Show info
  let eCnt=0,cCnt=0;
  for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){
    if(mapData[y][x]===TILE.entrance)eCnt++;
    if(mapData[y][x]===TILE.castle)cCnt++;
  }
  document.getElementById('edInfo').textContent=`${mapW}Ã—${mapH} | ì…êµ¬:${eCnt} ë§ˆì™•ì„±:${cCnt} | â†©${undoStack.length} â†ª${redoStack.length}`;
}

/* ========== START RUN ========== */
document.getElementById('btnStartRun').onclick=()=>{
  // Validate map
  let hasE=false,hasC=false;
  for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){
    if(mapData[y][x]===TILE.entrance)hasE=true;
    if(mapData[y][x]===TILE.castle)hasC=true;
  }
  if(!hasE||!hasC){alert('ë§µì— ì…êµ¬(ğŸšª)ì™€ ë§ˆì™•ì„±(ğŸ°)ì´ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤!');return;}
  // Start run
  newRun();
  activateTab('prep');
};

/* ========== RUN STATE ========== */
function newRun(){
  run={
    stage:1,
    gold:15,
    rerollCost:2,
    phase:'shop',
    bench:[],
    shop:[],
    activeSynergies:{},
    vil:{level:0,bonusSpawn:0,bonusHp:0,bonusAtk:0,bonusSpawnerHp:0,passives:{}},
    heroUp:{gHP:1,gAtk:1,resist:0,heroResist:0,aoeAtk:0,aoeProc:0.08,cleanseProc:0.06,focusProc:0.06,berserkProc:0.05,rangeBonus:0,healBias:0,bossDodge:0},
    stats:{wins:0,losses:0},
    adapt:{poison:0,trap:0,mob:0,bullet:0,boss:0,aoe:0},
    adaptActive:{},
    unlockedFusions:[],
    vilPath:null, /* chosen specialization path */
    mastery:{}, /* spawner family mastery: {melee:{kills:0,level:0}, ...} */
    awakenings:[], /* chosen awakenings */
  };
  runActive=true;
  // Map stays as-is from editor (no reload!)
  generateShop();
  refreshAllUI();
}

/* ========== ADAPTIVE HERO REINFORCEMENT (v8.2) ========== */
function computeAdaptations(){
  if(!run||!run.adapt) return;
  const entries=Object.entries(run.adapt).filter(([k,v])=>v>0).sort((a,b)=>b[1]-a[1]);
  run.adaptActive={};
  /* v8.2 expanded: each cause gets unique effects beyond just reduction */
  const ADAPT_DEFS={
    poison:{name:'ë… ì ì‘',icon:'â˜ ',effects:[
      {key:'reduction',label:'ë… í”¼í•´ ê°ì†Œ',formula:c=>Math.min(c*0.05+0.15,0.5)},
      {key:'poisonImmune',label:'ë… ë©´ì—­ ì‹œê°„',formula:c=>Math.min(0.5+c*0.3,2.5),unit:'ì´ˆ'},
      {key:'autoCleanseProc',label:'ë… ë°Ÿìœ¼ë©´ ì •í™” í™•ë¥ ',formula:c=>Math.min(0.15+c*0.08,0.6)},
    ]},
    trap:{name:'í•¨ì • ì ì‘',icon:'âš¡',effects:[
      {key:'reduction',label:'í•¨ì • í”¼í•´ ê°ì†Œ',formula:c=>Math.min(c*0.05+0.15,0.5)},
      {key:'trapSpeedBoost',label:'í•¨ì • ìœ„ ì´ì† ì¦ê°€',formula:c=>Math.min(0.1+c*0.06,0.4)},
      {key:'trapSenseRange',label:'í•¨ì • ê°ì§€ íšŒí”¼ ê±°ë¦¬',formula:c=>Math.min(20+c*8,60)},
    ]},
    mob:{name:'ê·¼ì ‘ ì ì‘',icon:'âš”',effects:[
      {key:'reduction',label:'ê·¼ì ‘ í”¼í•´ ê°ì†Œ',formula:c=>Math.min(c*0.05+0.15,0.5)},
      {key:'thorns',label:'ë°˜ê²© (ê°€ì‹œ í”¼í•´)',formula:c=>Math.min(2+c*1.5,12)},
      {key:'hpBonus',label:'ìµœëŒ€ HP ì¦ê°€',formula:c=>Math.min(0.05+c*0.04,0.35)},
    ]},
    bullet:{name:'íƒ„í™˜ ì ì‘',icon:'ğŸ”«',effects:[
      {key:'reduction',label:'íƒ„í™˜ í”¼í•´ ê°ì†Œ',formula:c=>Math.min(c*0.05+0.15,0.5)},
      {key:'dodgeChance',label:'íƒ„í™˜ íšŒí”¼ í™•ë¥ ',formula:c=>Math.min(0.08+c*0.06,0.4)},
      {key:'reflectChance',label:'íƒ„í™˜ ë°˜ì‚¬ í™•ë¥ ',formula:c=>Math.min(0.04+c*0.03,0.2)},
    ]},
    boss:{name:'ë³´ìŠ¤ ì ì‘',icon:'ğŸ‘¹',effects:[
      {key:'reduction',label:'ë³´ìŠ¤ í”¼í•´ ê°ì†Œ',formula:c=>Math.min(c*0.05+0.15,0.5)},
      {key:'bossDmgBonus',label:'ë³´ìŠ¤ ì¶”ê°€ í”¼í•´',formula:c=>Math.min(0.1+c*0.08,0.5)},
      {key:'ccResist',label:'CC ì €í•­ (ìŠ¤í„´/ë¹™ê²° ê°ì†Œ)',formula:c=>Math.min(0.15+c*0.1,0.6)},
    ]},
    aoe:{name:'ë²”ìœ„ ì ì‘',icon:'ğŸ’¥',effects:[
      {key:'reduction',label:'ë²”ìœ„ í”¼í•´ ê°ì†Œ',formula:c=>Math.min(c*0.05+0.15,0.5)},
      {key:'autoShieldProc',label:'í­ë°œ ê°ì§€ ë³´í˜¸ë§‰ í™•ë¥ ',formula:c=>Math.min(0.12+c*0.08,0.5)},
      {key:'spreadBonus',label:'ì‚°ê°œ ë³¸ëŠ¥ (íšŒí”¼ ê±°ë¦¬)',formula:c=>Math.min(15+c*6,50)},
    ]},
  };
  for(let i=0;i<Math.min(2,entries.length);i++){
    const[cause,count]=entries[i];
    const def=ADAPT_DEFS[cause];if(!def)continue;
    const a={name:def.name,icon:def.icon,count,effects:[]};
    for(const eff of def.effects){
      const val=eff.formula(count);
      a[eff.key]=val;
      a.effects.push({key:eff.key,label:eff.label,val,unit:eff.unit||''});
    }
    a.reduction=a.reduction||0;
    a.desc=a.effects.map(e=>e.key==='reduction'?`${(e.val*100)|0}%ê°ì†Œ`:e.label).join(' Â· ');
    run.adaptActive[cause]=a;
  }
}

/* ========== FUSION SYSTEM (v8.2) ========== */
const FUSION_RECIPES=[
  {a:TILE.s1,b:TILE.s2,result:TILE.fs1,cost:5,name:'ê²€ê¶ì‚¬',icon:'âš”ğŸ¹',desc:'ê·¼ì ‘+ì›ê±°ë¦¬ í•˜ì´ë¸Œë¦¬ë“œ'},
  {a:TILE.s3,b:TILE.s4,result:TILE.fs2,cost:5,name:'ë…í­íƒ„',icon:'â˜ ğŸ’£',desc:'ë…ì¥íŒ+í­ë°œ'},
  {a:TILE.s5,b:TILE.s6,result:TILE.fs3,cost:5,name:'ì‹œê°„ìŠ¬ë¼ì„',icon:'â³ğŸŸ¢',desc:'ê°ì†+ë¶„ì—´'},
];

function countItem(tile){
  let c=0;
  if(run){for(const b of run.bench)if(b.tile===tile)c+=b.count||1;}
  for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++)if(mapData[y][x]===tile)c++;
  return c;
}

function tryFusion(recipe){
  if(!run)return false;
  if(run.gold<recipe.cost)return false;
  if(countItem(recipe.a)<1||countItem(recipe.b)<1)return false;
  /* remove 1 of each ingredient */
  function removeOne(tile){
    const bi=run.bench.findIndex(b=>b.tile===tile);
    if(bi>=0){run.bench.splice(bi,1);return true;}
    for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){if(mapData[y][x]===tile){mapData[y][x]=TILE.floor;return true;}}
    return false;
  }
  if(!removeOne(recipe.a)||!removeOne(recipe.b))return false;
  run.gold-=recipe.cost;
  run.bench.push({tile:recipe.result,count:1});
  if(!run.unlockedFusions)run.unlockedFusions=[];
  if(!run.unlockedFusions.includes(recipe.result))run.unlockedFusions.push(recipe.result);
  refreshAllUI();drawEditorCanvas();
  return true;
}

/* ========== MAP HELPERS ========== */
function getPlacedSpawners(){
  const placed=[];
  for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){
    if(SPAWNER_IDS.includes(mapData[y][x])) placed.push({x,y,t:mapData[y][x]});
  }
  return placed;
}
function getPlacedTraps(){
  const placed=[];
  for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){
    if(TRAP_IDS.includes(mapData[y][x])) placed.push({x,y,t:mapData[y][x]});
  }
  return placed;
}
function findOne(id){for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++)if(mapData[y][x]===id)return{x,y};return null;}
function findAll(id){const r=[];for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++)if(mapData[y][x]===id)r.push({x,y});return r;}
function inBounds(x,y){return x>=0&&y>=0&&x<mapW&&y<mapH;}
function isWalk(x,y){if(!inBounds(x,y))return false;const t=mapData[y][x];return t!==TILE.wall;}

// Can a spawner/trap be placed on this tile?
function canPlaceOn(gx,gy){
  if(!inBounds(gx,gy)) return false;
  const t=mapData[gy][gx];
  // Only on floor tiles
  return t===TILE.floor;
}

/* ========== SHOP SYSTEM ========== */
function generateShop(){
  if(!run) return;
  const shopDiscount=run.vil.passives&&run.vil.passives.shopDiscount||0;
  const pool=[];
  BASE_SPAWNER_IDS.forEach(t=>{
    const d=SPAWNER_DEFS[t];
    pool.push({id:uid(),tile:t,sold:false,cost:d.cost});
  });
  if(run.stage>=3){
    [TILE.es1,TILE.es2,TILE.es3].forEach(t=>{
      const d=SPAWNER_DEFS[t];
      pool.push({id:uid(),tile:t,sold:false,cost:d.cost});
    });
  }
  const trapPool=[
    {tile:TILE.trap,name:'í”¼í•´ í•¨ì •',cost:2},{tile:TILE.poison,name:'ë… í•¨ì •',cost:2},
    {tile:TILE.frosttrap,name:'ë¹™ê²° í•¨ì •',cost:3},{tile:TILE.stuntrap,name:'ìŠ¤í„´ í•¨ì •',cost:3},
  ];
  trapPool.forEach(tp=>{pool.push({id:uid(),tile:tp.tile,sold:false,cost:tp.cost});});
  const shuffled=shuffle(pool);
  run.shop=shuffled.slice(0,5);
  /* v8.2 PASSIVE: shop discount */
  if(shopDiscount>0){for(const c of run.shop){c.cost=Math.max(1,c.cost-shopDiscount);}}
}

function rerollShop(){
  if(!run||run.gold<run.rerollCost) return;
  run.gold-=run.rerollCost;
  generateShop();
  refreshAllUI();
}

function buyCard(shopIdx){
  if(!run) return;
  const item=run.shop[shopIdx];
  if(!item||item.sold) return;
  if(run.gold<item.cost) return;
  run.gold-=item.cost;
  item.sold=true;
  addToBench(item.tile);
  refreshAllUI();
}

function addToBench(tile){
  const existing=run.bench.find(b=>b.tile===tile);
  if(existing) existing.count++;
  else run.bench.push({id:uid(),tile,count:1});
  checkMerge(tile);
}

function sellFromBench(tile){
  if(!run) return;
  const item=run.bench.find(b=>b.tile===tile);
  if(!item||item.count<=0) return;
  item.count--;
  if(item.count<=0) run.bench=run.bench.filter(b=>b.count>0);
  const def=SPAWNER_DEFS[tile];
  const refund=def?Math.max(1,Math.floor(def.cost/2)):1;
  run.gold+=refund;
  refreshAllUI();
}

/* ========== 3-MERGE EVOLUTION (bench + placed) ========== */
let pendingMerge=null;

function getTotalCount(tile){
  const benchCount=(run.bench.find(b=>b.tile===tile)?.count)||0;
  const placedCount=getPlacedSpawners().filter(p=>p.t===tile).length;
  return benchCount+placedCount;
}

function checkMerge(tile){
  const def=SPAWNER_DEFS[tile];
  if(!def||!def.evolutions||def.evolutions.length===0) return;
  const total=getTotalCount(tile);
  if(total<3) return;
  pendingMerge={tile,evolutions:def.evolutions};
  openMergePopup();
}

function openMergePopup(){
  if(!pendingMerge) return;
  const popup=document.getElementById('mergePopup');
  const choices=document.getElementById('mergeChoices');
  const sub=document.getElementById('mergeSub');
  const confirm=document.getElementById('mergeConfirm');
  const src=SPAWNER_DEFS[pendingMerge.tile];
  const benchCnt=(run.bench.find(b=>b.tile===pendingMerge.tile)?.count)||0;
  const placedCnt=getPlacedSpawners().filter(p=>p.t===pendingMerge.tile).length;
  sub.textContent=`${src.name} â€” ë²¤ì¹˜ ${benchCnt}ê°œ + ë°°ì¹˜ ${placedCnt}ê°œ = ${benchCnt+placedCnt}ê°œ â†’ ì§„í™” ì„ íƒ`;
  choices.innerHTML='';
  let picked=null;
  pendingMerge.evolutions.forEach(evoTile=>{
    const def=SPAWNER_DEFS[evoTile];
    if(!def) return;
    const d=document.createElement('div');
    d.className='mergeChoice';
    d.innerHTML=`<div class="mcIcon" style="color:${def.color}">${def.icon}</div><div class="mcName">${def.name}</div><div class="mcDesc">${def.desc}</div>`;
    d.onclick=()=>{
      [...choices.children].forEach(c=>c.classList.remove('active'));
      d.classList.add('active');
      picked=evoTile;
      confirm.disabled=false;
    };
    choices.appendChild(d);
  });
  confirm.disabled=true;
  confirm.onclick=()=>{
    if(!picked||!pendingMerge) return;
    // Remove 3 total: first from bench, then from map
    let toRemove=3;
    const bench=run.bench.find(b=>b.tile===pendingMerge.tile);
    if(bench){
      const fromBench=Math.min(bench.count,toRemove);
      bench.count-=fromBench;
      toRemove-=fromBench;
      if(bench.count<=0) run.bench=run.bench.filter(b=>b.count>0);
    }
    // Remove remaining from map
    if(toRemove>0){
      for(let y=0;y<mapH&&toRemove>0;y++){
        for(let x=0;x<mapW&&toRemove>0;x++){
          if(mapData[y][x]===pendingMerge.tile){
            mapData[y][x]=TILE.floor;
            toRemove--;
          }
        }
      }
    }
    // Add evolved to bench
    addToBenchDirect(picked);
    pendingMerge=null;
    popup.style.display='none';
    computeSynergies();
    refreshAllUI();
  };
  popup.style.display='flex';
}

// Cancel merge
document.getElementById('mergeCancel').onclick=()=>{
  pendingMerge=null;
  document.getElementById('mergePopup').style.display='none';
};

function addToBenchDirect(tile){
  const existing=run.bench.find(b=>b.tile===tile);
  if(existing) existing.count++;
  else run.bench.push({id:uid(),tile,count:1});
}

/* ========== SYNERGY COMPUTATION ========== */
function computeSynergies(){
  if(!run) return{};
  const familyCount={};
  const placed=getPlacedSpawners();
  placed.forEach(p=>{
    const def=SPAWNER_DEFS[p.t];
    if(def) familyCount[def.family]=(familyCount[def.family]||0)+1;
  });
  const active={};
  SYNERGY_DEFS.forEach(syn=>{
    const count=familyCount[syn.family]||0;
    let best=null;
    for(const th of syn.thresholds){
      if(count>=th.n) best=th;
    }
    active[syn.id]={count,threshold:best,def:syn};
  });
  run.activeSynergies=active;
  return active;
}

/* ========== PLACEMENT SYSTEM (free placement on floor) ========== */
let selectedBenchTile=null;

function placeOnFloor(gx,gy){
  if(!run||!selectedBenchTile) return;
  if(!canPlaceOn(gx,gy)) return;
  const bench=run.bench.find(b=>b.tile===selectedBenchTile);
  if(!bench||bench.count<=0) return;
  mapData[gy][gx]=selectedBenchTile;
  bench.count--;
  if(bench.count<=0) run.bench=run.bench.filter(b=>b.count>0);
  selectedBenchTile=null;
  computeSynergies();
  refreshAllUI();
}

function removeSpawnerFromMap(gx,gy){
  const t=mapData[gy][gx];
  if(!SPAWNER_IDS.includes(t)&&!TRAP_IDS.includes(t)) return;
  mapData[gy][gx]=TILE.floor;
  addToBenchDirect(t);
  computeSynergies();
  // Check if this triggers merge now that we added to bench
  // (unlikely but possible)
  refreshAllUI();
}

/* ========== SETTINGS ========== */
const SETTING_IDS=['sessionLimit','spawnBase','eliteRange','mobSpeed','bulletSpeed','spawnerHP','eliteHpMul','separateStrength','aggroRange',
  'vMeteorDmg','vMeteorCd','vMeteorCost','vMeteorR','vFrostDur','vFrostCd','vFrostCost','vFrostR',
  'vCurseDmg','vCurseDur','vCurseCost','vCurseR','vWallCost','vWallCd','vBuffDur','vBuffCost','vBuffR','vBuffCd',
  'wHP','wSpeed','wAtk','wAtkCd','hHP','hSpeed','hAtk','hHealCd','rHP','rSpeed','rAtk','rAtkCd','mgHP','mgSpeed','mgAtk','mgAtkCd'];
function collectSettings(){const o={};SETTING_IDS.forEach(id=>{const el=document.getElementById(id);if(el)o[id]=el.type==='number'?+el.value:el.value;});return o;}

/* ========== HERO SELECTION ========== */
const HERO_DEFS=[
  {kind:'warrior',icon:'â˜…',label:'âš”ï¸ ì „ì‚¬',color:'#ffffff',role:'tank'},
  {kind:'healer',icon:'âœš',label:'ğŸ’š íëŸ¬',color:'#22c55e',role:'support'},
  {kind:'ranger',icon:'âœ¦',label:'ğŸ¹ ì›ë”œ',color:'#60a5fa',role:'dps'},
  {kind:'mage',icon:'â—ˆ',label:'ğŸ”® ë§ˆë²•ì‚¬',color:'#c084fc',role:'dps'},
];
let heroSelection={warrior:true,healer:true,ranger:true,mage:true};
function buildHeroSelect(){
  const w=document.getElementById('heroSelect');w.innerHTML='';
  HERO_DEFS.forEach(h=>{
    const d=document.createElement('div');
    d.className='heroChip'+(heroSelection[h.kind]?' on':'');
    d.textContent=h.label;
    d.onclick=()=>{heroSelection[h.kind]=!heroSelection[h.kind];if(!Object.values(heroSelection).some(v=>v))heroSelection[h.kind]=true;buildHeroSelect();};
    w.appendChild(d);
  });
}
buildHeroSelect();

/* ========== MOB TYPES & STATS ========== */
const MobType={melee:'melee',melee_skill:'melee_skill',melee_dash:'melee_dash',ranged:'ranged',ranged_skill:'ranged_skill',ranged_snipe:'ranged_snipe',healer:'healer',healer_skill:'healer_skill',healer_cleanse:'healer_cleanse',bomber:'bomber',splitter:'splitter',frostbomber:'frostbomber',chrono:'chrono',chronoBoost:'chronoBoost',chronoStop:'chronoStop',eliteA:'eliteA',eliteB:'eliteB',eliteC:'eliteC',slime:'slime',slime_split:'slime_split',slime_king:'slime_king',hybrid_sword:'hybrid_sword',hybrid_poison:'hybrid_poison',hybrid_timeslime:'hybrid_timeslime'};
function spawnerToMob(t){return{[TILE.s1]:MobType.melee,[TILE.s11]:MobType.melee_skill,[TILE.s12]:MobType.melee_dash,[TILE.s2]:MobType.ranged,[TILE.s21]:MobType.ranged_skill,[TILE.s22]:MobType.ranged_snipe,[TILE.s3]:MobType.healer,[TILE.s31]:MobType.healer_skill,[TILE.s32]:MobType.healer_cleanse,[TILE.s4]:MobType.bomber,[TILE.s41]:MobType.splitter,[TILE.s42]:MobType.frostbomber,[TILE.s5]:MobType.chrono,[TILE.s51]:MobType.chronoBoost,[TILE.s52]:MobType.chronoStop,[TILE.es1]:MobType.eliteA,[TILE.es2]:MobType.eliteB,[TILE.es3]:MobType.eliteC,[TILE.s6]:MobType.slime,[TILE.s61]:MobType.slime_split,[TILE.s62]:MobType.slime_king,[TILE.fs1]:MobType.hybrid_sword,[TILE.fs2]:MobType.hybrid_poison,[TILE.fs3]:MobType.hybrid_timeslime}[t]||MobType.melee;}
function mobBaseStats(type,s){
  const spd=s.mobSpeed;const base={hp:30,speed:spd,atk:6,atkCd:1.2,bullet:false,bulletDmg:6,bulletCd:1.4,bulletRange:260,pierce:0,heal:0};
  const d={
    [MobType.melee]:{...base,hp:34,speed:spd,atk:7,atkCd:1.05},
    [MobType.melee_skill]:{...base,hp:42,speed:spd*.95,atk:8,atkCd:1.1},
    [MobType.melee_dash]:{...base,hp:36,speed:spd*1.05,atk:7,atkCd:1.05},
    [MobType.ranged]:{...base,hp:28,speed:spd*.9,bullet:true,bulletDmg:7,bulletCd:1.4,bulletRange:320},
    [MobType.ranged_skill]:{...base,hp:32,speed:spd*.9,bullet:true,bulletDmg:6,bulletCd:1.3,bulletRange:320,pierce:1},
    [MobType.ranged_snipe]:{...base,hp:26,speed:spd*.85,bullet:true,bulletDmg:10,bulletCd:2,bulletRange:440},
    [MobType.healer]:{...base,hp:30,speed:spd*.92,heal:3},
    [MobType.healer_skill]:{...base,hp:34,speed:spd*.9,heal:4},
    [MobType.healer_cleanse]:{...base,hp:36,speed:spd*.9,heal:5},
    [MobType.bomber]:{...base,hp:22,speed:spd*1.05},
    [MobType.splitter]:{...base,hp:26,speed:spd},
    [MobType.frostbomber]:{...base,hp:24,speed:spd},
    [MobType.chrono]:{...base,hp:35,speed:spd*.88,atk:5,atkCd:1.3},
    [MobType.chronoBoost]:{...base,hp:32,speed:spd*.9,atk:4,atkCd:1.4},
    [MobType.chronoStop]:{...base,hp:38,speed:spd*.82,atk:6,atkCd:1.5},
    [MobType.eliteA]:{...base,hp:90*s.eliteHpMul,speed:spd*.95,atk:12,atkCd:.9,bullet:true,bulletDmg:12,bulletCd:1.1,bulletRange:460,pierce:2},
    [MobType.eliteB]:{...base,hp:80*s.eliteHpMul,speed:spd,atk:10,atkCd:1,bullet:true,bulletDmg:9,bulletCd:.85,bulletRange:400},
    [MobType.eliteC]:{...base,hp:100*s.eliteHpMul,speed:spd*.85,atk:14,atkCd:1.2,bullet:true,bulletDmg:11,bulletCd:1,bulletRange:380},
    [MobType.slime]:{...base,hp:20,speed:spd*1.1,atk:4,atkCd:1},
    [MobType.slime_split]:{...base,hp:28,speed:spd*1.05,atk:5,atkCd:1},
    [MobType.slime_king]:{...base,hp:65,speed:spd*.7,atk:9,atkCd:1.1,radius:16},
    [MobType.hybrid_sword]:{...base,hp:40,speed:spd,atk:8,atkCd:1,bullet:true,bulletDmg:6,bulletCd:1.6,bulletRange:280},
    [MobType.hybrid_poison]:{...base,hp:30,speed:spd*1.05,atk:6,atkCd:1.1},
    [MobType.hybrid_timeslime]:{...base,hp:35,speed:spd*.85,atk:5,atkCd:1.2},
  };
  const out=(d[type]||base);
  const mh=s._mobHpMul||1, ma=s._mobAtkMul||1, ms=s._mobSpdMul||1, mb=s._mobBulletMul||1;
  out.hp*=mh; out.speed*=ms; out.atk*=ma; out.bulletDmg*=mb;
  return out;
}
function mobColor(t){return{[MobType.melee]:'#fecaca',[MobType.melee_skill]:'#fb7185',[MobType.melee_dash]:'#f43f5e',[MobType.ranged]:'#fde68a',[MobType.ranged_skill]:'#fbbf24',[MobType.ranged_snipe]:'#f59e0b',[MobType.healer]:'#86efac',[MobType.healer_skill]:'#4ade80',[MobType.healer_cleanse]:'#22c55e',[MobType.bomber]:'#c084fc',[MobType.splitter]:'#a855f7',[MobType.frostbomber]:'#93c5fd',[MobType.chrono]:'#818cf8',[MobType.chronoBoost]:'#a78bfa',[MobType.chronoStop]:'#c4b5fd',[MobType.eliteA]:'#1e293b',[MobType.eliteB]:'#1e293b',[MobType.eliteC]:'#1e293b',[MobType.slime]:'#86efac',[MobType.slime_split]:'#4ade80',[MobType.slime_king]:'#22c55e',[MobType.hybrid_sword]:'#fbbf24',[MobType.hybrid_poison]:'#d8b4fe',[MobType.hybrid_timeslime]:'#a5b4fc'}[t]||'#fff';}

/* ========== BFS PATHFINDING ========== */
function bfsDistFrom(start){
  const dist=new Int32Array(mapW*mapH).fill(-1);
  const q=[[start.x,start.y]];dist[start.y*mapW+start.x]=0;let qi=0;
  while(qi<q.length){const[cx,cy]=q[qi++];const d=dist[cy*mapW+cx];
    for(const[dx,dy]of[[1,0],[-1,0],[0,1],[0,-1]]){const nx=cx+dx,ny=cy+dy;
      if(!inBounds(nx,ny))continue;if(dist[ny*mapW+nx]>=0)continue;if(!isWalk(nx,ny))continue;
      dist[ny*mapW+nx]=d+1;q.push([nx,ny]);}}
  return dist;
}
function bfsPath(start,goalFn){
  const parent=new Map();const q=[[start.x,start.y]];parent.set(start.x+','+start.y,null);
  while(q.length){const[cx,cy]=q.shift();
    if(goalFn(cx,cy)){const path=[];let c={x:cx,y:cy};while(c){path.unshift(c);const p=parent.get(c.x+','+c.y);c=p;}return path.slice(1);}
    for(const[dx,dy]of[[1,0],[-1,0],[0,1],[0,-1]]){const nx=cx+dx,ny=cy+dy;const k=nx+','+ny;
      if(!inBounds(nx,ny)||parent.has(k)||!isWalk(nx,ny))continue;
      parent.set(k,{x:cx,y:cy});q.push([nx,ny]);}}
  return null;
}

/* ========== COORDINATE HELPERS ========== */
function cellToWorld(gx,gy,cs,ox,oy){return{x:ox+gx*cs+cs/2,y:oy+gy*cs+cs/2};}
function worldToCell(wx,wy,cs,ox,oy){return{x:Math.floor((wx-ox)/cs),y:Math.floor((wy-oy)/cs)};}
function wallClamp(st,ent){
  /* v8.2: strict 4-corner + center check */
  const r=ent.radius||8;
  const pts=[[ent.x,ent.y],[ent.x-r,ent.y-r],[ent.x+r,ent.y-r],[ent.x-r,ent.y+r],[ent.x+r,ent.y+r]];
  for(const[px,py] of pts){
    const g=worldToCell(px,py,st.cs,st.ox,st.oy);
    if(!inBounds(g.x,g.y)||mapData[g.y][g.x]===TILE.wall){
      const cx=st.ox+(g.x)*st.cs+st.cs/2,cy=st.oy+(g.y)*st.cs+st.cs/2;
      const dx=ent.x-cx,dy=ent.y-cy;
      if(Math.abs(dx)>=Math.abs(dy)){ent.x=dx>0?st.ox+(g.x+1)*st.cs+r+1:st.ox+g.x*st.cs-r-1;}
      else{ent.y=dy>0?st.oy+(g.y+1)*st.cs+r+1:st.oy+g.y*st.cs-r-1;}
    }
  }
  /* clamp to map bounds */
  const minX=st.ox+r+2,maxX=st.ox+mapW*st.cs-r-2;
  const minY=st.oy+r+2,maxY=st.oy+mapH*st.cs-r-2;
  ent.x=clamp(ent.x,minX,maxX);ent.y=clamp(ent.y,minY,maxY);
}
function sampleSafePoint(st,mx,my,hx,hy,desired){
  const angles=[0,.5,1,1.5,2,2.5,3,3.5,4,4.5,5,5.5].map(a=>a*Math.PI/3);
  let best=null,bestScore=-1e9;
  const base=Math.atan2(my-hy,mx-hx);
  for(const a of angles){const ang=base+a;
    const tx=mx+Math.cos(ang)*desired,ty=my+Math.sin(ang)*desired;
    const g=worldToCell(tx,ty,st.cs,st.ox,st.oy);
    if(!inBounds(g.x,g.y)||!isWalk(g.x,g.y))continue;
    const score=dist2(tx,ty,hx,hy);
    if(score>bestScore){bestScore=score;best={x:tx,y:ty};}
  }
  return best;
}

/* ========== FX SYSTEM ========== */
function fxCircle(st,x,y,r,c,l=.35,w=2){st.fx.push({k:'circle',x,y,r,c,life:l,t:0,w});}
function fxShock(st,x,y,r,c,l=.5){st.fx.push({k:'shock',x,y,r,c,life:l,t:0});}
function fxText(st,x,y,txt,c='#fff',l=.8,ol='#000'){st.fx.push({k:'text',x,y,txt,c,life:l,t:0,ol});}
function fxLine(st,x1,y1,x2,y2,c='#fff',l=.18,w=2){st.fx.push({k:'line',x1,y1,x2,y2,c,life:l,t:0,w});}
function fxSparks(st,x,y,n,c,l=.35,sp=260){for(let i=0;i<n;i++){const a=rand(0,Math.PI*2);st.fx.push({k:'spark',x,y,vx:Math.cos(a)*rand(sp*.4,sp),vy:Math.sin(a)*rand(sp*.4,sp),c,life:l,t:0});}}
function fxBurst(st,x,y,r,c){fxShock(st,x,y,r,c,.55);fxCircle(st,x,y,r*.9,c,.35,3);fxSparks(st,x,y,16,c,.4,300);}

const skillLogEl=document.getElementById('skillLog');let logLines=[];
function logSkill(m){logLines.unshift(m);if(logLines.length>12)logLines.length=12;skillLogEl.innerHTML=logLines.map(x=>`<div class="logLine">â€¢ <b>${x}</b></div>`).join('');}

/* ========== VILLAIN SKILLS ========== */
let selectedCastSkill=null;
function getVillainSkills(s){return[
  {id:'meteor',name:'Meteor',cost:s.vMeteorCost,cd:s.vMeteorCd,r:s.vMeteorR,dmg:s.vMeteorDmg,desc:`${s.vMeteorDmg}dmg`},
  {id:'frostnova',name:'Frost Nova',cost:s.vFrostCost,cd:s.vFrostCd,r:s.vFrostR,dur:s.vFrostDur,desc:`ìŠ¬ë¡œìš° ${s.vFrostDur}s`},
  {id:'curse',name:'Curse',cost:s.vCurseCost,cd:10,r:s.vCurseR,dmg:s.vCurseDmg,dur:s.vCurseDur,desc:`í‹±${s.vCurseDmg} ${s.vCurseDur}s`},
  {id:'wall',name:'Wall',cost:s.vWallCost,cd:s.vWallCd,r:0,desc:'ì„ì‹œ ë²½'},
  {id:'buff',name:'Buff',cost:s.vBuffCost,cd:s.vBuffCd,r:s.vBuffR,dur:s.vBuffDur,desc:`ëª¹ ê°•í™” ${s.vBuffDur}s`},
  {id:'fear',name:'Fear',cost:30,cd:12,r:120,dur:2.2,desc:'ê³µí¬ 2.2s'},
  {id:'overclock',name:'Overclock',cost:35,cd:16,dur:6,desc:'ì „ì²´ ëª¹ ë²„í”„ 6s',target:'none'},
];}
function buildVillainCards(){
  const w=document.getElementById('villainCards');w.innerHTML='';const s=collectSettings();
  const skills=getVillainSkills(s);
  skills.forEach(sk=>{
    const d=document.createElement('div');d.className='card';
    d.innerHTML=`<div class="cardTop"><div style="font-weight:900">${sk.name}</div><span class="badge">${sk.cost}E</span></div><div class="muted" style="margin-top:4px">${sk.desc} CD${sk.cd}s</div><div class="bar" style="margin-top:6px"><div id="cdbar-${sk.id}"></div></div>`;
    d.onclick=()=>{
      if(!game||!game.running||game.paused||game.ended)return;
      if(sk.target==='none'){castVillainSkill(game,sk,game.castle.x,game.castle.y);selectedCastSkill=null;[...w.children].forEach(c=>c.classList.remove('active'));return;}
      selectedCastSkill=(selectedCastSkill?.id===sk.id)?null:sk;
      [...w.children].forEach(c=>c.classList.remove('active'));
      if(selectedCastSkill)d.classList.add('active');
    };
    w.appendChild(d);
  });
}

function castVillainSkill(st,sk,x,y){
  const v=st.villain;
  if((v.cds[sk.id]||0)>0||v.energy<sk.cost) return;
  v.energy-=sk.cost; const cdR=run&&run.vil&&run.vil.passives&&run.vil.passives.cdReduction||0;v.cds[sk.id]=sk.cd*(1-Math.min(cdR,0.6));
  if(sk.id==='meteor'){
    const mp=run&&run.vil&&run.vil.passives||{};
    const mR=mp.meteorBoost?sk.r*1.3:sk.r;const mD=mp.meteorBoost?sk.dmg*1.5:sk.dmg;
    fxBurst(st,x,y,mR,'rgba(239,68,68,.95)');
    for(const h of st.heroes){if(h.dead)continue;if(dist2(x,y,h.x,h.y)<=mR*mR){heroTakeDmg(st,h,mD,'boss');fxText(st,h.x,h.y-10,`-${mD|0}`,'#fecaca',.55,'#7f1d1d');}}
    st.shakeT=.25;st.shakePow=6;
  }
  if(sk.id==='frostnova'){
    fxBurst(st,x,y,sk.r,'rgba(96,165,250,.95)');
    for(const h of st.heroes){if(h.dead)continue;if(dist2(x,y,h.x,h.y)<=sk.r*sk.r){h.slowT=Math.max(h.slowT,sk.dur);fxText(st,h.x,h.y-12,'SLOW','#93c5fd',.7);}}
  }
  if(sk.id==='curse'){const cp=run&&run.vil&&run.vil.passives||{};
    const cLife=cp.curseAmp?sk.dur*2:sk.dur;const cDmg=cp.curseAmp?sk.dmg*1.3:sk.dmg;
    st.fx.push({k:'zone',x,y,r:sk.r,c:'rgba(168,85,247,.22)',life:cLife,t:0,tick:0,tag:'curse',dmg:cDmg});}
  if(sk.id==='wall'){const g=worldToCell(x,y,st.cs,st.ox,st.oy);if(inBounds(g.x,g.y)&&mapData[g.y][g.x]!==TILE.entrance&&mapData[g.y][g.x]!==TILE.castle){st.battleWalls.push({x:g.x,y:g.y,prev:mapData[g.y][g.x]});mapData[g.y][g.x]=TILE.wall;fxBurst(st,st.ox+g.x*st.cs+st.cs/2,st.oy+g.y*st.cs+st.cs/2,40,'rgba(255,255,255,.9)');st.repathAll=true;}}
  if(sk.id==='fear'){fxBurst(st,x,y,sk.r,'rgba(244,63,94,.90)');for(const h of st.heroes){if(h.dead)continue;if(dist2(x,y,h.x,h.y)<=sk.r*sk.r){h.stunT=Math.max(h.stunT,sk.dur);fxText(st,h.x,h.y-12,'FEAR','#fda4af',.7);}}st.shakeT=.15;st.shakePow=4;}
  if(sk.id==='overclock'){fxText(st,st.castle.x,st.castle.y-26,'OVERCLOCK!','#86efac',1.0,'#052e16');for(const m of st.mobs){if(m.alive)m.buffT=Math.max(m.buffT,sk.dur);}}
  if(sk.id==='buff'){fxBurst(st,x,y,sk.r,'rgba(34,197,94,.95)');for(const m of st.mobs){if(m.alive&&dist2(x,y,m.x,m.y)<=sk.r*sk.r)m.buffT=Math.max(m.buffT,sk.dur);}}
}

/* ========== DAMAGE / COMBAT ========== */
function heroTakeDmg(st,h,d,src,attackerMob){
  src=src||'mob';
  if(h.dead)return;
  const aa=run&&run.adaptActive;
  /* v8.2 BULLET DODGE */
  if(src==='bullet'&&aa&&aa.bullet&&aa.bullet.dodgeChance){
    if(Math.random()<aa.bullet.dodgeChance){fxText(st,h.x,h.y-18,'DODGE!','#60a5fa',.6);return;}
  }
  /* v8.2 AOE AUTO-SHIELD */
  if(src==='aoe'&&aa&&aa.aoe&&aa.aoe.autoShieldProc){
    if(h.shieldT<=0&&Math.random()<aa.aoe.autoShieldProc){h.shieldT=1.5;fxBurst(st,h.x,h.y,25,'rgba(96,165,250,.6)');fxText(st,h.x,h.y-20,'ğŸ›¡','#60a5fa',.5);}
  }
  if(h.shieldT>0)d*=.45;
  /* v8.2 adaptive resistance */
  if(aa&&aa[src]){d*=(1-aa[src].reduction);}
  /* v8.2 BOSS CC RESIST (reduce stun/freeze applied alongside damage) */
  if(src==='boss'&&aa&&aa.boss&&aa.boss.ccResist){
    const ccR=aa.boss.ccResist;
    h.stunT*=(1-ccR);h.frozenT*=(1-ccR);
  }
  h.hp-=d;
  /* v8.2 MOB THORNS (reflect damage back) */
  if(src==='mob'&&aa&&aa.mob&&aa.mob.thorns&&attackerMob&&attackerMob.alive){
    const thornsDmg=aa.mob.thorns;
    attackerMob.hp-=thornsDmg;
    fxText(st,attackerMob.x,attackerMob.y-8,`ğŸŒµ-${thornsDmg|0}`,'#f59e0b',.4);
    if(attackerMob.hp<=0)killMob(st,attackerMob,'thorns');
  }
  if(h.hp<=0){h.hp=0;h.dead=true;fxText(st,h.x,h.y,'DEAD','#ff6b6b',1,'#000');
    if(run&&run.adapt){run.adapt[src]=(run.adapt[src]||0)+1;computeAdaptations();}
    /* v8.2 PASSIVE: hero bounty */
    if(run&&run.vil&&run.vil.passives&&run.vil.passives.heroBounty){run.gold+=(run.vil.passives.heroBounty);fxText(st,h.x,h.y-22,`+${run.vil.passives.heroBounty}G`,'#fbbf24',.7);}
  }
}
function killHeroCheck(st,h){/* v8.2: now handled in heroTakeDmg */}
function heroTrapCheck(st,h,dt){
  const g=worldToCell(h.x,h.y,st.cs,st.ox,st.oy);if(!inBounds(g.x,g.y))return;const t=mapData[g.y][g.x];
  const aa=run&&run.adaptActive;
  /* v8.2 TRAP SENSE: nudge hero away from nearby traps */
  if(aa&&aa.trap&&aa.trap.trapSenseRange){
    const sense=aa.trap.trapSenseRange;
    for(const[dx,dy]of[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,1],[1,-1],[-1,-1]]){
      const nx=g.x+dx,ny=g.y+dy;
      if(inBounds(nx,ny)&&TRAP_IDS.includes(mapData[ny][nx])){
        const tw=cellToWorld(nx,ny,st.cs,st.ox,st.oy);
        const dd=Math.hypot(h.x-tw.x,h.y-tw.y);
        if(dd<sense){const[vx,vy]=norm(h.x-tw.x,h.y-tw.y);h.x+=vx*1.5;h.y+=vy*1.5;}
      }
    }
  }
  h.trapT=(h.trapT||0)-dt;if(h.trapT>0)return;
  if(t===TILE.trap){h.trapT=.55;heroTakeDmg(st,h,10*(st.s._trapBoost||1),'trap');fxBurst(st,h.x,h.y,32,'rgba(251,191,36,.95)');}
  else if(t===TILE.poison){
    /* v8.2 POISON AUTO-CLEANSE */
    if(aa&&aa.poison&&aa.poison.autoCleanseProc&&Math.random()<aa.poison.autoCleanseProc){
      h.trapT=.8;h.poisonT=0;fxText(st,h.x,h.y-14,'CLEANSE!','#22c55e',.8);fxBurst(st,h.x,h.y,28,'rgba(34,197,94,.6)');
    }else{h.trapT=.8;h.poisonT=Math.max(h.poisonT,4);fxText(st,h.x,h.y-14,'POISON','#a3e635',.8);}
  }
  else if(t===TILE.frosttrap){h.trapT=.9;h.slowT=Math.max(h.slowT,3*(st.s._trapBoost||1));fxText(st,h.x,h.y-14,'SLOW','#38bdf8',.8);}
  else if(t===TILE.stuntrap){
    let stunDur=.8;
    /* v8.2 BOSS CC RESIST also affects trap stun */
    if(aa&&aa.boss&&aa.boss.ccResist)stunDur*=(1-aa.boss.ccResist);
    h.trapT=1.2;h.stunT=Math.max(h.stunT,stunDur);fxText(st,h.x,h.y-14,'STUN','#f472b6',.8);
  }
}

function spawnBullet(st,x1,y1,x2,y2,dmg,owner,speed,pierce,color){const[vx,vy]=norm(x2-x1,y2-y1);st.bullets.push({id:uid(),owner,x:x1,y:y1,vx,vy,speed,dmg,pierce,alive:true,life:2.5,c:color||'rgba(255,255,255,.9)'});}

function spawnMobAt(st,sp){
  const type=spawnerToMob(sp.tile);
  const isElite=sp.tile===TILE.es1||sp.tile===TILE.es2||sp.tile===TILE.es3;
  if(isElite&&sp.eliteAliveId&&st.mobs.some(m=>m.alive&&m.id===sp.eliteAliveId))return;
  let alive=0;for(const m of st.mobs){if(m.alive&&m.spawnerId===sp.id)alive++;}
  const baseCap=isElite?1:8;const p2=run&&run.vil&&run.vil.passives||{};const cap=baseCap+(isElite?0:(st.s._mobCapBonus||0))-(p2.sacrifice?2:0);
  if(alive>=cap)return;
  const stt=mobBaseStats(type,st.s);
  const p=run&&run.vil&&run.vil.passives||{};
  let hp=stt.hp,spd=stt.speed,atk=stt.atk,radius=isElite?18:10;
  /* v8.2 PASSIVE: giantElite */
  if(isElite&&p.giantElite){hp*=1.5;radius=Math.min(24,radius*1.3);}
  const m={id:uid(),type,x:sp.x+rand(-6,6),y:sp.y+rand(-6,6),spawnX:sp.x,spawnY:sp.y,
    hp,maxHp:hp,speed:spd,atk,atkCd:stt.atkCd,atkT:rand(0,stt.atkCd),
    bullet:stt.bullet,bulletDmg:stt.bulletDmg,bulletCd:stt.bulletCd,bulletT:rand(0,stt.bulletCd),bulletRange:stt.bulletRange,pierce:stt.pierce,heal:stt.heal,
    alive:true,slowT:0,poisonT:0,buffT:0,markT:0,dashT:0,dashCd:rand(1.5,3),skillT:rand(1,2.5),
    e1:rand(1.8,3.2),e2:rand(2.8,4.5),e3:rand(3,5),
    radius,spawnerId:sp.id,tauntTarget:null,aggrod:false,path:[],repathT:0,_revived:false,
  };
  /* v8.2 PASSIVE: giantElite slow immune */
  if(isElite&&p.giantElite)m._slowImmune=true;
  st.mobs.push(m);if(isElite)sp.eliteAliveId=m.id;
}

function killMob(st,m,reason){
  if(!m.alive)return;m.alive=false;fxText(st,m.x,m.y-12,'KO','#fff',.5,'#000');
  /* v8.2 AWAKENING: midas touch â€” gold on kill */
  if(run&&run.vil&&run.vil.passives.midasTouch){
    run.gold=(run.gold||0)+1;fxText(st,m.x,m.y-24,'+1G','#fbbf24',.4);
  }
  /* v8.2 SPAWNER MASTERY TRACKING */
  if(run&&run.mastery){
    const familyMap={melee:'melee',melee_skill:'melee',ranged:'ranged',poison:'poison',
      bomber:'bomb',splitter:'bomb',frostbomber:'bomb',dasher:'speed',
      slime:'slime',slime_split:'slime',slime_king:'slime',
      hybrid_sword:'melee',hybrid_poison:'poison',hybrid_timeslime:'slime',
      eliteA:'melee',eliteB:'ranged',eliteC:'bomb'};
    const fam=familyMap[m.type];
    if(fam){
      if(!run.mastery[fam])run.mastery[fam]={kills:0,level:0};
      run.mastery[fam].kills++;
      /* check level up */
      const def=MASTERY_FAMILIES[fam];
      if(def){
        const lvl=run.mastery[fam].level;
        if(lvl<def.levels.length&&run.mastery[fam].kills>=def.levels[lvl].req){
          run.mastery[fam].level++;
          const reward=def.levels[lvl];
          run.vil.passives[reward.key]=reward.val;
          /* visual feedback would be nice but skip for now */
        }
      }
    }
  }
  if(m.type===MobType.bomber||m.type===MobType.splitter||m.type===MobType.frostbomber){
    const isSplit=m.type===MobType.splitter;const r=isSplit?60:55;const dmg=isSplit?7:14;
    fxBurst(st,m.x,m.y,r,'rgba(168,85,247,.95)');
    for(const h of st.heroes){if(h.dead)continue;if(dist2(m.x,m.y,h.x,h.y)<=r*r){heroTakeDmg(st,h,dmg,'aoe');if(m.type===MobType.frostbomber){h.frozenT=Math.max(h.frozenT,1.4);}}}
    if(isSplit){for(let i=0;i<2;i++){const stt=mobBaseStats(MobType.bomber,st.s);st.mobs.push({id:uid(),type:MobType.bomber,x:m.x+rand(-12,12),y:m.y+rand(-12,12),spawnX:m.x,spawnY:m.y,hp:stt.hp*.55,maxHp:stt.hp*.55,speed:stt.speed*1.15,atk:stt.atk,atkCd:stt.atkCd,atkT:rand(0,stt.atkCd),bullet:false,bulletDmg:0,bulletCd:0,bulletT:0,bulletRange:0,pierce:0,heal:0,alive:true,slowT:0,poisonT:0,buffT:0,markT:0,dashT:0,dashCd:99,skillT:99,e1:99,e2:99,e3:99,radius:10,tauntTarget:null,aggrod:true,path:[],repathT:0});}}
  }
  if(m.type===MobType.eliteA||m.type===MobType.eliteB||m.type===MobType.eliteC){
    const sp=st.spawners.find(s=>s.id===m.spawnerId);if(sp&&sp.eliteAliveId===m.id)sp.eliteAliveId=null;
    fxBurst(st,m.x,m.y,110,'rgba(255,255,255,.85)');st.shakeT=.35;st.shakePow=8;
  }
  /* v8.2 SLIME SPLITTING */
  if((m.type===MobType.slime||m.type===MobType.slime_split)&&!m.isBabySlime){
    const splitCount=(m.type===MobType.slime_split)?3:2;
    let bonus=0;if(run&&run.activeSynergies){const sl=run.activeSynergies.slime||0;bonus=(sl>=4)?2:(sl>=2)?1:0;}
    const total=splitCount+bonus;
    for(let i=0;i<total;i++){
      const baby={id:uid(),type:MobType.slime,x:m.x+rand(-14,14),y:m.y+rand(-14,14),spawnX:m.x,spawnY:m.y,
        hp:m.maxHp*.45,maxHp:m.maxHp*.45,speed:m.speed*1.2,atk:m.atk*.7,atkCd:1,atkT:rand(0,1),
        bullet:false,bulletDmg:0,bulletCd:0,bulletT:0,bulletRange:0,pierce:0,heal:0,
        alive:true,slowT:0,poisonT:0,buffT:0,markT:0,dashT:0,dashCd:99,skillT:99,e1:99,e2:99,e3:99,
        radius:6,tauntTarget:null,aggrod:true,path:[],repathT:0,isBabySlime:true};
      st.mobs.push(baby);
    }
    fxBurst(st,m.x,m.y,40,'rgba(134,239,172,.95)');
  }
  /* v8.2 KING SLIME DEATH */
  if(m.type===MobType.slime_king){
    const r=100;fxBurst(st,m.x,m.y,r,'rgba(34,197,94,.95)');
    for(const h of st.heroes){if(h.dead)continue;if(dist2(m.x,m.y,h.x,h.y)<=r*r){heroTakeDmg(st,h,8,'aoe');h.slowT=Math.max(h.slowT,3);}}
  }
  /* v8.2 HYBRID POISON BOMBER DEATH */
  if(m.type===MobType.hybrid_poison){
    const r=55;fxBurst(st,m.x,m.y,r,'rgba(163,230,53,.95)');
    st.fx.push({k:'zone',x:m.x,y:m.y,r:r,c:'rgba(163,230,53,.3)',life:4,t:0,tick:0,tag:'poison_zone'});
    for(const h of st.heroes){if(h.dead)continue;if(dist2(m.x,m.y,h.x,h.y)<=r*r){h.poisonT=Math.max(h.poisonT,4);}}
  }
  /* v8.2 HYBRID TIME SLIME DEATH */
  if(m.type===MobType.hybrid_timeslime&&!m.isBabySlime){
    const r=60;fxBurst(st,m.x,m.y,r,'rgba(165,180,252,.95)');
    for(const h of st.heroes){if(h.dead)continue;if(dist2(m.x,m.y,h.x,h.y)<=r*r){h.slowT=Math.max(h.slowT,3);}}
    /* also split */
    for(let i=0;i<2;i++){
      const baby={id:uid(),type:MobType.hybrid_timeslime,x:m.x+rand(-14,14),y:m.y+rand(-14,14),spawnX:m.x,spawnY:m.y,
        hp:m.maxHp*.4,maxHp:m.maxHp*.4,speed:m.speed*1.15,atk:m.atk*.6,atkCd:1.2,atkT:rand(0,1.2),
        bullet:false,bulletDmg:0,bulletCd:0,bulletT:0,bulletRange:0,pierce:0,heal:0,
        alive:true,slowT:0,poisonT:0,buffT:0,markT:0,dashT:0,dashCd:99,skillT:99,e1:99,e2:99,e3:99,
        radius:6,tauntTarget:null,aggrod:true,path:[],repathT:0,isBabySlime:true};
      st.mobs.push(baby);
    }
  }

  /* v8.2 AWAKENING: necromancer â€” dead mobs spawn skeleton */
  if(run&&run.vil&&run.vil.passives.necromancer&&Math.random()<run.vil.passives.necromancer
    &&!m.isBabySlime&&!m._isSplitChild&&!m._isNecro){
    const stt=mobBaseStats(MobType.melee,st.s);
    const skel={id:uid(),type:MobType.melee,x:m.x+rand(-8,8),y:m.y+rand(-8,8),spawnX:m.x,spawnY:m.y,
      hp:m.maxHp*.6,maxHp:m.maxHp*.6,speed:stt.speed,atk:m.atk*.8,atkCd:stt.atkCd,atkT:rand(0,stt.atkCd),
      bullet:false,bulletDmg:0,bulletCd:0,bulletT:0,bulletRange:0,pierce:0,heal:0,
      alive:true,slowT:0,poisonT:0,buffT:0,markT:0,dashT:0,dashCd:99,skillT:99,e1:99,e2:99,e3:99,
      radius:10,tauntTarget:null,aggrod:true,path:[],repathT:0,_isNecro:true};
    st.mobs.push(skel);fxText(st,m.x,m.y-20,'ğŸ’€RISE','#d4d4d8',.7);
  }
  /* v8.2 PASSIVE: death split â€” non-slime non-elite random mini spawn */
  const kp=run&&run.vil&&run.vil.passives||{};
  if(kp.deathSplit&&!m.isBabySlime&&!m._isSplitChild
    &&m.type!==MobType.slime&&m.type!==MobType.slime_split&&m.type!==MobType.slime_king
    &&m.type!==MobType.eliteA&&m.type!==MobType.eliteB&&m.type!==MobType.eliteC){
    if(Math.random()<kp.deathSplit){
      const stt=mobBaseStats(MobType.melee,st.s);
      const mini={id:uid(),type:MobType.melee,x:m.x+rand(-10,10),y:m.y+rand(-10,10),spawnX:m.x,spawnY:m.y,
        hp:stt.hp*.4,maxHp:stt.hp*.4,speed:stt.speed*1.2,atk:stt.atk*.6,atkCd:1,atkT:rand(0,1),
        bullet:false,bulletDmg:0,bulletCd:0,bulletT:0,bulletRange:0,pierce:0,heal:0,
        alive:true,slowT:0,poisonT:0,buffT:0,markT:0,dashT:0,dashCd:99,skillT:99,e1:99,e2:99,e3:99,
        radius:7,tauntTarget:null,aggrod:true,path:[],repathT:0,_isSplitChild:true};
      st.mobs.push(mini);fxText(st,m.x,m.y-8,'ğŸ§¬SPLIT','#c084fc',.5);
    }
  }
  /* v8.2 PASSIVE: revive â€” chance to come back */
  if(kp.reviveChance&&!m._revived&&!m.isBabySlime&&!m._isSplitChild){
    if(Math.random()<kp.reviveChance){
      m.alive=true;m.hp=m.maxHp*0.3;m._revived=true;
      fxText(st,m.x,m.y-14,'ğŸ’€REVIVE!','#f43f5e',.8);fxBurst(st,m.x,m.y,30,'rgba(244,63,94,.8)');
    }
  }
  /* v8.2 PASSIVE: sacrifice â€” dying mob heals nearby allies, but max mobs reduced (applied in cap) */
  if(kp.sacrifice){
    for(const a of st.mobs){if(!a.alive||a===m)continue;
      if(dist2(m.x,m.y,a.x,a.y)<=80*80){a.hp=a.maxHp;fxText(st,a.x,a.y-8,'+HEAL','#86efac',.4);}
    }
  }
}

/* ========== TICKS ========== */
function spawnerTick(st,dt){
  const base=Math.max(.2,st.s.spawnBase);const elR=st.s.eliteRange||200;
  for(const sp of st.spawners){if(!sp.alive)continue;
    const isE=sp.tile===TILE.es1||sp.tile===TILE.es2||sp.tile===TILE.es3;
    if(isE){if(!sp.eliteAliveId||!st.mobs.some(m=>m.alive&&m.id===sp.eliteAliveId)){sp.eliteAliveId=null;let near=false;for(const h of st.heroes){if(h.dead)continue;if(dist2(sp.x,sp.y,h.x,h.y)<=elR*elR){near=true;break;}}if(near)spawnMobAt(st,sp);}}
    else{sp.t+=dt;if(sp.t>=base){sp.t=0;spawnMobAt(st,sp);
      /* v8.2 PASSIVE: doubleSummon */
      const p=run&&run.vil&&run.vil.passives||{};
      if(p.doubleSummon&&Math.random()<p.doubleSummon)spawnMobAt(st,sp);
    }}
  }
}

function nearestHero(st,x,y,tauntId){
  if(tauntId){const h=st.heroes.find(h=>h.id===tauntId&&!h.dead);if(h)return h;}
  const dir=(st?.villain?.directive)||'auto';
  const alive=st.heroes.filter(h=>!h.dead);if(!alive.length)return null;
  const d2h=(h)=>{const dx=h.x-x,dy=h.y-y;return dx*dx+dy*dy;};
  if(dir==='weak'){let best=null,bestHp=1e9,bestD=1e18;for(const h of alive){const hp=h.hp/h.maxHp;const d=d2h(h);if(hp<bestHp-1e-9||(Math.abs(hp-bestHp)<1e-9&&d<bestD)){best=h;bestHp=hp;bestD=d;}}return best;}
  let cand=null;
  if(dir==='healer')cand=alive.filter(h=>h.kind==='healer');
  else if(dir==='ranged')cand=alive.filter(h=>h.kind==='ranger'||h.kind==='mage');
  else if(dir==='tank')cand=alive.filter(h=>h.kind==='warrior');
  const pool=(cand&&cand.length)?cand:alive;
  let best=null,bestD=1e18;for(const h of pool){const d=d2h(h);if(d<bestD){best=h;bestD=d;}}return best;
}

function mobTick(st,dt){
  const aggroR=st.s.aggroRange||220,aggroR2=aggroR*aggroR;
  for(const m of st.mobs){if(!m.alive)continue;
    m.slowT=Math.max(0,m.slowT-dt);m.poisonT=Math.max(0,m.poisonT-dt);m.buffT=Math.max(0,m.buffT-dt);m.markT=Math.max(0,(m.markT||0)-dt);
    if(m.poisonT>0){m.hp-=2.2*dt;if(m.hp<=0){killMob(st,m,'poison');continue;}}
    /* v8.2 PASSIVE: mob regen */
    const vp=run&&run.vil&&run.vil.passives||{};
    if(vp.mobRegen&&m.hp<m.maxHp){m.hp=Math.min(m.maxHp,m.hp+m.maxHp*vp.mobRegen*dt);}
    /* v8.2 PASSIVE: slow immune for giant elite */
    if(m._slowImmune&&m.slowT>0)m.slowT=0;
    let heroNear=false;for(const h of st.heroes){if(h.dead)continue;if(dist2(m.x,m.y,h.x,h.y)<=aggroR2){heroNear=true;break;}}
    if(m.tauntTarget)heroNear=true;if(!m.aggrod&&heroNear)m.aggrod=true;if(!m.aggrod)continue;
    const hero=nearestHero(st,m.x,m.y,m.tauntTarget);if(!hero)continue;
    let spdMul=(m.slowT>0?.55:1)*(m.buffT>0?1.25:1);
    /* v8.2 PASSIVE: berserk â€” low HP boost */
    let atkMul=1;
    if(vp.berserk&&m.hp/m.maxHp<0.5){atkMul=1.4;spdMul*=1.2;}
    const speed=m.speed*spdMul;
    if(m.type===MobType.chrono){for(const h of st.heroes)if(!h.dead&&dist2(m.x,m.y,h.x,h.y)<=90*90)h.slowT=Math.max(h.slowT,.3);}
    if(m.type===MobType.chronoBoost){for(const a of st.mobs)if(a.alive&&a!==m&&dist2(m.x,m.y,a.x,a.y)<=100*100)a.buffT=Math.max(a.buffT,.3);}
    /* v8.2 king slime slow aura */
    if(m.type===MobType.slime_king){for(const h of st.heroes)if(!h.dead&&dist2(m.x,m.y,h.x,h.y)<=90*90)h.slowT=Math.max(h.slowT,.3);}
    /* v8.2 hybrid time slime slow aura */
    if(m.type===MobType.hybrid_timeslime){for(const h of st.heroes)if(!h.dead&&dist2(m.x,m.y,h.x,h.y)<=70*70)h.slowT=Math.max(h.slowT,.3);}
    if(m.type===MobType.chronoStop){m.e3-=dt;if(m.e3<=0){m.e3=rand(5,7);const r=80;fxBurst(st,m.x,m.y,r,'rgba(196,181,253,.95)');for(const h of st.heroes)if(!h.dead&&dist2(m.x,m.y,h.x,h.y)<=r*r){h.stunT=Math.max(h.stunT,1.2);}}}
    if(m.heal>0){for(const a of st.mobs){if(!a.alive||a===m)continue;if(dist2(m.x,m.y,a.x,a.y)<=90*90){a.hp=Math.min(a.maxHp,a.hp+m.heal*dt);}}}
    /* v8.2 PASSIVE: rally â€” nearby mob buff */
    if(vp.rallyBonus&&!m.bullet){let nearMelee=0;for(const a of st.mobs){if(a.alive&&a!==m&&!a.bullet&&dist2(m.x,m.y,a.x,a.y)<=60*60)nearMelee++;}if(nearMelee>=3)m.buffT=Math.max(m.buffT,.3);}
    m.repathT-=dt;if(st.repathAll)m.repathT=0;if(!m.path)m.path=[];
    if(m.repathT<=0||m.path.length===0){m.repathT=rand(.4,.7);const mg=worldToCell(m.x,m.y,st.cs,st.ox,st.oy);const hg=worldToCell(hero.x,hero.y,st.cs,st.ox,st.oy);m.path=bfsPath({x:mg.x,y:mg.y},(x,y)=>x===hg.x&&y===hg.y)||[];}
    const dx=hero.x-m.x,dy=hero.y-m.y,d=Math.hypot(dx,dy)||1;
    if(m.type===MobType.melee_dash){m.dashCd-=dt;if(m.dashCd<=0&&d>60&&d<220){m.dashT=.35;m.dashCd=rand(2.2,3.4);}}
    if(m.dashT>0){m.dashT-=dt;const[vx,vy]=norm(dx,dy);m.x+=vx*speed*3.2*dt;m.y+=vy*speed*3.2*dt;}
    else{
      let didStandoff=false;
      if(m.bullet){const desired=clamp((m.bulletRange||160)*0.65,90,170);if(d<desired-18){const tgt=sampleSafePoint(st,m.x,m.y,hero.x,hero.y,desired+20);if(tgt){const rx=tgt.x-m.x,ry=tgt.y-m.y,rd=Math.hypot(rx,ry)||1;m.x+=rx/rd*speed*dt;m.y+=ry/rd*speed*dt;}else{const[vx,vy]=norm(-dx,-dy);m.x+=vx*speed*dt;m.y+=vy*speed*dt;}didStandoff=true;}else if(d<=desired+28){didStandoff=true;}}
      if(!didStandoff){if(m.path.length>0){const next=m.path[0];const wp=cellToWorld(next.x,next.y,st.cs,st.ox,st.oy);const px=wp.x-m.x,py=wp.y-m.y,pd=Math.hypot(px,py);if(pd<4){m.x=wp.x;m.y=wp.y;m.path.shift();}else{m.x+=px/pd*speed*dt;m.y+=py/pd*speed*dt;}}else{const[vx,vy]=norm(dx,dy);m.x+=vx*speed*dt;m.y+=vy*speed*dt;}}
    }
    wallClamp(st,m);
    m.atkT-=dt;if(m.atkT<=0&&d<=(m.radius+14)){m.atkT=m.atkCd;
      let mDmg=m.atk*atkMul;
      /* v8.2 PASSIVE: crit */
      let isCrit=false;
      if(vp.critChance&&Math.random()<vp.critChance){mDmg*=2.5;isCrit=true;}
      heroTakeDmg(st,hero,mDmg,'mob',m);
      fxText(st,hero.x,hero.y-14,isCrit?`ğŸ’¥${mDmg|0}`:`-${mDmg|0}`,isCrit?'#fbbf24':'#ff6b6b',.5,'#7f1d1d');
      /* v8.2 PASSIVE: vampirism */
      if(vp.vampRate){const heal=mDmg*vp.vampRate;m.hp=Math.min(m.maxHp,m.hp+heal);}
      /* v8.2 PASSIVE: poison melee */
      if(vp.poisonMelee&&Math.random()<0.5){hero.poisonT=Math.max(hero.poisonT,3);fxText(st,hero.x,hero.y-22,'POISON','#a3e635',.5);}
    }
    if(m.bullet){m.bulletT-=dt;if(m.bulletT<=0&&d<=m.bulletRange){m.bulletT=m.bulletCd;spawnBullet(st,m.x,m.y,hero.x,hero.y,m.buffT>0?m.bulletDmg*1.2:m.bulletDmg,'mob',st.s.bulletSpeed,m.pierce,'rgba(251,191,36,.95)');}}
    if(m.type===MobType.melee_skill){m.skillT-=dt;if(m.skillT<=0&&d<90){m.skillT=rand(2.2,3.2);const r=52;fxBurst(st,m.x,m.y,r,'rgba(251,113,133,.95)');for(const h of st.heroes)if(!h.dead&&dist2(m.x,m.y,h.x,h.y)<=r*r)heroTakeDmg(st,h,10,'mob');}}
    if(m.type===MobType.eliteA){m.e1-=dt;m.e2-=dt;if(m.e1<=0){m.e1=rand(2.8,4);const r=90;fxBurst(st,m.x,m.y,r,'rgba(239,68,68,.95)');for(const h of st.heroes)if(!h.dead&&dist2(m.x,m.y,h.x,h.y)<=r*r)heroTakeDmg(st,h,16,'boss');}if(m.e2<=0&&d<520){m.e2=rand(3.6,5);spawnBullet(st,m.x,m.y,hero.x,hero.y,16,'mob',st.s.bulletSpeed*1.25,2,'rgba(251,191,36,.95)');}}
    if(m.type===MobType.eliteB){m.e1-=dt;if(m.e1<=0){m.e1=rand(2.6,3.8);const r=110;fxBurst(st,m.x,m.y,r,'rgba(96,165,250,.95)');for(const h of st.heroes)if(!h.dead&&dist2(m.x,m.y,h.x,h.y)<=r*r){h.slowT=Math.max(h.slowT,2.4);heroTakeDmg(st,h,9,'boss');}}}
    if(m.type===MobType.eliteC){m.e1-=dt;if(m.e1<=0){m.e1=rand(4,6);for(let i=0;i<3;i++){const stt=mobBaseStats(MobType.melee,st.s);st.mobs.push({id:uid(),type:MobType.melee,x:m.x+rand(-20,20),y:m.y+rand(-20,20),spawnX:m.x,spawnY:m.y,hp:stt.hp*.6,maxHp:stt.hp*.6,speed:stt.speed*1.1,atk:stt.atk*.8,atkCd:stt.atkCd,atkT:rand(0,stt.atkCd),bullet:false,bulletDmg:0,bulletCd:0,bulletT:0,bulletRange:0,pierce:0,heal:0,alive:true,slowT:0,poisonT:0,buffT:0,markT:0,dashT:0,dashCd:99,skillT:99,e1:99,e2:99,e3:99,radius:8,tauntTarget:null,aggrod:true,path:[],repathT:0});}fxBurst(st,m.x,m.y,60,'rgba(244,114,182,.95)');}}
    if(m.hp<=0)killMob(st,m,'hp0');
  }
}

function bulletTick(st,dt){
  for(const b of st.bullets){if(!b.alive)continue;b.life-=dt;if(b.life<=0){b.alive=false;continue;}
    b.x+=b.vx*b.speed*dt;b.y+=b.vy*b.speed*dt;
    const g=worldToCell(b.x,b.y,st.cs,st.ox,st.oy);
    if(!inBounds(g.x,g.y)){b.alive=false;continue;}
    if(blocksBullet.has(mapData[g.y][g.x])){b.alive=false;continue;}
    if(b.owner==='mob'){for(const h of st.heroes){if(h.dead)continue;if(dist2(b.x,b.y,h.x,h.y)<=14*14){
      /* v8.2 BULLET REFLECT */
      const aa=run&&run.adaptActive;
      if(aa&&aa.bullet&&aa.bullet.reflectChance&&Math.random()<aa.bullet.reflectChance&&!b._reflected){
        b.owner='hero';b.vx*=-1;b.vy*=-1;b._reflected=true;
        fxText(st,h.x,h.y-18,'REFLECT!','#f59e0b',.6);break;
      }
      heroTakeDmg(st,h,b.dmg,'bullet');if(b.pierce>0)b.pierce--;else b.alive=false;break;}}}
    else{for(const m of st.mobs){if(!m.alive)continue;if(dist2(b.x,b.y,m.x,m.y)<=(m.radius+3)*(m.radius+3)){let d=b.dmg*(m.markT>0?1.5:1);
      /* v8.2 BOSS DMG BONUS on hero bullets */
      const aa=run&&run.adaptActive;if(aa&&aa.boss&&aa.boss.bossDmgBonus&&(m.type===MobType.eliteA||m.type===MobType.eliteB||m.type===MobType.eliteC))d*=(1+aa.boss.bossDmgBonus);
      m.hp-=d;if(m.hp<=0)killMob(st,m,'bullet');if(b.pierce>0)b.pierce--;else b.alive=false;break;}}}
  }
  st.bullets=st.bullets.filter(b=>b.alive);
}

function fxTick(st,dt){
  for(const f of st.fx){f.t+=dt;
    if(f.k==='zone'){f.tick=(f.tick||0)+dt;if(f.tick>=.35){f.tick=0;
      if(f.tag==='curse'){for(const h of st.heroes){if(h.dead)continue;if(dist2(f.x,f.y,h.x,h.y)<=f.r*f.r){heroTakeDmg(st,h,(f.dmg||8),'aoe');}}}
      if(f.tag==='poison_zone'){for(const h of st.heroes){if(h.dead)continue;if(dist2(f.x,f.y,h.x,h.y)<=f.r*f.r){h.poisonT=Math.max(h.poisonT,1);heroTakeDmg(st,h,4,'poison');}}}
    }}
  }
  st.fx=st.fx.filter(f=>f.t<f.life);
}

function separateEntities(st){
  const str=+st.s.separateStrength||0.65;if(str<=0)return;
  const ents=[...st.mobs.filter(m=>m.alive),...st.heroes.filter(h=>!h.dead)];
  for(let i=0;i<ents.length;i++){for(let j=i+1;j<ents.length;j++){
    const a=ents[i],b=ents[j];const dx=a.x-b.x,dy=a.y-b.y;const d=Math.hypot(dx,dy)||.01;
    const minD=(a.radius||8)+(b.radius||8);
    if(d<minD){const push=(minD-d)*str*.5;const nx=dx/d,ny=dy/d;a.x+=nx*push;a.y+=ny*push;b.x-=nx*push;b.y-=ny*push;}
  }}
}

/* HERO TARGETING */
function heroGetTarget(st,hero){
  const gx=Math.floor((hero.x-st.ox)/st.cs),gy=Math.floor((hero.y-st.oy)/st.cs);
  const aliveChests=st.chests.filter(c=>c.alive);
  if(aliveChests.length>0){const dist=bfsDistFrom({x:gx,y:gy});let best=null,bd=1e9;for(const c of aliveChests){const d=dist[c.gy*mapW+c.gx];if(d>=0&&d<bd){bd=d;best=c;}}if(best)return{type:'chest',gx:best.gx,gy:best.gy,obj:best};}
  if(st.spawners.some(s=>s.alive)){const dist=bfsDistFrom({x:gx,y:gy});let best=null,bd=1e9;for(const sp of st.spawners){if(!sp.alive)continue;for(const[dx,dy]of[[1,0],[-1,0],[0,1],[0,-1]]){const nx=sp.gx+dx,ny=sp.gy+dy;if(!isWalk(nx,ny))continue;const d=dist[ny*mapW+nx];if(d>=0&&d<bd){bd=d;best=sp;}}}if(best)return{type:'spawner',gx:best.gx,gy:best.gy,obj:best};}
  return{type:'castle',gx:st.castle.gx,gy:st.castle.gy};
}
function pickNearestMob(st,x,y,maxR){const r2=maxR*maxR;let b=null,bd=1e18;for(const m of st.mobs){if(!m.alive)continue;const d=dist2(x,y,m.x,m.y);if(d<=r2&&d<bd){bd=d;b=m;}}return b;}
function countMobsNear(st,x,y,r){const r2=r*r;let c=0;for(const m of st.mobs)if(m.alive&&dist2(x,y,m.x,m.y)<=r2)c++;return c;}
function allDead(st){return st.heroes.every(h=>h.dead);}

/* HERO SKILLS */
function heroUseSkill(st,hero,id){
  const n={warrior:'ì „ì‚¬',healer:'íëŸ¬',ranger:'ì›ë”œ',mage:'ë§ˆë²•ì‚¬'}[hero.kind];
  if(id==='taunt'){hero.shieldT=3.5;fxBurst(st,hero.x,hero.y,130,'rgba(255,255,255,.6)');for(const m of st.mobs)if(m.alive&&dist2(hero.x,hero.y,m.x,m.y)<=130*130)m.tauntTarget=hero.id;logSkill(`${n}: ë„ë°œ!`);}
  if(id==='slam'){const r=72;fxBurst(st,hero.x,hero.y,r,'rgba(251,191,36,.95)');for(const m of st.mobs){if(!m.alive)continue;if(dist2(hero.x,hero.y,m.x,m.y)<=r*r){m.hp-=hero.atk*1.5;m.slowT=Math.max(m.slowT,1.5);if(m.hp<=0)killMob(st,m,'slam');}}}
  if(id==='heal'){const a=Math.max(20,hero.atk*3);for(const h of st.heroes)if(!h.dead)h.hp=Math.min(h.maxHp,h.hp+a);fxBurst(st,hero.x,hero.y,80,'rgba(34,197,94,.7)');logSkill(`${n}: ì „ì²´í(+${a|0})`);}
  if(id==='cleanse'){for(const h of st.heroes)if(!h.dead){h.poisonT=0;h.slowT=0;h.stunT=0;h.frozenT=0;}fxBurst(st,hero.x,hero.y,70,'rgba(59,130,246,.95)');logSkill(`${n}: ì •í™”`);}
  if(id==='snipe'){const t=pickNearestMob(st,hero.x,hero.y,500);if(t){const d=hero.atk*3.5;spawnBullet(st,hero.x,hero.y,t.x,t.y,d,'hero',700,1,'rgba(239,68,68,.95)');logSkill(`${n}: ì§‘ì¤‘ì‚¬ê²©`);}}
  if(id==='fireball'){const t=pickNearestMob(st,hero.x,hero.y,420);if(t){const r=75;fxBurst(st,t.x,t.y,r,'rgba(249,115,22,.95)');for(const m of st.mobs){if(!m.alive)continue;if(dist2(t.x,t.y,m.x,m.y)<=r*r){m.hp-=hero.atk*1.8;if(m.hp<=0)killMob(st,m,'fireball');}}logSkill(`${n}: íŒŒì´ì–´ë³¼`);}}
  /* v8.2 NEW SKILLS */
  if(id==='shieldcharge'){const t=pickNearestMob(st,hero.x,hero.y,150);if(t){hero.x+=(t.x-hero.x)*.7;hero.y+=(t.y-hero.y)*.7;t.hp-=hero.atk*2;t.stunT=Math.max(t.stunT||0,1);fxLine(st,hero.x,hero.y,t.x,t.y,'rgba(255,255,255,.95)',.3,3);if(t.hp<=0)killMob(st,t,'charge');logSkill(`${n}: ë°©íŒ¨ëŒì§„`);}}
  if(id==='warcry'){for(const h of st.heroes)if(!h.dead)h.shieldT=Math.max(h.shieldT,3);fxBurst(st,hero.x,hero.y,100,'rgba(251,191,36,.7)');logSkill(`${n}: ì „íˆ¬í•¨ì„±`);}
  if(id==='barrier'){for(const h of st.heroes)if(!h.dead)h.shieldT=Math.max(h.shieldT,4);fxBurst(st,hero.x,hero.y,90,'rgba(96,165,250,.7)');logSkill(`${n}: ë³´í˜¸ë§‰`);}
  if(id==='revive'){const dead=st.heroes.find(h=>h.dead);if(dead){dead.dead=false;dead.hp=dead.maxHp*.4;dead.x=hero.x+rand(-15,15);dead.y=hero.y+rand(-15,15);fxBurst(st,dead.x,dead.y,60,'rgba(34,197,94,.95)');logSkill(`${n}: ë¶€í™œ!`);}}
  if(id==='arrowrain'){const r=70;fxBurst(st,hero.x,hero.y,r,'rgba(239,68,68,.5)');for(const m of st.mobs){if(!m.alive)continue;if(dist2(hero.x,hero.y,m.x,m.y)<=r*r){m.hp-=hero.atk*1.2;if(m.hp<=0)killMob(st,m,'arrowrain');}}logSkill(`${n}: í™”ì‚´ë¹„`);}
  if(id==='poisonarrow'){const t=pickNearestMob(st,hero.x,hero.y,380);if(t){spawnBullet(st,hero.x,hero.y,t.x,t.y,hero.atk*1.1,'hero',550,0,'rgba(163,230,53,.95)');t.poisonT=Math.max(t.poisonT,5);logSkill(`${n}: ë…í™”ì‚´`);}}
  if(id==='chainlightning'){let targets=[];let cur=pickNearestMob(st,hero.x,hero.y,350);for(let i=0;i<4&&cur;i++){targets.push(cur);cur.hp-=hero.atk*1.4;fxLine(st,i===0?hero.x:targets[i-1].x,i===0?hero.y:targets[i-1].y,cur.x,cur.y,'rgba(139,92,246,.95)',.25,2);if(cur.hp<=0)killMob(st,cur,'lightning');let next=null,nd=1e18;for(const m of st.mobs){if(!m.alive||targets.includes(m))continue;const d=dist2(cur.x,cur.y,m.x,m.y);if(d<nd&&d<120*120){nd=d;next=m;}}cur=next;}logSkill(`${n}: ì²´ì¸ë¼ì´íŠ¸ë‹`);}
  if(id==='teleport'){const safe=sampleSafePoint(st,hero.x,hero.y,hero.x,hero.y,150);if(safe){fxBurst(st,hero.x,hero.y,30,'rgba(192,132,252,.7)');hero.x=safe.x;hero.y=safe.y;fxBurst(st,hero.x,hero.y,30,'rgba(192,132,252,.7)');logSkill(`${n}: í…”ë ˆí¬íŠ¸`);}}
}

/* HEROES TICK */
function heroesTick(st,dt){
  for(const hero of st.heroes){if(hero.dead)continue;
    hero.frozenT=Math.max(0,hero.frozenT-dt);hero.shieldT=Math.max(0,hero.shieldT-dt);
    hero.poisonT=Math.max(0,hero.poisonT-dt);hero.slowT=Math.max(0,hero.slowT-dt);hero.stunT=Math.max(0,hero.stunT-dt);
    if(hero.poisonT>0){
      /* v8.2 POISON IMMUNITY: reduced tick rate */
      const aa=run&&run.adaptActive;
      let pImm=0;if(aa&&aa.poison&&aa.poison.poisonImmune)pImm=aa.poison.poisonImmune;
      hero._pImmT=(hero._pImmT||0)+dt;
      if(pImm>0&&hero._pImmT<pImm){/* immune window â€” no poison dmg */}
      else{hero._pImmT=0;hero.hp-=2.5*dt;}
      if(hero.hp<=0){hero.hp=0;hero.dead=true;fxText(st,hero.x,hero.y,'DEAD','#ff6b6b',1,'#000');if(run&&run.adapt){run.adapt.poison=(run.adapt.poison||0)+1;computeAdaptations();}continue;}
    }
    heroTrapCheck(st,hero,dt);if(hero.frozenT>0||hero.stunT>0)continue;
    for(const c of st.chests){if(!c.alive)continue;if(dist2(hero.x,hero.y,c.x,c.y)<=20*20){c.alive=false;fxBurst(st,c.x,c.y,50,'rgba(252,211,77,.95)');logSkill('ë³´ë¬¼ìƒì íšë“!');st.repathAll=true;}}
    const target=heroGetTarget(st,hero);
    hero.repathT-=dt;if(st.repathAll)hero.repathT=0;
    if(hero.repathT<=0||hero.path.length===0){hero.repathT=.5;
      const gx=Math.floor((hero.x-st.ox)/st.cs),gy=Math.floor((hero.y-st.oy)/st.cs);
      let path=null;
      if(target.type==='spawner'){const sp=target.obj;path=bfsPath({x:gx,y:gy},(x,y)=>Math.abs(x-sp.gx)+Math.abs(y-sp.gy)===1);}
      else path=bfsPath({x:gx,y:gy},(x,y)=>x===target.gx&&y===target.gy);
      hero.path=path||[];
    }
    const spdMul=hero.slowT>0?.6:1;let speed=hero.speed*spdMul;
    /* v8.2 TRAP SPEED BOOST */
    const aa2=run&&run.adaptActive;
    if(aa2&&aa2.trap&&aa2.trap.trapSpeedBoost){const hg=worldToCell(hero.x,hero.y,st.cs,st.ox,st.oy);if(inBounds(hg.x,hg.y)&&TRAP_IDS.includes(mapData[hg.y][hg.x]))speed*=(1+aa2.trap.trapSpeedBoost);}
    /* v8.2 AOE SPREAD INSTINCT: push away from other heroes */
    if(aa2&&aa2.aoe&&aa2.aoe.spreadBonus){const spr=aa2.aoe.spreadBonus;for(const h2 of st.heroes){if(h2===hero||h2.dead)continue;const sd=Math.hypot(hero.x-h2.x,hero.y-h2.y)||1;if(sd<spr*2){const[sx,sy]=norm(hero.x-h2.x,hero.y-h2.y);hero.x+=sx*0.4;hero.y+=sy*0.4;}}}
    let didKite=false;
    if(hero.kind!=='warrior'){const threat=pickNearestMob(st,hero.x,hero.y,260);if(threat){const ddx=hero.x-threat.x,ddy=hero.y-threat.y;const dd=Math.hypot(ddx,ddy)||1;if(dd<120){const[vx,vy]=norm(ddx,ddy);hero.x+=vx*speed*dt;hero.y+=vy*speed*dt;didKite=true;}}}
    if(!didKite&&hero.path.length>0){const next=hero.path[0],wp=cellToWorld(next.x,next.y,st.cs,st.ox,st.oy);const dx=wp.x-hero.x,dy=wp.y-hero.y,d=Math.hypot(dx,dy);if(d<4){hero.x=wp.x;hero.y=wp.y;hero.path.shift();}else{hero.x+=dx/d*speed*dt;hero.y+=dy/d*speed*dt;}}
    wallClamp(st,hero);
    hero.atkT-=dt;if(hero.atkT<=0){
      if(hero.kind==='warrior'){const t=pickNearestMob(st,hero.x,hero.y,30);if(t){hero.atkT=hero.atkCd;let dmg=hero.atk;
        /* v8.2 BOSS DMG BONUS */
        const aa=run&&run.adaptActive;if(aa&&aa.boss&&aa.boss.bossDmgBonus&&(t.type===MobType.eliteA||t.type===MobType.eliteB||t.type===MobType.eliteC))dmg*=(1+aa.boss.bossDmgBonus);
        t.hp-=dmg;fxText(st,t.x,t.y-10,`-${dmg|0}`,'#fbbf24',.45);if(t.hp<=0)killMob(st,t,'hero');}}
      else if(hero.kind==='healer'){const t=pickNearestMob(st,hero.x,hero.y,280);if(t){hero.atkT=hero.atkCd;spawnBullet(st,hero.x,hero.y,t.x,t.y,hero.atk,'hero',450,0,'rgba(134,239,172,.95)');}}
      else if(hero.kind==='ranger'){const t=pickNearestMob(st,hero.x,hero.y,400);if(t){hero.atkT=hero.atkCd;spawnBullet(st,hero.x,hero.y,t.x,t.y,hero.atk,'hero',620,0,'rgba(239,68,68,.95)');}}
      else if(hero.kind==='mage'){const t=pickNearestMob(st,hero.x,hero.y,360);if(t){hero.atkT=hero.atkCd;spawnBullet(st,hero.x,hero.y,t.x,t.y,hero.atk,'hero',480,0,'rgba(192,132,252,.95)');const sr=45;for(const m2 of st.mobs){if(!m2.alive||m2===t)continue;if(dist2(t.x,t.y,m2.x,m2.y)<=sr*sr){m2.hp-=hero.atk*.35;if(m2.hp<=0)killMob(st,m2,'mage_splash');}}}}
    }
    if(st.spawners.some(s=>s.alive)&&target.type==='spawner'){const sp=target.obj;if(sp&&sp.alive){const hx=Math.floor((hero.x-st.ox)/st.cs),hy=Math.floor((hero.y-st.oy)/st.cs);if(Math.abs(hx-sp.gx)+Math.abs(hy-sp.gy)===1){hero.spT=(hero.spT||0)-dt;if(hero.spT<=0){hero.spT=hero.atkCd;const d=hero.kind==='warrior'?hero.atk*1.3:hero.atk;if(run&&run.vil&&run.vil.passives.eternalSpawner){/* immortal spawners */}else sp.hp-=d;fxText(st,sp.x,sp.y-12,`-${d|0}`,'#fbbf24',.55);/* v8.2 PASSIVE: spawner thorns */
      const tp=run&&run.vil&&run.vil.passives||{};
      if(tp.spawnerThorns){hero.hp-=tp.spawnerThorns;fxText(st,hero.x,hero.y-20,'ğŸŒµ','#f59e0b',.3);if(hero.hp<=0){hero.hp=0;hero.dead=true;fxText(st,hero.x,hero.y,'DEAD','#ff6b6b',1);}}
      if(sp.hp<=0){sp.alive=false;fxBurst(st,sp.x,sp.y,55,'rgba(239,68,68,.95)');st.repathAll=true;}}}}}
    hero.skillA-=dt;hero.skillB-=dt;hero.skillC-=dt;hero.skillD=(hero.skillD||0)-dt;
    if(hero.kind==='warrior'){const near=countMobsNear(st,hero.x,hero.y,80);if(near>=3&&hero.skillA<=0){hero.skillA=10;heroUseSkill(st,hero,'taunt');}if(near>=5&&hero.skillB<=0){hero.skillB=6;heroUseSkill(st,hero,'slam');}if(near>=2&&hero.skillC<=0){hero.skillC=8;heroUseSkill(st,hero,'shieldcharge');}if(hero.hp/hero.maxHp<.5&&hero.skillD<=0){hero.skillD=12;heroUseSkill(st,hero,'warcry');}}
    if(hero.kind==='healer'){const anyLow=st.heroes.some(h=>!h.dead&&h.hp/h.maxHp<.55);if(anyLow&&hero.skillA<=0){hero.skillA=6;heroUseSkill(st,hero,'heal');}const anyDebuff=st.heroes.some(h=>!h.dead&&(h.poisonT>0||h.slowT>0||h.stunT>0));if(anyDebuff&&hero.skillB<=0){hero.skillB=8;heroUseSkill(st,hero,'cleanse');}if(st.heroes.some(h=>!h.dead&&h.hp/h.maxHp<.4)&&hero.skillC<=0){hero.skillC=10;heroUseSkill(st,hero,'barrier');}if(st.heroes.some(h=>h.dead)&&hero.skillD<=0){hero.skillD=25;heroUseSkill(st,hero,'revive');}}
    if(hero.kind==='ranger'){if(hero.skillA<=0){const near=countMobsNear(st,hero.x,hero.y,300);if(near>=2){hero.skillA=8;heroUseSkill(st,hero,'snipe');}}if(hero.skillB<=0){const near=countMobsNear(st,hero.x,hero.y,200);if(near>=4){hero.skillB=7;heroUseSkill(st,hero,'arrowrain');}}if(hero.skillC<=0){const near=countMobsNear(st,hero.x,hero.y,350);if(near>=1){hero.skillC=6;heroUseSkill(st,hero,'poisonarrow');}}}
    if(hero.kind==='mage'){if(hero.skillA<=0){const near=countMobsNear(st,hero.x,hero.y,400);if(near>=3){hero.skillA=9;heroUseSkill(st,hero,'fireball');}}if(hero.skillB<=0){const near=countMobsNear(st,hero.x,hero.y,350);if(near>=2){hero.skillB=7;heroUseSkill(st,hero,'chainlightning');}}if(hero.hp/hero.maxHp<.35&&hero.skillC<=0){hero.skillC=10;heroUseSkill(st,hero,'teleport');}}
  }
}

/* ========== GAME STATE FOR BATTLE ========== */
let game=null,savedMapSnapshot=null;

function applyMetaToSettings(s){
  /* v8.2 PATH passives */
  const pp=run&&run.vil&&run.vil.passives||{};
  if(pp.pathWarlordAtk)s.mobAtk=(s.mobAtk||1)*(1+pp.pathWarlordAtk);
  if(pp.pathEngSpHp)s.spawnerHp=(s.spawnerHp||1)*(1+pp.pathEngSpHp);
  if(pp.pathEngTrap)s.trapDmg=(s.trapDmg||1)*(1+pp.pathEngTrap);
  if(pp.pathSorcRegen)s.vilRegenMul=(s.vilRegenMul||1)+pp.pathSorcRegen;
  if(pp.pathSorcCd)s.vilCdMul=(s.vilCdMul||1)-pp.pathSorcCd;
  /* v8.2 MASTERY passives applied in mob spawn instead */
  if(!run) return;
  const stage=run.stage;const vil=run.vil;const up=run.heroUp;
  s.wHP*=(up.gHP||1);s.wAtk*=(up.gAtk||1);
  s.hHP*=(up.gHP||1);s.hAtk*=(up.gAtk||1);
  s.rHP*=(up.gHP||1);s.rAtk*=(up.gAtk||1);
  s.mgHP*=(up.gHP||1);s.mgAtk*=(up.gAtk||1);
  const step=Math.max(0,stage-1);
  const threat=vil.level||0;
  s._mobHpMul=(1+0.10*step+0.03*threat)*(1+0.08*(vil.bonusHp||0));
  s._mobAtkMul=(1+0.07*step+0.02*threat)*(1+0.08*(vil.bonusAtk||0));
  s._mobSpdMul=1+0.03*step;
  s._mobBulletMul=s._mobAtkMul;
  s.spawnerHP*=(1+0.06*step+0.02*threat)*(1+0.10*(vil.bonusSpawnerHp||0));
  s.spawnBase=Math.max(0.25,s.spawnBase/(1+0.06*step));
  /* v8.2 PASSIVE: glass cannon */
  const p=vil.passives||{};
  if(p.glass){s._mobAtkMul*=(1+0.35*p.glass);s._mobHpMul*=(1-Math.min(0.25*p.glass,0.7));}
  /* v8.2 PASSIVE: unstable â€” faster spawn, weaker spawner */
  if(p.unstable){s.spawnBase*=Math.max(0.15,1-0.5*p.unstable);s.spawnerHP*=Math.max(0.15,1-0.4*p.unstable);}
  /* v8.2 PASSIVE: chaos â€” random Â±30% all stats */
  if(p.chaos){const cr=()=>0.7+Math.random()*0.6;s._mobHpMul*=cr();s._mobAtkMul*=cr();s._mobSpdMul*=cr();s.spawnerHP*=cr();s.spawnBase*=cr();}
  /* v8.2 PASSIVE: mobCapBonus stored for spawnerTick */
  s._mobCapBonus=p.mobCapBonus||0;
  /* v8.2 PASSIVE: trap boost */
  s._trapBoost=1+(p.trapBoost||0);
}

function makeGameFromMap(){
  const ent=findOne(TILE.entrance),cas=findOne(TILE.castle);
  if(!ent||!cas){alert('ë§µì— ì…êµ¬(E) ë˜ëŠ” ë§ˆì™•ì„±(C)ì´ ì—†ìŠµë‹ˆë‹¤!');return null;}
  const s=collectSettings();applyMetaToSettings(s);
  const pad=12,cW=Math.floor((960-pad*2)/mapW),cH=Math.floor((720-pad*2)/mapH),cs=Math.min(cW,cH),ox=pad,oy=pad;
  const entW=cellToWorld(ent.x,ent.y,cs,ox,oy),casW=cellToWorld(cas.x,cas.y,cs,ox,oy);
  const chestTiles=findAll(TILE.chest);
  const chests=chestTiles.map(c=>({id:uid(),gx:c.x,gy:c.y,...cellToWorld(c.x,c.y,cs,ox,oy),alive:true}));
  const spTiles=getPlacedSpawners();
  const spawners=spTiles.map(sp=>{const w=cellToWorld(sp.x,sp.y,cs,ox,oy);return{id:uid(),gx:sp.x,gy:sp.y,x:w.x,y:w.y,tile:sp.t,hp:s.spawnerHP,alive:true,t:0,eliteAliveId:null};});
  const heroes=[];const offsets=[[-8,-6],[10,-4],[0,10],[-10,8]];let oi=0;
  HERO_DEFS.forEach(hd=>{
    if(!heroSelection[hd.kind])return;const off=offsets[oi%4];oi++;
    const hp=s[hd.kind==='warrior'?'wHP':hd.kind==='healer'?'hHP':hd.kind==='ranger'?'rHP':'mgHP'];
    const spd=s[hd.kind==='warrior'?'wSpeed':hd.kind==='healer'?'hSpeed':hd.kind==='ranger'?'rSpeed':'mgSpeed'];
    const atk=s[hd.kind==='warrior'?'wAtk':hd.kind==='healer'?'hAtk':hd.kind==='ranger'?'rAtk':'mgAtk'];
    const atkCd=s[hd.kind==='warrior'?'wAtkCd':hd.kind==='healer'?'hHealCd':hd.kind==='ranger'?'rAtkCd':'mgAtkCd'];
    heroes.push({id:uid(),kind:hd.kind,icon:hd.icon,color:hd.color,role:hd.role,
      x:entW.x+off[0],y:entW.y+off[1],hp,maxHp:hp,speed:spd,atk,atkCd:atkCd||.55,atkT:rand(0,atkCd||.55),
      frozenT:0,shieldT:0,poisonT:0,slowT:0,stunT:0,path:[],repathT:0,trapT:0,
      skillA:0,skillB:0,skillC:0,skillD:0,spT:0,dead:false,radius:12,_pImmT:0,
    });
  });
  /* v8.2 MOB ADAPT HP BONUS */
  if(run&&run.adaptActive&&run.adaptActive.mob&&run.adaptActive.mob.hpBonus){
    const bonus=run.adaptActive.mob.hpBonus;
    for(const h of heroes){h.hp*=(1+bonus);h.maxHp*=(1+bonus);}
  }
  return{s,cs,ox,oy,time:0,running:false,paused:false,ended:false,debug:false,
    castle:{gx:cas.x,gy:cas.y,x:casW.x,y:casW.y},chests,spawners,heroes,mobs:[],bullets:[],fx:[],
    villain:{energy:100+(run.vil.passives.extraEnergy||0),maxEnergy:100+(run.vil.passives.extraEnergy||0),regen:9+(run.vil.passives.extraRegen||0),cds:{},directive:'auto'},repathAll:false,shakeT:0,shakePow:0,
    battleWalls:[], // track walls placed during battle for cleanup
    runStats:{maxMobs:0,trapHits:0,heroDeaths:0}};
}

function endGame(st,text){
  if(st.ended) return;
  st.ended=true;st.endText=text;
  setTimeout(()=>{if(run)processResult(st);},800);
}

function tick(st,dt){
  /* v8.2 AWAKENING: living walls â€” walls damage nearby heroes */
  const lw=run&&run.vil&&run.vil.passives;
  if(lw&&lw.livingWalls){
    st._wallDmgT=(st._wallDmgT||0)+dt;
    if(st._wallDmgT>=0.5){st._wallDmgT=0;
      for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){if(mapData[y][x]===TILE.wall){
        const wx=st.ox+x*st.cs+st.cs/2,wy=st.oy+y*st.cs+st.cs/2;
        for(const h of st.heroes){if(h.dead)continue;if(dist2(wx,wy,h.x,h.y)<=(st.cs*1.2)*(st.cs*1.2)){
          heroTakeDmg(st,h,1.5,'trap');h.slowT=Math.max(h.slowT,0.5);
        }}
      }}
    }
  }

  if(!st.running||st.paused||st.ended)return;st.time+=dt;
  if(st.time>=st.s.sessionLimit){endGame(st,'ì‹œê°„ ì´ˆê³¼ â€” ë§ˆì™• ë°©ì–´ ì„±ê³µ!');return;}
  st.villain.energy=clamp(st.villain.energy+st.villain.regen*dt,0,st.villain.maxEnergy);
  for(const k in st.villain.cds)st.villain.cds[k]=Math.max(0,st.villain.cds[k]-dt);
  st.shakeT=Math.max(0,st.shakeT-dt);if(st.shakeT<=0)st.shakePow=0;
  spawnerTick(st,dt);mobTick(st,dt);heroesTick(st,dt);separateEntities(st);
  for(const m of st.mobs)if(m.alive)wallClamp(st,m);
  for(const h of st.heroes)if(!h.dead)wallClamp(st,h);
  bulletTick(st,dt);fxTick(st,dt);
  if(st.mobs.length>300)st.mobs=st.mobs.filter(m=>m.alive);
  st.repathAll=false;
  if(allDead(st)){endGame(st,'ìš©ì‚¬ ì „ë©¸ â€” ë§ˆì™• ë°©ì–´ ì„±ê³µ!');return;}
  if(!st.spawners.some(s=>s.alive)){for(const h of st.heroes){if(h.dead)continue;const g=worldToCell(h.x,h.y,st.cs,st.ox,st.oy);if(g.x===st.castle.gx&&g.y===st.castle.gy){endGame(st,'ìš©ì‚¬ ìŠ¹ë¦¬ â€” ë§ˆì™• íŒ¨ë°°!');return;}}}
}

/* ========== RESULT / REWARD SYSTEM ========== */
/* v8.2 EXPANDED: tiered upgrades with unique passives */
const UPGRADE_POOL=[
  /* ===== ğŸ—¡ ì „íˆ¬: ëª¹ ì „íˆ¬ ëŠ¥ë ¥ ===== */
  {id:"vHp",cat:'ğŸ—¡',t:"ê°•ì¸í•œ ëª¹",d:"ì „ì²´ ëª¬ìŠ¤í„° HP +8%",tier:0,
    apply:()=>{run.vil.bonusHp=(run.vil.bonusHp||0)+1;}},
  {id:"vAtk",cat:'ğŸ—¡',t:"ì‚¬ë‚˜ìš´ ëª¹",d:"ì „ì²´ ëª¬ìŠ¤í„° ê³µê²©ë ¥ +8%",tier:0,
    apply:()=>{run.vil.bonusAtk=(run.vil.bonusAtk||0)+1;}},
  {id:"vVamp",cat:'ğŸ—¡',t:"í¡í˜ˆ ë³¸ëŠ¥",d:"ëª¹ì´ í”¼í•´ì˜ 15%ë¥¼ HPë¡œ íšŒë³µ (ì¤‘ì²© ê°€ëŠ¥)",tier:1,
    apply:()=>{run.vil.passives.vampRate=(run.vil.passives.vampRate||0)+0.15;}},
  {id:"vBerserk",cat:'ğŸ—¡',t:"ê´‘ì „ì‚¬",d:"HP 50% ì´í•˜ ëª¹ì˜ ê³µê²©ë ¥ +40%, ì´ì† +20%",tier:1,
    apply:()=>{run.vil.passives.berserk=true;}},
  {id:"vThorns",cat:'ğŸ—¡',t:"ê°€ì‹œ ê°‘ì˜·",d:"ìŠ¤í¬ë„ˆ í”¼ê²© ì‹œ ê³µê²©ìì—ê²Œ ë°˜ì‚¬ ë°ë¯¸ì§€ 5",tier:1,
    apply:()=>{run.vil.passives.spawnerThorns=(run.vil.passives.spawnerThorns||0)+5;}},
  {id:"vPoison",cat:'ğŸ—¡',t:"ë…ë¬´ê¸°",d:"ëª¹ ê·¼ì ‘ ê³µê²© ì‹œ 50% í™•ë¥ ë¡œ ë… ë¶€ì—¬",tier:1,
    apply:()=>{run.vil.passives.poisonMelee=true;}},
  {id:"vDeathblow",cat:'ğŸ—¡',t:"í•„ì‚´ì¼ê²©",d:"ëª¹ ê³µê²© ì‹œ 8% í™•ë¥ ë¡œ 2.5ë°° í¬ë¦¬í‹°ì»¬",tier:2,
    apply:()=>{run.vil.passives.critChance=(run.vil.passives.critChance||0)+0.08;}},

  /* ===== ğŸ§¬ ë³€ì´: ëª¹ íŠ¹ìˆ˜ ëŠ¥ë ¥ ===== */
  {id:"vSplit",cat:'ğŸ§¬',t:"ë¶„ì—´ ë³¸ëŠ¥",d:"ë¹„-ìŠ¬ë¼ì„ ëª¹ ì‚¬ë§ ì‹œ 15% í™•ë¥ ë¡œ ë¯¸ë‹ˆëª¹ 1ë§ˆë¦¬ ìƒì„±",tier:1,
    apply:()=>{run.vil.passives.deathSplit=(run.vil.passives.deathSplit||0)+0.15;}},
  {id:"vGiant",cat:'ğŸ§¬',t:"ê±°ëŒ€í™” ì£¼ì…",d:"ì—˜ë¦¬íŠ¸ ëª¹ HP +50%, í¬ê¸° +30%, ê°ì† ë©´ì—­",tier:1,
    apply:()=>{run.vil.passives.giantElite=true;}},
  {id:"vRally",cat:'ğŸ§¬',t:"êµ°ì¤‘ ê²°ì§‘",d:"ê·¼ì ‘ ëª¹ 3ë§ˆë¦¬ ì´ìƒ ë°€ì§‘ ì‹œ ì„œë¡œ ê³µê²©ë ¥ +20%",tier:2,
    apply:()=>{run.vil.passives.rallyBonus=true;}},
  {id:"vRegen",cat:'ğŸ§¬',t:"ì¬ìƒë ¥",d:"ì „íˆ¬ ì¤‘ ëª¨ë“  ëª¹ì´ ì´ˆë‹¹ HP 1% íšŒë³µ",tier:1,
    apply:()=>{run.vil.passives.mobRegen=(run.vil.passives.mobRegen||0)+0.01;}},
  {id:"vRevive",cat:'ğŸ§¬',t:"ë¶ˆì‚¬ ì˜ì§€",d:"ì²« ì‚¬ë§ ëª¹ 20% í™•ë¥ ë¡œ HP 30%ë¡œ ë¶€í™œ",tier:2,
    apply:()=>{run.vil.passives.reviveChance=(run.vil.passives.reviveChance||0)+0.20;}},

  /* ===== âš™ ë©”ì»¤ë‹‰: ìŠ¤í¬ë„ˆ/í•¨ì • ===== */
  {id:"vSpawn",cat:'âš™',t:"ë¹ ë¥¸ ì†Œí™˜",d:"ìŠ¤í¬ë„ˆ ì†Œí™˜ ì†ë„ +10%",tier:0,
    apply:()=>{run.vil.bonusSpawn=(run.vil.bonusSpawn||0)+1;}},
  {id:"vSpHp",cat:'âš™',t:"ê²¬ê³ í•œ ìŠ¤í¬ë„ˆ",d:"ìŠ¤í¬ë„ˆ HP +10%",tier:0,
    apply:()=>{run.vil.bonusSpawnerHp=(run.vil.bonusSpawnerHp||0)+1;}},
  {id:"vDoubleSummon",cat:'âš™',t:"ì´ì¤‘ ì†Œí™˜",d:"ìŠ¤í¬ë„ˆ ì†Œí™˜ ì‹œ 25% í™•ë¥ ë¡œ 2ë§ˆë¦¬ ë™ì‹œ ì†Œí™˜",tier:2,
    apply:()=>{run.vil.passives.doubleSummon=(run.vil.passives.doubleSummon||0)+0.25;}},
  {id:"vTrapBoost",cat:'âš™',t:"í•¨ì • ê°•í™”",d:"ëª¨ë“  í•¨ì • í”¼í•´/íš¨ê³¼ +40%",tier:1,
    apply:()=>{run.vil.passives.trapBoost=(run.vil.passives.trapBoost||0)+0.4;}},
  {id:"vMobCap",cat:'âš™',t:"ëŒ€êµ°ì„¸",d:"ìŠ¤í¬ë„ˆë‹¹ ìµœëŒ€ ëª¹ ìˆ˜ +3",tier:1,
    apply:()=>{run.vil.passives.mobCapBonus=(run.vil.passives.mobCapBonus||0)+3;}},

  /* ===== ğŸ”® ë§ˆì™• ìŠ¤í‚¬ ===== */
  {id:"vEnergy",cat:'ğŸ”®',t:"ì—ë„ˆì§€ ì¦í­",d:"ìµœëŒ€ ì—ë„ˆì§€ +30, ì¬ìƒ +3/ì´ˆ",tier:1,
    apply:()=>{run.vil.passives.extraEnergy=(run.vil.passives.extraEnergy||0)+30;run.vil.passives.extraRegen=(run.vil.passives.extraRegen||0)+3;}},
  {id:"vCooldown",cat:'ğŸ”®',t:"ì‹œê°„ì™œê³¡",d:"ë§ˆì™• ìŠ¤í‚¬ ì¿¨ë‹¤ìš´ -20%",tier:1,
    apply:()=>{run.vil.passives.cdReduction=(run.vil.passives.cdReduction||0)+0.20;}},
  {id:"vMeteorPlus",cat:'ğŸ”®',t:"í˜œì„± í­ê²©",d:"ë©”í…Œì˜¤ ë²”ìœ„ +30%, í”¼í•´ +50%",tier:2,
    apply:()=>{run.vil.passives.meteorBoost=true;}},
  {id:"vCurseAmp",cat:'ğŸ”®',t:"ì˜êµ¬ ì €ì£¼",d:"ì €ì£¼ ì¥íŒ ì§€ì†ì‹œê°„ 2ë°°, í”¼í•´ +30%",tier:2,
    apply:()=>{run.vil.passives.curseAmp=true;}},

  /* ===== ğŸ’° ê²½ì œ ===== */
  {id:"vGold5",cat:'ğŸ’°',t:"ë¹„ìƒê¸ˆ",d:"ì¦‰ì‹œ ê³¨ë“œ +5",tier:0,
    apply:()=>{run.gold+=5;}},
  {id:"vInterest",cat:'ğŸ’°',t:"ê³ ë¦¬ëŒ€ê¸ˆ",d:"ë§¤ ìŠ¤í…Œì´ì§€ ì‹œì‘ ì‹œ ë³´ìœ  ê³¨ë“œì˜ 10% ì´ì (ìµœëŒ€ 8G)",tier:1,
    apply:()=>{run.vil.passives.interest=true;}},
  {id:"vDiscount",cat:'ğŸ’°',t:"ì•”ì‹œì¥",d:"ìƒì  ì¹´ë“œ ê°€ê²© 1G í• ì¸ (ìµœì†Œ 1G)",tier:1,
    apply:()=>{run.vil.passives.shopDiscount=(run.vil.passives.shopDiscount||0)+1;}},
  {id:"vBounty",cat:'ğŸ’°',t:"í˜„ìƒê¸ˆ",d:"ìš©ì‚¬ ì‚¬ë§ ì‹œ ì¶”ê°€ 3G íšë“",tier:1,
    apply:()=>{run.vil.passives.heroBounty=(run.vil.passives.heroBounty||0)+3;}},

  /* ===== ğŸ’€ ì €ì£¼ (íŠ¸ë ˆì´ë“œì˜¤í”„) ===== */
  {id:"vGlass",cat:'ğŸ’€',t:"ìœ ë¦¬ ëŒ€í¬",d:"ëª¹ ê³µê²©ë ¥ +35% â†” HP -25%",tier:1,
    apply:()=>{run.vil.passives.glass=(run.vil.passives.glass||0)+1;}},
  {id:"vUnstable",cat:'ğŸ’€',t:"ë¶ˆì•ˆì • ì¦í­",d:"ìŠ¤í° ì†ë„ 2ë°° â†” ìŠ¤í¬ë„ˆ HP -40%",tier:1,
    apply:()=>{run.vil.passives.unstable=(run.vil.passives.unstable||0)+1;}},
  {id:"vSacrifice",cat:'ğŸ’€',t:"í”¼ì˜ ì œë¬¼",d:"ëª¹ ì‚¬ë§ ì‹œ ì£¼ë³€ ì•„êµ° HP ì „ì²´ íšŒë³µ â†” ìµœëŒ€ ëª¹ìˆ˜ -2",tier:2,
    apply:()=>{run.vil.passives.sacrifice=true;}},
  {id:"vChaos",cat:'ğŸ’€',t:"í˜¼ëˆì˜ ì¶•ë³µ",d:"ëª¨ë“  ìˆ˜ì¹˜ Â±ëœë¤ 30%. ë§¤ ìŠ¤í…Œì´ì§€ ë³€ë™!",tier:2,
    apply:()=>{run.vil.passives.chaos=true;}},
];
/* tier colors */

/* ========== ë§ˆì™• íŠ¹ì„± ê²½ë¡œ (v8.2) ========== */
const VILLAIN_PATHS={
  warlord:{id:'warlord',icon:'ğŸ—¡',name:'êµ°ì£¼',color:'#ef4444',
    desc:'ëª¬ìŠ¤í„° ì „íˆ¬ë ¥ íŠ¹í™”. í”¼í•´Â·í¡í˜ˆÂ·ê´‘í­í™”',
    passive:'ëª¨ë“  ëª¹ ê³µê²©ë ¥ +15%, ì—˜ë¦¬íŠ¸ ì†Œí™˜ í™•ë¥  +',
    onPick:()=>{run.vil.passives.pathWarlordAtk=0.15;},
    perStage:()=>{run.vil.passives.pathWarlordAtk=Math.min((run.vil.passives.pathWarlordAtk||0.15)+0.03,0.45);},
    exclusives:['vVamp','vBerserk','vDeathblow','vPoison','vGlass','vRevive']},
  sorcerer:{id:'sorcerer',icon:'ğŸ”®',name:'ìˆ ì‚¬',color:'#a78bfa',
    desc:'ë§ˆì™• ìŠ¤í‚¬ íŠ¹í™”. ì—ë„ˆì§€Â·ì¿¨ë‹¤ìš´Â·ìŠ¤í‚¬ ê°•í™”',
    passive:'ì—ë„ˆì§€ ì¬ìƒ +50%, ìŠ¤í‚¬ ì¿¨ -10%',
    onPick:()=>{run.vil.passives.pathSorcRegen=0.5;run.vil.passives.pathSorcCd=0.1;},
    perStage:()=>{run.vil.passives.pathSorcRegen=Math.min((run.vil.passives.pathSorcRegen||0.5)+0.1,1.5);run.vil.passives.pathSorcCd=Math.min((run.vil.passives.pathSorcCd||0.1)+0.03,0.4);},
    exclusives:['vEnergy','vCooldown','vMeteorPlus','vCurseAmp']},
  engineer:{id:'engineer',icon:'âš™',name:'ê³µí•™ì',color:'#38bdf8',
    desc:'ìŠ¤í¬ë„ˆÂ·í•¨ì • íŠ¹í™”. ì†Œí™˜ì†ë„Â·í•¨ì •ê°•í™”Â·ëŒ€êµ°ì„¸',
    passive:'ìŠ¤í¬ë„ˆ HP +20%, í•¨ì • í”¼í•´ +25%',
    onPick:()=>{run.vil.passives.pathEngSpHp=0.2;run.vil.passives.pathEngTrap=0.25;},
    perStage:()=>{run.vil.passives.pathEngSpHp=Math.min((run.vil.passives.pathEngSpHp||0.2)+0.05,0.6);run.vil.passives.pathEngTrap=Math.min((run.vil.passives.pathEngTrap||0.25)+0.08,0.8);},
    exclusives:['vSpawn','vSpHp','vDoubleSummon','vTrapBoost','vMobCap']},
  chaos:{id:'chaos',icon:'ğŸ’€',name:'í˜¼ëˆ',color:'#f472b6',
    desc:'ê³ ìœ„í—˜ ê³ ìˆ˜ìµ. ì €ì£¼Â·ë³€ì´Â·ê·¹ë‹¨ì  íŠ¸ë ˆì´ë“œì˜¤í”„',
    passive:'ëª¨ë“  ì €ì£¼ ì—…ê·¸ë ˆì´ë“œ íš¨ê³¼ 2ë°°, ë¦¬ë¡¤ ë¬´ë£Œ',
    onPick:()=>{run.vil.passives.pathChaosAmp=2;run.vil.passives.pathChaosReroll=true;},
    perStage:()=>{/* chaos gets a random bonus each stage */
      const bonuses=['bonusHp','bonusAtk','bonusSpawn'];
      const pick=bonuses[Math.floor(Math.random()*bonuses.length)];
      run.vil[pick]=(run.vil[pick]||0)+1;},
    exclusives:['vGlass','vUnstable','vSacrifice','vChaos','vSplit','vGiant']},
};

/* ========== ê°ì„± ì‹œìŠ¤í…œ (v8.2) ========== */
const AWAKEN_POOL=[
  /* Stage 5 ê°ì„± */
  {stage:5,id:'awk_necro',icon:'ğŸ’€',t:'ì‚¬ë ¹ìˆ ì‚¬',d:'ëª¹ ì‚¬ë§ ì‹œ 50% í™•ë¥ ë¡œ í•´ê³¨ ë³‘ì‚¬(HP 60%, ê³µ 80%) ì†Œí™˜. ìŠ¤í¬ë„ˆ ë¶ˆí•„ìš”!',tier:3,
    apply:()=>{run.vil.passives.necromancer=0.5;}},
  {stage:5,id:'awk_fortress',icon:'ğŸ°',t:'ì‚´ì•„ìˆëŠ” ì„±ë²½',d:'ëª¨ë“  ë²½ì´ ì£¼ë³€ ëª¹ì—ê²Œ ì´ˆë‹¹ 3 í”¼í•´ + ìš©ì‚¬ ì´ë™ ë°©í•´ (2ë°° ëŠë¦¼)',tier:3,
    apply:()=>{run.vil.passives.livingWalls=true;}},
  {stage:5,id:'awk_mirror',icon:'ğŸª',t:'ê±°ìš¸ ì°¨ì›',d:'ìš©ì‚¬ ìŠ¤í‚¬ ì‚¬ìš© ì‹œ 50% í™•ë¥ ë¡œ ê°™ì€ ìŠ¤í‚¬ì„ ì•„êµ°ì—ê²Œ ë°˜ì‚¬',tier:3,
    apply:()=>{run.vil.passives.mirrorSkill=0.5;}},
  {stage:5,id:'awk_gold',icon:'ğŸ’',t:'ë¯¸ë‹¤ìŠ¤ì˜ ì†',d:'ëª¹ì´ ì²˜ì¹˜ë  ë•Œë§ˆë‹¤ 1G íšë“. ëª¨ë“  ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© -2G',tier:3,
    apply:()=>{run.vil.passives.midasTouch=true;}},
  /* Stage 10 ê°ì„± */
  {stage:10,id:'awk_abyss',icon:'ğŸ•³',t:'ì‹¬ì—°ì˜ ë¶€ë¦„',d:'ë§¤ 10ì´ˆë§ˆë‹¤ ëœë¤ ìœ„ì¹˜ì— ì‹¬ì—° í¬íƒˆ ìƒì„±. ìš©ì‚¬ ì ‘ê·¼ ì‹œ ëŒ€ëŸ‰ í”¼í•´ + ê³µí¬(3ì´ˆ ë„ì£¼)',tier:3,
    apply:()=>{run.vil.passives.abyssPortal=true;}},
  {stage:10,id:'awk_hive',icon:'ğŸ',t:'í•˜ì´ë¸Œ ë§ˆì¸ë“œ',d:'ë™ì¼ íƒ€ì… ëª¹ 4ë§ˆë¦¬ ì´ìƒì´ë©´ ì§‘ë‹¨ ì˜ì‹ ë°œë™: ê³µìœ  HPí’€, íšŒí”¼ +30%',tier:3,
    apply:()=>{run.vil.passives.hiveMind=true;}},
  {stage:10,id:'awk_chrono',icon:'â³',t:'ì‹œê°„ ì •ì§€',d:'ë§ˆì™• ì—ë„ˆì§€ 200 ì†Œëª¨: 5ì´ˆê°„ ëª¨ë“  ìš©ì‚¬ ì™„ì „ ì •ì§€ (50ì´ˆ ì¿¨)',tier:3,
    apply:()=>{run.vil.passives.chronoStop=true;}},
  /* Stage 15 ê°ì„± */
  {stage:15,id:'awk_dragon',icon:'ğŸ‰',t:'ë“œë˜ê³¤ ì†Œí™˜',d:'ìµœì¢… ë³‘ê¸°: í™”ë©´ì„ ê°€ë¡œì§€ë¥´ëŠ” ë“œë˜ê³¤ ë¸Œë ˆìŠ¤. ì „ì²´ ìš©ì‚¬ HP 40% í”¼í•´ (60ì´ˆ ì¿¨)',tier:3,
    apply:()=>{run.vil.passives.dragonBreath=true;}},
  {stage:15,id:'awk_corrupt',icon:'ğŸŒ‘',t:'íƒ€ë½ì˜ íŒŒë™',d:'ë§¤ 15ì´ˆë§ˆë‹¤ ê°€ì¥ ê°•í•œ ìš©ì‚¬ 1ëª…ì„ 3ì´ˆê°„ ë™ë£Œ ê³µê²©í•˜ë„ë¡ ì„¸ë‡Œ',tier:3,
    apply:()=>{run.vil.passives.corruptWave=true;}},
  {stage:15,id:'awk_eternal',icon:'â™¾',t:'ì˜ì›ì˜ êµ°ì£¼',d:'ìŠ¤í¬ë„ˆ íŒŒê´´ ë¶ˆê°€ (HP ë¬´í•œ). ëŒ€ì‹  ëª¹ ê³µê²©ë ¥ -30%',tier:3,
    apply:()=>{run.vil.passives.eternalSpawner=true;}},
];

/* ========== ìŠ¤í¬ë„ˆ ìˆ™ë ¨ë„ (v8.2) ========== */
const MASTERY_FAMILIES={
  melee:{name:'ê·¼ì ‘',icon:'âš”',spawners:['s1'],levels:[
    {req:10,desc:'ê³µê²©ë ¥ +10%',key:'mastMeleeAtk',val:0.1},
    {req:25,desc:'HP +15%',key:'mastMeleeHp',val:0.15},
    {req:50,desc:'ê´‘ì „ì‚¬ ìë™ ë°œë™',key:'mastMeleeBerserk',val:true},
    {req:80,desc:'ê°€ì‹œë°˜ì‚¬ 5',key:'mastMeleeThorns',val:5},
  ]},
  ranged:{name:'ì›ê±°ë¦¬',icon:'ğŸ¹',spawners:['s2'],levels:[
    {req:10,desc:'ì‚¬ê±°ë¦¬ +15%',key:'mastRangeRange',val:0.15},
    {req:25,desc:'íƒ„ì† +20%',key:'mastRangeSpeed',val:0.2},
    {req:50,desc:'ê´€í†µ +1',key:'mastRangePierce',val:1},
    {req:80,desc:'ì´ì¤‘ ì‚¬ê²©',key:'mastRangeDouble',val:true},
  ]},
  poison:{name:'ë…',icon:'â˜ ',spawners:['s3'],levels:[
    {req:10,desc:'ë… í”¼í•´ +20%',key:'mastPoisonDmg',val:0.2},
    {req:25,desc:'ë… ì§€ì† +2ì´ˆ',key:'mastPoisonDur',val:2},
    {req:50,desc:'ì¥íŒ í¬ê¸° +30%',key:'mastPoisonArea',val:0.3},
    {req:80,desc:'ë§¹ë… (ìŠ¤íƒ)',key:'mastPoisonStack',val:true},
  ]},
  bomb:{name:'í­íƒ„',icon:'ğŸ’£',spawners:['s4'],levels:[
    {req:10,desc:'í­ë°œ ë²”ìœ„ +15%',key:'mastBombRadius',val:0.15},
    {req:25,desc:'í­ë°œ í”¼í•´ +25%',key:'mastBombDmg',val:0.25},
    {req:50,desc:'ì—°ì‡„ í­ë°œ 20%',key:'mastBombChain',val:0.2},
    {req:80,desc:'í•µí­ë°œ (ì¦‰ì‚¬ê¸°)',key:'mastBombNuke',val:true},
  ]},
  speed:{name:'ì†ë„',icon:'ğŸ’¨',spawners:['s5'],levels:[
    {req:10,desc:'ì´ì† +15%',key:'mastSpeedSpd',val:0.15},
    {req:25,desc:'íšŒí”¼ +10%',key:'mastSpeedDodge',val:0.1},
    {req:50,desc:'ë¶„ì‹  ìƒì„± 20%',key:'mastSpeedClone',val:0.2},
    {req:80,desc:'ì‹œê°„ì™œê³¡ ì˜¤ë¼',key:'mastSpeedWarp',val:true},
  ]},
  slime:{name:'ìŠ¬ë¼ì„',icon:'ğŸŸ¢',spawners:['s6'],levels:[
    {req:10,desc:'ë¶„ì—´ ìˆ˜ +1',key:'mastSlimeSplit',val:1},
    {req:25,desc:'ì•„ê¸° HP +30%',key:'mastSlimeBabyHp',val:0.3},
    {req:50,desc:'í‚¹ìŠ¬ë¼ì„ ì†Œí™˜í™•ë¥ ',key:'mastSlimeKing',val:0.15},
    {req:80,desc:'ë¬´í•œë¶„ì—´ (3ë‹¨ê³„)',key:'mastSlimeInfinite',val:true},
  ]},
};

const TIER_COLORS=['var(--muted)','var(--blue)','var(--purple)','var(--gold)'];
const TIER_NAMES=['ì¼ë°˜','í¬ê·€','ì „ì„¤','ê°ì„±'];

function processResult(st){
  if(!run) return;
  const heroWin=(st.endText||'').includes('ìš©ì‚¬ ìŠ¹ë¦¬');
  const villainWin=!heroWin;
  const baseGold=villainWin?12:5;
  const stageBonus=Math.floor(run.stage*1.5);
  let reward=baseGold+stageBonus;
  /* v8.2 PASSIVE: interest */
  const rp=run.vil.passives||{};
  if(rp.interest){const interest=Math.min(Math.floor(run.gold*0.1),8);reward+=interest;}
  run.gold+=reward;
  if(villainWin){
    run.stage++;run.stats.wins++;run.vil.level=(run.vil.level||0)+1;
    run.heroUp.gHP*=1.03;run.heroUp.gAtk*=1.04;
    /* v8.2 PATH per-stage bonus */
    if(run.vilPath&&VILLAIN_PATHS[run.vilPath]&&VILLAIN_PATHS[run.vilPath].perStage)VILLAIN_PATHS[run.vilPath].perStage();
  }else{
    run.stats.losses++;
  }
  // â˜… RESTORE MAP: remove battle walls, keep spawners
  restoreMapAfterBattle(st);
  openResultOverlay(villainWin,reward);
}

function restoreMapAfterBattle(st){
  // Remove any walls placed during battle (villain Wall skill)
  if(st&&st.battleWalls){
    for(const bw of st.battleWalls){
      if(inBounds(bw.x,bw.y)&&mapData[bw.y][bw.x]===TILE.wall){
        mapData[bw.y][bw.x]=bw.prev;
      }
    }
  }
  // Spawners stay on the map! No map reload!
}

let pickedUpgrade=null;
function openResultOverlay(win,reward){
  const ov=document.getElementById('resultOverlay');
  document.getElementById('resultTitle').textContent=win?'ğŸ‰ ë§ˆì™• ë°©ì–´ ì„±ê³µ!':'ğŸ’€ ë§ˆì™•ì„± í•¨ë½!';
  document.getElementById('resultKpi').innerHTML=`<span class="pill">ğŸ’° ${run.gold}G</span><span class="pill">Stage ${run.stage}</span><span class="pill">ìŠ¹ ${run.stats.wins} / íŒ¨ ${run.stats.losses}</span>`;

  const choices=document.getElementById('resultChoices');
  const confirm=document.getElementById('resultConfirm');
  pickedUpgrade=null;confirm.disabled=true;

  /* === PHASE 1: Path selection (stage 2, if no path chosen) === */
  if(run.stage===2&&!run.vilPath){
    document.getElementById('resultSub').innerHTML=`<b style="color:var(--gold)">ğŸŒ³ ë§ˆì™• íŠ¹ì„± ê²½ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”!</b><br>ì´í›„ í•´ë‹¹ ê²½ë¡œ ì „ìš© ì—…ê·¸ë ˆì´ë“œê°€ í•´ê¸ˆë©ë‹ˆë‹¤.`;
    choices.innerHTML='';
    Object.values(VILLAIN_PATHS).forEach(p=>{
      const d=document.createElement('div');d.className='resultChoice';
      d.style.borderLeft=`3px solid ${p.color}`;
      d.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div class="t">${p.icon} ${p.name}</div><span class="badge" style="color:${p.color};font-size:10px">ê²½ë¡œ</span></div><div class="d"><b>${p.desc}</b><br><span style="opacity:.7">ê¸°ë³¸: ${p.passive}</span></div>`;
      d.onclick=()=>{[...choices.children].forEach(c=>c.classList.remove('active'));d.classList.add('active');pickedUpgrade={apply:()=>{run.vilPath=p.id;p.onPick();}};confirm.disabled=false;};
      choices.appendChild(d);
    });
    confirm.onclick=()=>{if(!pickedUpgrade)return;pickedUpgrade.apply();ov.style.display='none';run.phase='shop';generateShop();refreshAllUI();activateTab('prep');};
    ov.style.display='flex';
    return;
  }

  /* === PHASE 2: Awakening milestones (stage 5,10,15) === */
  const awakeningStages=[5,10,15];
  if(awakeningStages.includes(run.stage)){
    const pool=AWAKEN_POOL.filter(a=>a.stage===run.stage&&!run.awakenings.includes(a.id));
    if(pool.length>0){
      document.getElementById('resultSub').innerHTML=`<b style="color:var(--gold)">âš¡ ê°ì„±! (Stage ${run.stage} ë§ˆì¼ìŠ¤í†¤)</b><br>ê°•ë ¥í•œ ê°ì„± ëŠ¥ë ¥ì„ ì„ íƒí•˜ì„¸ìš”.`;
      choices.innerHTML='';
      const picks=shuffle([...pool]).slice(0,3);
      picks.forEach(u=>{
        const d=document.createElement('div');d.className='resultChoice';
        d.style.borderLeft='3px solid var(--gold)';d.style.background='rgba(251,191,36,.08)';
        d.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div class="t">${u.icon} ${u.t}</div><span class="badge" style="color:var(--gold);font-size:10px">ê°ì„±</span></div><div class="d">${u.d}</div>`;
        d.onclick=()=>{[...choices.children].forEach(c=>c.classList.remove('active'));d.classList.add('active');pickedUpgrade=u;confirm.disabled=false;};
        choices.appendChild(d);
      });
      confirm.onclick=()=>{if(!pickedUpgrade)return;pickedUpgrade.apply();run.awakenings.push(pickedUpgrade.id);ov.style.display='none';run.phase='shop';generateShop();refreshAllUI();activateTab('prep');};
      ov.style.display='flex';
      return;
    }
  }

  /* === PHASE 3: Normal upgrade (with path-exclusive weighting) === */
  document.getElementById('resultSub').innerHTML=`ë³´ìƒ: <b style="color:var(--gold)">+${reward}G</b> | Stage ${run.stage} | ë§ˆì™• ê°•í™”ë¥¼ 1ê°œ ì„ íƒí•˜ì„¸ìš”.`;
  const tierWeights=run.stage>=6?[0.2,0.4,0.4]:run.stage>=3?[0.35,0.45,0.2]:[0.6,0.35,0.05];
  /* boost path-exclusive upgrades */
  let available=shuffle([...UPGRADE_POOL]);
  if(run.vilPath){
    const pathDef=VILLAIN_PATHS[run.vilPath];
    if(pathDef&&pathDef.exclusives){
      /* move exclusives to front for higher pick chance */
      const excl=available.filter(u=>pathDef.exclusives.includes(u.id));
      const rest=available.filter(u=>!pathDef.exclusives.includes(u.id));
      available=[...shuffle(excl),...shuffle(rest)];
    }
  }
  let pool=[];
  for(let i=0;i<3&&available.length>0;i++){
    const roll=Math.random();let cumul=0;let targetTier=0;
    for(let t=0;t<tierWeights.length;t++){cumul+=tierWeights[t];if(roll<=cumul){targetTier=t;break;}}
    const idx=available.findIndex(u=>u.tier===targetTier)||0;
    const pick=idx>=0?available.splice(idx,1)[0]:available.shift();
    if(pick)pool.push(pick);
  }
  if(pool.length<3){while(pool.length<3&&available.length)pool.push(available.shift());}
  choices.innerHTML='';
  pool.forEach(u=>{
    const d=document.createElement('div');d.className='resultChoice';
    const tierCol=TIER_COLORS[u.tier||0];const tierName=TIER_NAMES[u.tier||0];
    const isExcl=run.vilPath&&VILLAIN_PATHS[run.vilPath]&&VILLAIN_PATHS[run.vilPath].exclusives&&VILLAIN_PATHS[run.vilPath].exclusives.includes(u.id);
    d.style.borderLeft=`3px solid ${tierCol}`;
    if(isExcl)d.style.background='rgba(251,191,36,.06)';
    d.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div class="t">${u.cat||''} ${u.t}${isExcl?' â˜…':''}</div><span class="badge" style="color:${tierCol};font-size:10px">${tierName}</span></div><div class="d">${u.d}</div>`;
    d.onclick=()=>{[...choices.children].forEach(c=>c.classList.remove('active'));d.classList.add('active');pickedUpgrade=u;confirm.disabled=false;};
    choices.appendChild(d);
  });
  confirm.onclick=()=>{
    if(!pickedUpgrade) return;
    pickedUpgrade.apply();
    ov.style.display='none';
    run.phase='shop';
    generateShop();
    refreshAllUI();
    activateTab('prep');
  };
  ov.style.display='flex';
}


/* ========== DRAWING ========== */
const prepCanvas=document.getElementById('prepCanvas'),prctx=prepCanvas.getContext('2d');
const pCanvas=document.getElementById('playCanvas'),pctx=pCanvas.getContext('2d');

function drawMap(ctx,w,h,highlightFloor){
  ctx.clearRect(0,0,w,h);
  const pad=12,cW=Math.floor((w-pad*2)/mapW),cH=Math.floor((h-pad*2)/mapH),cs=Math.min(cW,cH),ox=pad,oy=pad;
  for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){
    const t=tileInfo(mapData[y][x]),px=ox+x*cs,py=oy+y*cs;
    ctx.fillStyle=t.color;ctx.fillRect(px,py,cs,cs);
    ctx.strokeStyle='rgba(255,255,255,.06)';ctx.strokeRect(px,py,cs,cs);
    const _timg=TILE_IMG[mapData[y][x]]?getImg(TILE_IMG[mapData[y][x]]):null;if(_timg){ctx.drawImage(_timg,px+1,py+1,cs-2,cs-2);}else if(t.icon){ctx.fillStyle=t.text||'#fff';ctx.font=`${Math.floor(cs*.5)}px system-ui`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(t.icon,px+cs/2,py+cs/2+1);}
    // Highlight placeable floor
    if(mapData[y][x]===TILE.floor&&highlightFloor){
      ctx.strokeStyle='rgba(96,165,250,.3)';ctx.lineWidth=1;ctx.strokeRect(px+1,py+1,cs-2,cs-2);ctx.lineWidth=1;
    }
  }
  return{cs,ox,oy};
}

function drawPrepCanvas(){
  const{cs,ox,oy}=drawMap(prctx,prepCanvas.width,prepCanvas.height,!!selectedBenchTile);
  if(selectedBenchTile){
    const def=SPAWNER_DEFS[selectedBenchTile]||tileInfo(selectedBenchTile);
    prctx.font='bold 12px system-ui';prctx.textAlign='left';prctx.fillStyle='rgba(251,191,36,.9)';
    prctx.fillText(`ë°°ì¹˜ ì¤‘: ${def?.name||selectedBenchTile} â€” ë¹ˆ ë°”ë‹¥(.) í´ë¦­`,14,prepCanvas.height-10);
  }
}

function drawPlay(st){
  const w=pCanvas.width,h=pCanvas.height;pctx.clearRect(0,0,w,h);
  let sx=0,sy=0;if(st.shakeT>0){sx=rand(-st.shakePow,st.shakePow);sy=rand(-st.shakePow,st.shakePow);}
  pctx.save();pctx.translate(sx,sy);
  for(let y=0;y<mapH;y++)for(let x=0;x<mapW;x++){const t=tileInfo(mapData[y][x]),px=st.ox+x*st.cs,py=st.oy+y*st.cs;pctx.fillStyle=t.color;pctx.fillRect(px,py,st.cs,st.cs);pctx.strokeStyle='rgba(255,255,255,.06)';pctx.strokeRect(px,py,st.cs,st.cs);const _timg2=TILE_IMG[mapData[y][x]]?getImg(TILE_IMG[mapData[y][x]]):null;if(_timg2){pctx.drawImage(_timg2,px+1,py+1,st.cs-2,st.cs-2);}else if(t.icon){pctx.fillStyle=t.text||'#fff';pctx.font=`${Math.floor(st.cs*.5)}px system-ui`;pctx.textAlign='center';pctx.textBaseline='middle';pctx.fillText(t.icon,px+st.cs/2,py+st.cs/2+1);}}
  for(const c of st.chests){if(!c.alive)continue;const pulse=.7+Math.sin(st.time*4)*.3;pctx.fillStyle=`rgba(252,211,77,${pulse*.4})`;pctx.beginPath();pctx.arc(c.x,c.y,16,0,Math.PI*2);pctx.fill();}
  for(const sp of st.spawners){if(!sp.alive)continue;const hp=clamp(sp.hp/st.s.spawnerHP,0,1);pctx.fillStyle='rgba(0,0,0,.5)';pctx.fillRect(sp.x-18,sp.y-26,36,5);pctx.fillStyle='rgba(239,68,68,.95)';pctx.fillRect(sp.x-18,sp.y-26,36*hp,5);}
  for(const m of st.mobs){if(!m.alive)continue;const a=m.aggrod?1:.55;pctx.save();pctx.globalAlpha=a;const _mimg=getImg(MOB_IMG[m.type]);const _mr=m.radius*2.2;if(_mimg){pctx.drawImage(_mimg,m.x-_mr,m.y-_mr,_mr*2,_mr*2);}else{pctx.fillStyle=mobColor(m.type);pctx.beginPath();pctx.arc(m.x,m.y,m.radius,0,Math.PI*2);pctx.fill();}pctx.restore();
    if(m.type===MobType.eliteA||m.type===MobType.eliteB||m.type===MobType.eliteC){pctx.strokeStyle='rgba(251,191,36,.95)';pctx.lineWidth=3;pctx.beginPath();pctx.arc(m.x,m.y,m.radius+6,0,Math.PI*2);pctx.stroke();pctx.lineWidth=1;}
    const hp=clamp(m.hp/m.maxHp,0,1);pctx.fillStyle='rgba(0,0,0,.5)';pctx.fillRect(m.x-14,m.y-(m.radius+10),28,4);pctx.fillStyle='rgba(255,255,255,.85)';pctx.fillRect(m.x-14,m.y-(m.radius+10),28*hp,4);
  }
  for(const b of st.bullets){if(!b.alive)continue;const _bkey=b.owner==='hero'?'bullet_hero':'bullet_mob';const _bimg=getImg(_bkey);if(_bimg){pctx.save();const _ba=Math.atan2(b.vy||0,b.vx||0);pctx.translate(b.x,b.y);pctx.rotate(_ba);pctx.drawImage(_bimg,-8,-8,16,16);pctx.restore();}else{pctx.fillStyle=b.c;pctx.beginPath();pctx.arc(b.x,b.y,3.2,0,Math.PI*2);pctx.fill();}}
  for(const hr of st.heroes){if(hr.dead)continue;
    pctx.fillStyle='rgba(0,0,0,.3)';pctx.beginPath();pctx.arc(hr.x,hr.y+10,10,0,Math.PI*2);pctx.fill();
    const _himg=getImg(HERO_IMG[hr.kind]);if(_himg){pctx.drawImage(_himg,hr.x-18,hr.y-22,36,36);}else{pctx.font='26px system-ui';pctx.textAlign='center';pctx.textBaseline='middle';pctx.lineWidth=5;pctx.strokeStyle='rgba(0,0,0,.8)';pctx.strokeText(hr.icon,hr.x,hr.y);pctx.fillStyle=hr.color;pctx.fillText(hr.icon,hr.x,hr.y);}pctx.lineWidth=1;
    if(hr.shieldT>0){pctx.strokeStyle='rgba(34,197,94,.85)';pctx.lineWidth=3;pctx.beginPath();pctx.arc(hr.x,hr.y,18,0,Math.PI*2);pctx.stroke();}
    pctx.lineWidth=1;const hp=clamp(hr.hp/hr.maxHp,0,1);pctx.fillStyle='rgba(0,0,0,.5)';pctx.fillRect(hr.x-18,hr.y-26,36,5);pctx.fillStyle='rgba(34,197,94,.95)';pctx.fillRect(hr.x-18,hr.y-26,36*hp,5);
  }
  for(const f of st.fx){const t=f.t/f.life;
    if(f.k==='circle'){pctx.strokeStyle=f.c;pctx.lineWidth=f.w||2;pctx.beginPath();pctx.arc(f.x,f.y,f.r*(.85+.2*t),0,Math.PI*2);pctx.stroke();}
    else if(f.k==='shock'){pctx.strokeStyle=f.c;pctx.lineWidth=2;pctx.beginPath();pctx.arc(f.x,f.y,f.r*(.6+.8*t),0,Math.PI*2);pctx.stroke();}
    else if(f.k==='text'){pctx.font='bold 14px system-ui';pctx.textAlign='center';pctx.textBaseline='middle';const yy=f.y-16*t;pctx.lineWidth=3;pctx.strokeStyle=f.ol||'#000';pctx.strokeText(f.txt,f.x,yy);pctx.fillStyle=f.c;pctx.fillText(f.txt,f.x,yy);}
    else if(f.k==='line'){pctx.strokeStyle=f.c;pctx.lineWidth=f.w||2;pctx.beginPath();pctx.moveTo(f.x1,f.y1);pctx.lineTo(f.x2,f.y2);pctx.stroke();}
    else if(f.k==='spark'){const px=f.x+f.vx*f.t,py=f.y+f.vy*f.t;pctx.fillStyle=f.c;pctx.beginPath();pctx.arc(px,py,2.2,0,Math.PI*2);pctx.fill();}
    else if(f.k==='zone'){pctx.fillStyle=f.c;pctx.beginPath();pctx.arc(f.x,f.y,f.r,0,Math.PI*2);pctx.fill();}
    pctx.lineWidth=1;
  }
  if(st.running&&!st.paused&&!st.ended&&selectedCastSkill){const sk=selectedCastSkill;if(sk.r>0){pctx.strokeStyle='rgba(255,255,255,.85)';pctx.lineWidth=2;pctx.beginPath();pctx.arc(mouseWorld.x,mouseWorld.y,sk.r,0,Math.PI*2);pctx.stroke();}}
  if(st.ended){pctx.fillStyle='rgba(0,0,0,.55)';pctx.fillRect(0,0,w,h);pctx.font='bold 24px system-ui';pctx.textAlign='center';pctx.textBaseline='middle';pctx.fillStyle='#fff';pctx.fillText(st.endText||'END',w/2,h/2);}
  pctx.restore();
}

/* ========== UI REFRESH ========== */

function refreshMasteryUI(){
  let bar=document.getElementById('masteryBar');
  if(!bar){/* create it */
    const adaptBar=document.getElementById('adaptBar');
    if(!adaptBar)return;
    bar=document.createElement('div');bar.id='masteryBar';bar.style.cssText='margin-top:6px;display:flex;flex-wrap:wrap;gap:4px;';
    adaptBar.parentNode.insertBefore(bar,adaptBar.nextSibling);
  }
  bar.innerHTML='';
  if(!run||!run.mastery)return;
  Object.entries(MASTERY_FAMILIES).forEach(([fam,def])=>{
    const m=run.mastery[fam]||{kills:0,level:0};
    const nextLvl=def.levels[m.level];
    const maxed=m.level>=def.levels.length;
    const d=document.createElement('div');
    d.style.cssText='background:rgba(255,255,255,.06);border-radius:6px;padding:3px 7px;font-size:10px;min-width:100px;';
    if(maxed)d.style.border='1px solid var(--gold)';
    let html=`<b>${def.icon} ${def.name}</b> Lv.${m.level}/${def.levels.length} (${m.kills}í‚¬)`;
    if(nextLvl)html+=`<br><span style="opacity:.6">ë‹¤ìŒ: ${nextLvl.req}í‚¬ â†’ ${nextLvl.desc}</span>`;
    else html+=`<br><span style="color:var(--gold)">MAX âœ¦</span>`;
    /* show unlocked bonuses */
    for(let i=0;i<m.level;i++){
      html+=`<br><span style="color:var(--blue);font-size:9px">âœ“ ${def.levels[i].desc}</span>`;
    }
    d.innerHTML=html;
    bar.appendChild(d);
  });
}

function refreshPathUI(){
  let bar=document.getElementById('pathBar');
  if(!bar){
    const adaptBar=document.getElementById('adaptBar');
    if(!adaptBar)return;
    bar=document.createElement('div');bar.id='pathBar';bar.style.cssText='margin-bottom:6px;';
    adaptBar.parentNode.insertBefore(bar,adaptBar);
  }
  bar.innerHTML='';
  if(!run)return;
  if(run.vilPath){
    const p=VILLAIN_PATHS[run.vilPath];
    bar.innerHTML=`<div style="background:${p.color}22;border:1px solid ${p.color};border-radius:8px;padding:5px 10px;font-size:11px;"><b>${p.icon} ${p.name} ê²½ë¡œ</b> â€” ${p.desc}<br><span style="opacity:.7;font-size:10px">${p.passive}</span></div>`;
  }else if(run.stage<2){
    bar.innerHTML=`<div style="opacity:.5;font-size:10px;">ğŸŒ³ Stage 2ì—ì„œ íŠ¹ì„± ê²½ë¡œë¥¼ ì„ íƒí•©ë‹ˆë‹¤</div>`;
  }
  /* show awakenings */
  if(run.awakenings&&run.awakenings.length>0){
    const awks=run.awakenings.map(id=>{const a=AWAKEN_POOL.find(p=>p.id===id);return a?`${a.icon} ${a.t}`:'?';}).join(' Â· ');
    bar.innerHTML+=`<div style="margin-top:4px;font-size:10px;color:var(--gold);">âš¡ ê°ì„±: ${awks}</div>`;
  }
}

function refreshFusionUI(){
  const grid=document.getElementById('fusionGrid');grid.innerHTML='';
  if(!run) return;
  FUSION_RECIPES.forEach(r=>{
    const hasA=countItem(r.a)>=1,hasB=countItem(r.b)>=1,hasGold=run.gold>=r.cost;
    const canFuse=hasA&&hasB&&hasGold;
    const d=document.createElement('div');
    d.className='fusionCard'+(canFuse?' available':'');
    const defA=SPAWNER_DEFS[r.a]||{icon:'?',name:'?'};
    const defB=SPAWNER_DEFS[r.b]||{icon:'?',name:'?'};
    d.innerHTML=`<div class="fcIcon">${r.icon}</div><div class="fcName">${r.name}</div><div class="fcRecipe">${defA.icon}${defA.name} + ${defB.icon}${defB.name}</div><div class="fcCost">${r.cost}G</div>`;
    if(canFuse){d.onclick=()=>{tryFusion(r);refreshFusionUI();};}
    grid.appendChild(d);
  });
}

function refreshAdaptUI(){
  const bar=document.getElementById('adaptBar');bar.innerHTML='';
  if(!run||!run.adaptActive) return;
  Object.entries(run.adaptActive).forEach(([cause,info])=>{
    const d=document.createElement('div');
    d.className='adaptBadge top';
    let effectsHtml=info.effects?info.effects.map(e=>{
      const v=e.key==='reduction'?`${(e.val*100)|0}%`:
        (e.unit==='ì´ˆ'?`${e.val.toFixed(1)}ì´ˆ`:
        (e.val<1?`${(e.val*100)|0}%`:`${e.val|0}`));
      return `<span style="font-size:10px;opacity:.8">${e.label}:${v}</span>`;
    }).join(' Â· '):'';
    d.innerHTML=`<div><b>${info.icon} ${info.name}</b> (ì‚¬ë§ ${info.count}íšŒ)</div><div style="font-size:10px;margin-top:2px">${effectsHtml}</div>`;
    bar.appendChild(d);
  });
  if(run.adapt){
    Object.entries(run.adapt).filter(([k,v])=>v>0&&!run.adaptActive[k]).forEach(([k,v])=>{
      const names={poison:'ë…',trap:'í•¨ì •',mob:'ê·¼ì ‘',bullet:'íƒ„í™˜',boss:'ë³´ìŠ¤',aoe:'ë²”ìœ„'};
      const d=document.createElement('div');d.className='adaptBadge';
      d.innerHTML=`${names[k]||k}: ${v}íšŒ (ë¹„í™œì„±)`;bar.appendChild(d);
    });
  }
}

function refreshAllUI(){
  refreshTopKpi();refreshPrepKpi();refreshShopUI();refreshBenchUI();refreshSynergyUI();refreshFusionUI();refreshAdaptUI();refreshMasteryUI();refreshPathUI();drawPrepCanvas();
  document.getElementById('stageNum').textContent=run?run.stage:1;
  document.getElementById('placeInfo').textContent=`ë°°ì¹˜: ${getPlacedSpawners().length}`;
  const label=document.getElementById('phaseLabel');
  if(run){
    if(run.phase==='shop') label.textContent='ğŸ›’ ìƒì  â€” ìŠ¤í¬ë„ˆë¥¼ êµ¬ë§¤í•˜ê³  ììœ ë¡­ê²Œ ë°°ì¹˜í•˜ì„¸ìš”';
    else if(run.phase==='battle') label.textContent='âš”ï¸ ì „íˆ¬ ì§„í–‰ ì¤‘!';
    else if(run.phase==='result') label.textContent='ğŸ“Š ê²°ê³¼';
  }
}

function refreshTopKpi(){
  document.getElementById('topKpi').innerHTML=run?
    `<span class="pill">Stage ${run.stage}</span><span class="pill">ğŸ’° ${run.gold}G</span><span class="pill">ë°°ì¹˜ ${getPlacedSpawners().length}</span>`
    :'<span class="pill">ì—ë””í„°ì—ì„œ ë§µì„ ë§Œë“  í›„ ê²Œì„ ì‹œì‘</span>';
}

function refreshPrepKpi(){
  document.getElementById('prepKpi').innerHTML=run?
    `<span class="pill">ğŸ’° ${run.gold}G</span><span class="pill">Stage ${run.stage}</span><span class="pill">${run.vilPath?VILLAIN_PATHS[run.vilPath].icon+' '+VILLAIN_PATHS[run.vilPath].name:'ë¯¸ì„ íƒ'}</span><span class="pill">ìœ„í˜‘ë„ ${run.vil.level||0}</span><span class="pill">ìš©ì‚¬ HPÃ—${run.heroUp.gHP.toFixed(2)}</span>`+
    (()=>{const p=run.vil.passives||{};const tags=[];
      if(p.vampRate)tags.push('ğŸ©¸í¡í˜ˆ');if(p.berserk)tags.push('ğŸ˜¡ê´‘ì „ì‚¬');if(p.poisonMelee)tags.push('â˜ ë…ë¬´ê¸°');
      if(p.critChance)tags.push('ğŸ’¥í¬ë¦¬');if(p.giantElite)tags.push('ğŸ‘¹ê±°ëŒ€í™”');if(p.rallyBonus)tags.push('ğŸ¤ê²°ì§‘');
      if(p.mobRegen)tags.push('ğŸ’šì¬ìƒ');if(p.reviveChance)tags.push('ğŸ’€ë¶ˆì‚¬');if(p.deathSplit)tags.push('ğŸ§¬ë¶„ì—´');
      if(p.doubleSummon)tags.push('ğŸ‘¥ì´ì¤‘ì†Œí™˜');if(p.trapBoost)tags.push('âš¡í•¨ì •ê°•í™”');if(p.mobCapBonus)tags.push('ğŸ€ëŒ€êµ°ì„¸');
      if(p.extraEnergy)tags.push('ğŸ”®ì—ë„ˆì§€');if(p.cdReduction)tags.push('â±ì¿¨ê°');if(p.meteorBoost)tags.push('â˜„í˜œì„±');
      if(p.curseAmp)tags.push('ğŸŒ€ì €ì£¼ê°•í™”');if(p.interest)tags.push('ğŸ’°ì´ì');if(p.shopDiscount)tags.push('ğŸªí• ì¸');
      if(p.heroBounty)tags.push('ğŸ¯í˜„ìƒê¸ˆ');if(p.glass)tags.push('ğŸ—¡ìœ ë¦¬ëŒ€í¬');if(p.unstable)tags.push('âš¡ë¶ˆì•ˆì •');
      if(p.sacrifice)tags.push('ğŸ©¸ì œë¬¼');if(p.chaos)tags.push('ğŸŒ€í˜¼ëˆ');if(p.spawnerThorns)tags.push('ğŸŒµê°€ì‹œ');
      return tags.length?'<br>'+tags.map(t=>`<span class="pill">${t}</span>`).join(''):'';
    })()
    :'';
}

function refreshShopUI(){
  const grid=document.getElementById('shopGrid');grid.innerHTML='';
  if(!run) return;
  run.shop.forEach((item,idx)=>{
    const def=SPAWNER_DEFS[item.tile]||{name:tileInfo(item.tile).name,icon:tileInfo(item.tile).icon,desc:tileInfo(item.tile).name,color:'#888',tier:0};
    const d=document.createElement('div');
    d.className='shopCard'+(item.sold?' sold':'');
    d.innerHTML=`<div class="scTier">T${def.tier||0}</div><div class="scIcon" style="color:${def.color||'#fff'}">${def.icon||'?'}</div><div class="scName">${def.name||item.tile}</div><div class="scDesc">${def.desc||''}</div><div class="scCost">${item.cost}G</div>`;
    if(!item.sold){
      d.onclick=()=>{
        if(run.gold<item.cost) return;
        buyCard(idx);
      };
    }
    grid.appendChild(d);
  });
}

function refreshBenchUI(){
  const bench=document.getElementById('bench');bench.innerHTML='';
  if(!run) return;
  run.bench.forEach(b=>{
    const def=SPAWNER_DEFS[b.tile]||{icon:tileInfo(b.tile).icon,name:tileInfo(b.tile).name,color:'#888'};
    // Show total count (bench + placed) for merge info
    const placedCnt=getPlacedSpawners().filter(p=>p.t===b.tile).length;
    const totalStr=placedCnt>0?` (ë§µ:${placedCnt})`:'';
    const d=document.createElement('div');
    d.className='benchItem'+(selectedBenchTile===b.tile?' selected':'');
    d.innerHTML=`<div class="biIcon" style="color:${def.color||'#fff'}">${def.icon||'?'}</div><div class="biName">${def.name||b.tile}</div>${b.count>0?`<div class="biCount">Ã—${b.count}${totalStr}</div>`:''}`
    d.onclick=()=>{
      selectedBenchTile=(selectedBenchTile===b.tile)?null:b.tile;
      refreshBenchUI();
      drawPrepCanvas();
    };
    bench.appendChild(d);
  });
}

function refreshSynergyUI(){
  const bar=document.getElementById('synergyBar');bar.innerHTML='';
  const syn=computeSynergies();
  SYNERGY_DEFS.forEach(sd=>{
    const info=syn[sd.id];
    if(!info) return;
    const active=info.threshold!=null;
    const d=document.createElement('div');
    d.className='synBadge'+(active?' active':'');
    const tLabel=sd.thresholds.map(th=>`${th.n}`).join('/');
    d.innerHTML=`<span class="synIcon">${sd.icon}</span><span>${sd.name}</span><span class="synCount">${info.count}/${tLabel}</span>`;
    if(active) d.title=info.threshold.desc;
    bar.appendChild(d);
  });
}

function hudUpdate(st){
  const sa=st.spawners.filter(s=>s.alive).length;
  document.getElementById('hud').innerHTML=`<span class="pill">Stage ${run?run.stage:1}</span><span class="pill">${st.time.toFixed(1)}s/${st.s.sessionLimit}s</span><span class="pill">ìš©ì‚¬ ${st.heroes.filter(h=>!h.dead).length}/${st.heroes.length}</span><span class="pill">ìŠ¤í¬ë„ˆ ${sa}</span><span class="pill">ëª¹ ${st.mobs.filter(m=>m.alive).length}</span>`;
  document.getElementById('energyBar').style.width=`${clamp(st.villain.energy/st.villain.maxEnergy,0,1)*100}%`;
  const skills=getVillainSkills(st.s);
  for(const sk of skills){const left=st.villain.cds[sk.id]||0;const bar=document.getElementById('cdbar-'+sk.id);if(bar){bar.style.width=`${left>0?clamp(left/sk.cd,0,1)*100:0}%`;bar.style.background=left>0?'rgba(239,68,68,.95)':'rgba(37,99,235,.95)';}}
}

/* ========== CANVAS INTERACTION ========== */
// Prep canvas click: place on floor or remove spawner
prepCanvas.onclick=e=>{
  if(!run) return;
  const r=prepCanvas.getBoundingClientRect();
  const mx=(e.clientX-r.left)*(prepCanvas.width/r.width);
  const my=(e.clientY-r.top)*(prepCanvas.height/r.height);
  const pad=12,cW=Math.floor((prepCanvas.width-pad*2)/mapW),cH=Math.floor((prepCanvas.height-pad*2)/mapH),cs=Math.min(cW,cH);
  const gx=Math.floor((mx-pad)/cs),gy=Math.floor((my-pad)/cs);
  if(!inBounds(gx,gy)) return;
  if(selectedBenchTile&&canPlaceOn(gx,gy)){
    placeOnFloor(gx,gy);
  }else if(SPAWNER_IDS.includes(mapData[gy][gx])||TRAP_IDS.includes(mapData[gy][gx])){
    removeSpawnerFromMap(gx,gy);
  }
};
prepCanvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const touch=e.touches[0];
  const r=prepCanvas.getBoundingClientRect();
  const mx=(touch.clientX-r.left)*(prepCanvas.width/r.width);
  const my=(touch.clientY-r.top)*(prepCanvas.height/r.height);
  const pad=12,cW=Math.floor((prepCanvas.width-pad*2)/mapW),cH=Math.floor((prepCanvas.height-pad*2)/mapH),cs=Math.min(cW,cH);
  const gx=Math.floor((mx-pad)/cs),gy=Math.floor((my-pad)/cs);
  if(!inBounds(gx,gy)) return;
  if(selectedBenchTile&&canPlaceOn(gx,gy)) placeOnFloor(gx,gy);
  else if(SPAWNER_IDS.includes(mapData[gy][gx])||TRAP_IDS.includes(mapData[gy][gx])) removeSpawnerFromMap(gx,gy);
},{passive:false});

// Battle canvas
let mouseWorld={x:0,y:0};
pCanvas.onmousemove=e=>{const r=pCanvas.getBoundingClientRect();mouseWorld.x=(e.clientX-r.left)*(pCanvas.width/r.width);mouseWorld.y=(e.clientY-r.top)*(pCanvas.height/r.height);};
pCanvas.onclick=()=>{if(!game||!game.running||game.paused||game.ended||!selectedCastSkill)return;castVillainSkill(game,selectedCastSkill,mouseWorld.x,mouseWorld.y);};
document.addEventListener('keydown',e=>{if(e.key==='Escape'){selectedCastSkill=null;[...document.getElementById('villainCards').children].forEach(c=>c.classList.remove('active'));}});

/* ========== BUTTONS ========== */
document.getElementById('btnReroll').onclick=()=>rerollShop();
document.getElementById('btnSell').onclick=()=>{if(selectedBenchTile){sellFromBench(selectedBenchTile);selectedBenchTile=null;refreshAllUI();}};
document.getElementById('btnStartBattle').onclick=()=>{
  if(!run) return;
  if(getPlacedSpawners().length===0){alert('ìŠ¤í¬ë„ˆë¥¼ 1ê°œ ì´ìƒ ë°°ì¹˜í•˜ì„¸ìš”!');return;}
  run.phase='battle';
  buildVillainCards();
  game=makeGameFromMap();
  if(!game) return;
  game.running=true;
  logLines=[];skillLogEl.innerHTML='';selectedCastSkill=null;
  activateTab('battle');
  buildDirectiveUI();
};
document.getElementById('btnEndRun').onclick=()=>{
  if(!confirm('í˜„ì¬ ëŸ°ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  if(game){game.running=false;game.ended=true;}
  game=null;run=null;runActive=false;
  activateTab('editor');
  refreshAllUI();
};
document.getElementById('btnDbg').onclick=()=>{if(!game)return;game.debug=!game.debug;document.getElementById('btnDbg').textContent='ë””ë²„ê·¸: '+(game.debug?'ON':'OFF');};

function buildDirectiveUI(){
  const row=document.getElementById('directiveRow');if(!row)return;
  row.querySelectorAll('button[data-dir]').forEach(btn=>{
    btn.onclick=()=>{
      if(!game||!game.villain)return;
      game.villain.directive=btn.dataset.dir||'auto';
      if(game.mobs)game.mobs.forEach(mm=>{mm.tgtId=null;});
      row.querySelectorAll('button[data-dir]').forEach(b=>b.classList.remove('primary'));
      btn.classList.add('primary');
      logSkill(`ì§€íœ˜ ë³€ê²½: ${btn.textContent}`);
    };
  });
  const def=row.querySelector('button[data-dir="auto"]');if(def)def.classList.add('primary');
}

/* ========== HELP CONTENT (v8.2) ========== */
function buildHelpContent(){
  document.getElementById('helpContent').innerHTML=`
  <div class="helpSection"><div class="hs">ğŸ® ê²Œì„ ë£¨í”„</div><div class="hd">
  1) <b>ì—ë””í„°</b>ì—ì„œ ë§µ ë””ìì¸ (Ctrl+Z ì–¸ë‘, Ctrl+X ë¦¬ë‘)<br>
  2) 'ê²Œì„ ì‹œì‘' â†’ ëŸ° ì‹œì‘. ë§µì€ ëŸ° ì¢…ë£Œê¹Œì§€ ê³ ì •.<br>
  3) <b>ìƒì </b>ì—ì„œ ìŠ¤í¬ë„ˆ êµ¬ë§¤/ë¦¬ë¡¤ (2G)<br>
  4) <b>ììœ  ë°°ì¹˜</b>: ë²¤ì¹˜ â†’ ë§µì˜ ë¹ˆ ë°”ë‹¥ì— ë°°ì¹˜<br>
  5) ë°°ì¹˜í•œ ìŠ¤í¬ë„ˆëŠ” ì˜êµ¬ ìœ ì§€<br>
  6) ê°™ì€ ì¢…ë¥˜ 3ê°œ â†’ <b>3í•© ì§„í™”</b><br>
  7) ê°™ì€ ê³„ì—´ ëª¨ìœ¼ë©´ <b>ì‹œë„ˆì§€</b> ë³´ë„ˆìŠ¤<br>
  8) <b>í•©ì„±</b>: ì„œë¡œ ë‹¤ë¥¸ ê¸°ë³¸ ìŠ¤í¬ë„ˆ 2ì¢… â†’ í•˜ì´ë¸Œë¦¬ë“œ<br>
  9) ì „íˆ¬ ì‹œì‘ â†’ ìë™ ì „íˆ¬ + ë§ˆì™• ìŠ¤í‚¬ë¡œ ê°œì…
  </div></div>

  <div class="helpSection"><div class="hs">ğŸŒ³ ë§ˆì™• íŠ¹ì„± ê²½ë¡œ</div><div class="hd">
  Stage 2 í´ë¦¬ì–´ ì‹œ 4ê°œ ê²½ë¡œ ì¤‘ 1ê°œë¥¼ ì„ íƒí•©ë‹ˆë‹¤:<br>
  <b>ğŸ—¡ êµ°ì£¼</b>: ëª¹ ì „íˆ¬ë ¥ íŠ¹í™” (ê³µê²©ë ¥â†‘, í¡í˜ˆ, ê´‘í­í™”)<br>
  <b>ğŸ”® ìˆ ì‚¬</b>: ë§ˆì™• ìŠ¤í‚¬ íŠ¹í™” (ì—ë„ˆì§€â†‘, ì¿¨ë‹¤ìš´â†“, ìŠ¤í‚¬ ê°•í™”)<br>
  <b>âš™ ê³µí•™ì</b>: ìŠ¤í¬ë„ˆÂ·í•¨ì • íŠ¹í™” (HPâ†‘, ì†Œí™˜â†‘, í•¨ì •â†‘)<br>
  <b>ğŸ’€ í˜¼ëˆ</b>: ê³ ìœ„í—˜ ê³ ìˆ˜ìµ (ì €ì£¼ 2ë°°, ëœë¤ ë³´ë„ˆìŠ¤)<br><br>
  ê²½ë¡œ ì„ íƒ í›„ í•´ë‹¹ ê²½ë¡œ ì „ìš© ì—…ê·¸ë ˆì´ë“œê°€ â˜… í‘œì‹œë¡œ ìš°ì„  ë“±ì¥í•©ë‹ˆë‹¤.
  ë§¤ ìŠ¤í…Œì´ì§€ ê²½ë¡œ ë³´ë„ˆìŠ¤ê°€ ìë™ ì„±ì¥í•©ë‹ˆë‹¤.
  </div></div>

  <div class="helpSection"><div class="hs">âš¡ ê°ì„± ì‹œìŠ¤í…œ</div><div class="hd">
  Stage 5 / 10 / 15 í´ë¦¬ì–´ ì‹œ <b>ê°ì„±</b> ì„ íƒì§€ê°€ ë“±ì¥í•©ë‹ˆë‹¤.<br>
  ì¼ë°˜ ì—…ê·¸ë ˆì´ë“œì™€ ì°¨ì›ì´ ë‹¤ë¥¸ ê°•ë ¥í•œ ê²Œì„ ë³€í™˜ íš¨ê³¼!<br>
  ì˜ˆ: ì‚¬ë ¹ìˆ ì‚¬(ëª¹ ë¶€í™œ), ì‚´ì•„ìˆëŠ” ì„±ë²½, ë¯¸ë‹¤ìŠ¤ì˜ ì†, ë“œë˜ê³¤ ë¸Œë ˆìŠ¤ ë“±
  </div></div>

  <div class="helpSection"><div class="hs">ğŸ“ˆ ìŠ¤í¬ë„ˆ ìˆ™ë ¨ë„</div><div class="hd">
  ê° ìŠ¤í¬ë„ˆ ê³„ì—´(ê·¼ì ‘/ì›ê±°ë¦¬/ë…/í­íƒ„/ì†ë„/ìŠ¬ë¼ì„)ì€ í•´ë‹¹ ëª¹ì˜ ì²˜ì¹˜ íšŸìˆ˜ì— ë”°ë¼ ìë™ ì„±ì¥í•©ë‹ˆë‹¤.<br>
  ë ˆë²¨ë§ˆë‹¤ ê³ ìœ  ë³´ë„ˆìŠ¤ê°€ ì˜êµ¬ ì ìš©ë©ë‹ˆë‹¤!<br>
  ì˜ˆ: ê·¼ì ‘ 50í‚¬ â†’ ê´‘ì „ì‚¬ ìë™ ë°œë™, í­íƒ„ 80í‚¬ â†’ í•µí­ë°œ<br>
  ìˆ™ë ¨ë„ëŠ” ì¤€ë¹„ í™”ë©´ í•˜ë‹¨ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </div></div>

  <div class="helpSection"><div class="hs">ğŸ›¡ ì ì‘ ê°•í™” ì‹œìŠ¤í…œ (v8.2)</div><div class="hd">
  ìš©ì‚¬ ì‚¬ë§ ì›ì¸ì„ ì¶”ì  â†’ ìƒìœ„ 1~2 ì›ì¸ì— <b>ê³ ìœ  ëŒ€ì‘ ëŠ¥ë ¥</b> ë¶€ì—¬!<br><br>
  <b>â˜  ë… ì ì‘</b>: ë… í”¼í•´ ê°ì†Œ + <b>ë… ë©´ì—­ ì‹œê°„</b> + ë… í•¨ì • ë°Ÿìœ¼ë©´ <b>ìë™ ì •í™”</b><br>
  <b>âš¡ í•¨ì • ì ì‘</b>: í•¨ì • í”¼í•´ ê°ì†Œ + <b>í•¨ì • ìœ„ ì´ì† ì¦ê°€</b> + <b>í•¨ì • ê°ì§€ íšŒí”¼</b> (ì£¼ë³€ í•¨ì • ìë™ ìš°íšŒ)<br>
  <b>âš” ê·¼ì ‘ ì ì‘</b>: ê·¼ì ‘ í”¼í•´ ê°ì†Œ + <b>ê°€ì‹œ ë°˜ê²©</b> (í”¼ê²© ì‹œ ë°ë¯¸ì§€ ë°˜ì‚¬) + <b>ìµœëŒ€ HP ì¦ê°€</b><br>
  <b>ğŸ”« íƒ„í™˜ ì ì‘</b>: íƒ„í™˜ í”¼í•´ ê°ì†Œ + <b>íƒ„í™˜ íšŒí”¼</b> (í™•ë¥ ì  ë¬´ì‹œ) + <b>íƒ„í™˜ ë°˜ì‚¬</b> (ë˜ëŒë ¤ë³´ëƒ„)<br>
  <b>ğŸ‘¹ ë³´ìŠ¤ ì ì‘</b>: ë³´ìŠ¤ í”¼í•´ ê°ì†Œ + <b>ë³´ìŠ¤ ì¶”ê°€ í”¼í•´</b> + <b>CC ì €í•­</b> (ìŠ¤í„´/ë¹™ê²° ì‹œê°„ ê°ì†Œ)<br>
  <b>ğŸ’¥ ë²”ìœ„ ì ì‘</b>: ë²”ìœ„ í”¼í•´ ê°ì†Œ + <b>ìë™ ë³´í˜¸ë§‰</b> (í­ë°œ ê°ì§€ ì‹œ ë°œë™) + <b>ì‚°ê°œ ë³¸ëŠ¥</b> (ìš©ì‚¬ ë°€ì§‘ ë°©ì§€)<br><br>
  â€¢ ì‚¬ë§ íšŸìˆ˜ê°€ ëŠ˜ìˆ˜ë¡ íš¨ê³¼ ê°•í™” (ìµœëŒ€ ìº¡ ìˆìŒ)<br>
  â€¢ ìƒìœ„ 2ê°œ ì›ì¸ë§Œ í™œì„±í™”ë¨
  </div></div>

  <div class="helpSection"><div class="hs">âš” ìŠ¤í¬ë„ˆ ê³„ì—´</div><div class="hd">
  <div class="treeRow"><span class="trIcon">âš”</span><span class="trName">ê·¼ì ‘ (S1)</span><span class="trDesc">ê¸°ë³¸ 3G â†’ ğŸ—¡ê·¼ì ‘ìŠ¤í‚¬ / ğŸ”¥ëŒì§„</span></div>
  <div class="treeRow"><span class="trIcon">ğŸ¹</span><span class="trName">ì›ê±°ë¦¬ (S2)</span><span class="trDesc">ê¸°ë³¸ 3G â†’ ğŸ¯ê´€í†µ / ğŸ”­ì €ê²©</span></div>
  <div class="treeRow"><span class="trIcon">ğŸ’š</span><span class="trName">íëŸ¬ (S3)</span><span class="trDesc">ê¸°ë³¸ 4G â†’ ğŸ’–ê°•í™”í / âœ¨ì •í™”</span></div>
  <div class="treeRow"><span class="trIcon">ğŸ’£</span><span class="trName">í­ê²© (S4)</span><span class="trDesc">ê¸°ë³¸ 4G â†’ ğŸ§¬ë¶„ì—´ / ğŸ§Šë¹™ê²°í­ë°œ</span></div>
  <div class="treeRow"><span class="trIcon">â³</span><span class="trName">ì‹œê°„ (S5)</span><span class="trDesc">ê¸°ë³¸ 5G â†’ âš¡ê°€ì† / ğŸ”®ì‹œê°„ì •ì§€</span></div>
  <div class="treeRow"><span class="trIcon">ğŸŸ¢</span><span class="trName">ìŠ¬ë¼ì„ (S6)</span><span class="trDesc">ê¸°ë³¸ 3G â†’ ğŸŸ©ë¶„ì—´(3ë¶„ì—´) / ğŸ‘‘í‚¹ìŠ¬ë¼ì„</span></div>
  </div></div>

  <div class="helpSection"><div class="hs">ğŸŸ¢ ìŠ¬ë¼ì„ íŠ¹ì„± (v8.2)</div><div class="hd">
  â€¢ ê¸°ë³¸ ìŠ¬ë¼ì„: ì£½ìœ¼ë©´ <b>2ë§ˆë¦¬</b>ë¡œ ë¶„ì—´<br>
  â€¢ ë¶„ì—´ ìŠ¬ë¼ì„: ì£½ìœ¼ë©´ <b>3ë§ˆë¦¬</b>ë¡œ ë¶„ì—´<br>
  â€¢ í‚¹ ìŠ¬ë¼ì„: ê°ì† ì˜¤ë¼ + ì£½ìœ¼ë©´ ë²”ìœ„ í”¼í•´+ê°ì†<br>
  â€¢ ì‹œë„ˆì§€ ë³´ë„ˆìŠ¤: 2ê°œ â†’ +1ë¶„ì—´, 4ê°œ â†’ +2ë¶„ì—´
  </div></div>

  <div class="helpSection"><div class="hs">ğŸ”€ í•©ì„± ìŠ¤í¬ë„ˆ (v8.2)</div><div class="hd">
  <div class="treeRow"><span class="trIcon">âš”ğŸ¹</span><span class="trName">ê²€ê¶ì‚¬</span><span class="trDesc">ê·¼ì ‘(S1) + ì›ê±°ë¦¬(S2) = ê·¼ì ‘+ì›ê±°ë¦¬ ê³µê²© (5G)</span></div>
  <div class="treeRow"><span class="trIcon">â˜ ğŸ’£</span><span class="trName">ë…í­íƒ„</span><span class="trDesc">íëŸ¬(S3) + í­ê²©(S4) = ì£½ìœ¼ë©´ ë…ì¥íŒ ìƒì„± (5G)</span></div>
  <div class="treeRow"><span class="trIcon">â³ğŸŸ¢</span><span class="trName">ì‹œê°„ìŠ¬ë¼ì„</span><span class="trDesc">ì‹œê°„(S5) + ìŠ¬ë¼ì„(S6) = ê°ì† ì˜¤ë¼ + ë¶„ì—´ (5G)</span></div>
  </div></div>

  <div class="helpSection"><div class="hs">ğŸ”— ì‹œë„ˆì§€</div><div class="hd">
  <div class="treeRow"><span class="trIcon">âš”</span><span class="trName">ê·¼ì ‘</span><span class="trDesc">2ê°œ: HP+10% / 4ê°œ: HP+25%</span></div>
  <div class="treeRow"><span class="trIcon">ğŸ¹</span><span class="trName">ì›ê±°ë¦¬</span><span class="trDesc">2ê°œ: ì‚¬ê±°ë¦¬+15% / 4ê°œ: ì‚¬ê±°ë¦¬+30%</span></div>
  <div class="treeRow"><span class="trIcon">ğŸ’š</span><span class="trName">ì§€ì›</span><span class="trDesc">2ê°œ: íëŸ‰+30%</span></div>
  <div class="treeRow"><span class="trIcon">ğŸ’£</span><span class="trName">í­ê²©</span><span class="trDesc">2ê°œ: í­ë°œë²”ìœ„+20%</span></div>
  <div class="treeRow"><span class="trIcon">â³</span><span class="trName">ì‹œê°„</span><span class="trDesc">2ê°œ: ì§€ì†ì‹œê°„+25%</span></div>
  <div class="treeRow"><span class="trIcon">ğŸŸ¢</span><span class="trName">ìŠ¬ë¼ì„</span><span class="trDesc">2ê°œ: +1ë¶„ì—´ / 4ê°œ: +2ë¶„ì—´</span></div>
  <div class="treeRow"><span class="trIcon">ğŸ”€</span><span class="trName">í•˜ì´ë¸Œë¦¬ë“œ</span><span class="trDesc">2ê°œ: ì „ì²´ ìŠ¤íƒ¯+15%</span></div>
  </div></div>

  <div class="helpSection"><div class="hs">ğŸ¦¸ ìš©ì‚¬ ìŠ¤í‚¬ (v8.2: í´ë˜ìŠ¤ë‹¹ 4ê°œ)</div><div class="hd">
  <b>âš”ï¸ ì „ì‚¬</b>: ë„ë°œ(ë°©íŒ¨+ì–´ê·¸ë¡œ) Â· ê°•íƒ€(ë²”ìœ„+ê°ì†) Â· ë°©íŒ¨ëŒì§„(ëŒê²©+ìŠ¤í„´) Â· ì „íˆ¬í•¨ì„±(ì•„êµ°ë³´í˜¸ë§‰)<br>
  <b>ğŸ’š íëŸ¬</b>: ì „ì²´í Â· ì •í™”(ë””ë²„í”„í•´ì œ) Â· ë³´í˜¸ë§‰(ì „ì²´ë°©ì–´) Â· ë¶€í™œ(ì‚¬ë§ì•„êµ° ë¶€í™œ)<br>
  <b>ğŸ¹ ì›ë”œ</b>: ì§‘ì¤‘ì‚¬ê²©(ê´€í†µ) Â· í™”ì‚´ë¹„(ë²”ìœ„) Â· ë…í™”ì‚´(ë…ë¶€ì—¬)<br>
  <b>ğŸ”® ë§ˆë²•ì‚¬</b>: íŒŒì´ì–´ë³¼(ë²”ìœ„í­ë°œ) Â· ì²´ì¸ë¼ì´íŠ¸ë‹(4ì—°ì‡„) Â· í…”ë ˆí¬íŠ¸(íšŒí”¼)
  </div></div>

  <div class="helpSection"><div class="hs">ğŸ’° ê²½ì œ</div><div class="hd">
  ê¸°ë³¸ ìˆ˜ì…: 12G(ìŠ¹) / 5G(íŒ¨) + ìŠ¤í…Œì´ì§€ ë³´ë„ˆìŠ¤<br>
  ë¦¬ë¡¤: 2G Â· íŒë§¤: êµ¬ë§¤ê°€ì˜ ì ˆë°˜ Â· í•©ì„±: ì¬ë£Œ ê° 1ê°œ + ê³¨ë“œ
  </div></div>

  <div class="helpSection"><div class="hs">ğŸ‘‘ ë§ˆì™• ì„±ì¥ ì‹œìŠ¤í…œ (v8.2)</div><div class="hd">
  ë§¤ ìŠ¤í…Œì´ì§€ ì¢…ë£Œ í›„ 3ê°œ ì—…ê·¸ë ˆì´ë“œ ì¤‘ 1ê°œë¥¼ ì„ íƒ!<br><br>
  <b>6ê°œ ì¹´í…Œê³ ë¦¬:</b><br>
  <b>ğŸ—¡ ì „íˆ¬</b>: ëª¹ HP/ê³µê²© ìˆ˜ì¹˜ Â· í¡í˜ˆ Â· ê´‘ì „ì‚¬(HPì ˆë°˜â†“â†’ê³µê²©â†‘) Â· ê°€ì‹œê°‘ì˜· Â· ë…ë¬´ê¸° Â· í¬ë¦¬í‹°ì»¬<br>
  <b>ğŸ§¬ ë³€ì´</b>: ëª¹ ì‚¬ë§ ë¶„ì—´ Â· ì—˜ë¦¬íŠ¸ ê±°ëŒ€í™”+ê°ì†ë©´ì—­ Â· êµ°ì¤‘ê²°ì§‘ Â· ì¬ìƒë ¥ Â· ë¶€í™œ í™•ë¥ <br>
  <b>âš™ ë©”ì»¤ë‹‰</b>: ìŠ¤í° ì†ë„/ë‚´êµ¬ Â· ì´ì¤‘ì†Œí™˜ Â· í•¨ì • ê°•í™” Â· ìµœëŒ€ ëª¹ìˆ˜ ì¦ê°€<br>
  <b>ğŸ”® ë§ˆì™• ìŠ¤í‚¬</b>: ì—ë„ˆì§€ ì¦í­ Â· ì¿¨ê° Â· ë©”í…Œì˜¤ ê°•í™” Â· ì €ì£¼ ê°•í™”<br>
  <b>ğŸ’° ê²½ì œ</b>: ë¹„ìƒê¸ˆ Â· ì´ì(ë³´ìœ ê¸ˆ 10%) Â· ìƒì  í• ì¸ Â· ìš©ì‚¬ ì‚¬ë§ í˜„ìƒê¸ˆ<br>
  <b>ğŸ’€ ì €ì£¼(íŠ¸ë ˆì´ë“œì˜¤í”„)</b>: ìœ ë¦¬ëŒ€í¬(ê³µâ†‘HPâ†“) Â· ë¶ˆì•ˆì •(ìŠ¤í°â†‘ìŠ¤í¬ë„ˆHPâ†“) Â· í”¼ì˜ì œë¬¼ Â· í˜¼ëˆì˜ì¶•ë³µ<br><br>
  <b>3ë‹¨ê³„ í‹°ì–´</b>: <span style="color:var(--muted)">ì¼ë°˜</span> â†’ <span style="color:var(--blue)">í¬ê·€</span> â†’ <span style="color:var(--purple)">ì „ì„¤</span> (ìŠ¤í…Œì´ì§€ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë†’ì€ í‹°ì–´ ë“±ì¥ í™•ë¥ â†‘)<br>
  â€¢ íŒ¨ì‹œë¸ŒëŠ” ì¤‘ì²© ê°€ëŠ¥ (í¡í˜ˆÃ—2 = 30% íšŒë³µ ë“±)
  </div></div>

  <div class="helpSection"><div class="hs">âŒ¨ï¸ ë‹¨ì¶•í‚¤</div><div class="hd">
  Ctrl+Z: ì—ë””í„° ì–¸ë‘ Â· Ctrl+X: ì—ë””í„° ë¦¬ë‘
  </div></div>
  `;
}
buildHelpContent();

/* ========== MAIN LOOP ========== */
let lastT=now();
function raf(){
  const t=now();let dt=Math.min((t-lastT)/1000,.05);lastT=t;
  drawEditorCanvas();
  drawPrepCanvas();
  if(game){
    tick(game,dt);drawPlay(game);hudUpdate(game);
  }
  requestAnimationFrame(raf);
}
requestAnimationFrame(raf);

/* ========== INIT ========== */
drawEditorCanvas();
refreshAllUI();
buildVillainCards();
buildDirectiveUI();

</script>
</body>
</html>
